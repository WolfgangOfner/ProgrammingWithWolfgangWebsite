---
title: Update DNS Records in an Azure DevOps Pipeline
date: 2021-10-11
author: Wolfgang Ofner
categories: [DevOps, Cloud]
tags: [DevOps, Azure, YAML, AKS, Kubernetes, Monitoring, Prometheus, Grafana, KEDA, Azure DevOps]
description: Azure DevOps Infrastructure as Code (IaC) pipelines can be used to automatically update or create DNS records in Azure DNS Zones.
---

Infrastructure as Code (IaC) is a great process to manage the creation of your infrastructure. [In an earlier post](/use-infrastructure-as-code-to-deploy-infrastructure), I have created such a pipeline using Azure CLI to create all my resources in Azure. This pipeline creates an AKS cluster and all necessary services like a database server, Azure Function, and Azure Service Bus Queue.

The only part missing was an update to my DNS service to point my domain to the newly created AKS cluster.

This post is part of ["Microservice Series - From Zero to Hero"](/microservice-series-from-zero-to-hero).

## Prepare Azure DevOps to update DNS Settings

You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo/blob/master/Infrastructure/AzureResources/Azure-resource-install-pipeline.yml" target="_blank" rel="noopener noreferrer">Github</a>.

If you are using an Azure DNS Zone, you usually don't have to prepare anything in your Azure DevOps environment. I am using a lock on my DNS Zone though. A lock can be used to prevent changes or deletion. Since the DNS Zone manages my DNS entries for my website, mail server, and demos, it is important to not change and especially delete them.

The problem with the lock is that the Azure DevOps service principal that runs the Azure DevOps pipeline, has the Contributor role. This role is not allowed to create or delete locks. Therefore, I have created a new custom role and added this role to the service principal. You can read about it in my last post, [Create Custom Roles for Azure DevOps in Azure](/create-custom-roles-for-azure-devops-in-azure).

## Update DNS Records in the Azure DevOps Pipeline

As always, I start by defining some variables at the top of the pipeline.

<script src="https://gist.github.com/WolfgangOfner/3f4b3cd36008fc84a2b2de06e1316e70.js"></script>

These variables contain the information about my DNS Zone and also a list of records that I want to update.

The first step of my pipeline is to remove the lock on the DNS Zone. You can skip this step if you do not have a lock. The code gets the id of the name with the provided name and then uses this id to delete the lock.

<script src="https://gist.github.com/WolfgangOfner/34189ad12873fee1344a732307a78609.js"></script>

Next, you have to query the name of the public IP address of your AKS cluster. This name then can be used to get the IP address of the Nginx ingress controller running inside the Kubernetes cluster. The resource group of the aks cluster is automatically generated by Azure using the MC_prefix and then adding your resource group name in which your AKS cluster resides, the AKS cluster name, and the location of the cluster.
Write-Host can be used to make the variable accessible outside of the task. 

<script src="https://gist.github.com/WolfgangOfner/d27336b68ac4cf2cf5b5e5968575f0e0.js"></script>

Unfortunately, at this time it is not possible to update DNS records in Azure using Azure CLI. Therefore, you have first have to delete the existing records and then add new ones. To delete all outdated DNS records, iterate over the previously created list of DNS records. Additionally, you have to first get the IP address of each DNS record to be able to delete it. If the IP address is empty or null, nothing will happen.

<script src="https://gist.github.com/WolfgangOfner/6e2cbb4776ea9a0fef934b9adc73abb1.js"></script>

After all outdated DNS records are deleted, iterate over your DNS records list again and add them to the DNS Zone. The used IP address is the one published using Write-Host in a previous task.

<script src="https://gist.github.com/WolfgangOfner/07c1eb3ce0645457cf8b3646c2684957.js"></script>

Optionally, create a new CanNotDelete lock for the Azure DNS Zone to protect it from deletion.

<script src="https://gist.github.com/WolfgangOfner/2d3ba56efb8186b2bd87f43338994610.js"></script>

## Testing the IaC Pipeline

Start the pipeline and it should run successfully.

<div class="col-12 col-sm-10 aligncenter">
  <a href="/assets/img/posts/2021/10/The-Pipeline-ran-successfully.jpg"><img loading="lazy" src="/assets/img/posts/2021/10/The-Pipeline-ran-successfully.jpg" alt="The Pipeline ran successfully" /></a>
  
  <p>
   The Pipeline ran successfully
  </p>
</div>

After the pipeline is finished, check if your DNS records were updated. First, go to your AKS cluster in the Azure portal and select the Service and Ingress pane. There you can see the external URL of the Nginx controller. 

<div class="col-12 col-sm-10 aligncenter">
  <a href="/assets/img/posts/2021/10/Check-the-external-IP-of-the-Nginx-Controller.jpg"><img loading="lazy" src="/assets/img/posts/2021/10/Check-the-external-IP-of-the-Nginx-Controller.jpg" alt="Check the external IP of the Nginx Controller" /></a>
  
  <p>
   Check the external IP of the Nginx Controller
  </p>
</div>

Go to your Azure DNS Zone and you should see that the URLs of your records are the same as the Nginx controller external IP.

<div class="col-12 col-sm-10 aligncenter">
  <a href="/assets/img/posts/2021/10/The-DNS-records-were-updated.jpg"><img loading="lazy" src="/assets/img/posts/2021/10/The DNS records were updated.jpg" alt="The-DNS-records-were-updated" /></a>
  
  <p>
   The DNS records were updated
  </p>
</div>

## Conclusion

Updating DNS records in an Azure DevOps pipeline is a simple and fast way to react to changes in your infrastructure. Unfortunately, it is not possible to update existing records but this post showed how to delete and re-create your DNS records.

You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo/blob/master/Infrastructure/AzureResources/Azure-resource-install-pipeline.yml" target="_blank" rel="noopener noreferrer">Github</a>.

This post is part of ["Microservice Series - From Zero to Hero"](/microservice-series-from-zero-to-hero).