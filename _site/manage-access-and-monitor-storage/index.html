<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Manage access and monitor storage" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="Azure Storage has a built-in analytics feature called Azure Storage Analytics used for collecting metrics and logging storage request activity. In this post, I will talk about different methods to manage the access and monitor storage accounts." /><meta property="og:description" content="Azure Storage has a built-in analytics feature called Azure Storage Analytics used for collecting metrics and logging storage request activity. In this post, I will talk about different methods to manage the access and monitor storage accounts." /><link rel="canonical" href="/manage-access-and-monitor-storage/" /><meta property="og:url" content="/manage-access-and-monitor-storage/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-04-18T09:54:09+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Manage access and monitor storage" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2018-04-18T09:54:09+02:00","datePublished":"2018-04-18T09:54:09+02:00","description":"Azure Storage has a built-in analytics feature called Azure Storage Analytics used for collecting metrics and logging storage request activity. In this post, I will talk about different methods to manage the access and monitor storage accounts.","headline":"Manage access and monitor storage","mainEntityOfPage":{"@type":"WebPage","@id":"/manage-access-and-monitor-storage/"},"url":"/manage-access-and-monitor-storage/"}</script><title>Manage access and monitor storage | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "hc0wl2v6mn"); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/youtube/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>YOUTUBE</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Manage access and monitor storage</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Manage access and monitor storage</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1524038049" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 18, 2018 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2160 words"> <em>25 min</em></span> read</div></div><div class="post-content"><p>Azure Storage has a built-in analytics feature called Azure Storage Analytics used for collecting metrics and logging storage request activity. Storage Analytics Metrics are used to collect aggregate transaction and capacity. Storage Analytics Logging is used to capture successful and failed request attempts to your storage account. In this post, I will talk about different methods to manage the access and monitor storage accounts.</p><h2 id="generate-shared-access-signatures"><span class="mr-2">Generate Shared Access Signatures</span><a href="#generate-shared-access-signatures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>By default, storage resources are protected at the service level. Only authenticated callers can access tables and queues. Blob containers and blobs can optionally be exposed for anonymous access, but you would typically allow anonymous access only to individual blobs. To authenticate to a storage service, a primary or secondary key is used, but this grants the caller access to all actions on the storage account.</p><p>A shared access signature (SAS) is used to delegate access to specific account resources without enabling access to the entire account. An SAS token lets you control the lifetime by setting the start and expiration time of the signature, the resources you are granting access to, and the permissions being granted.</p><p>The following operations are supported by SAS:</p><ul><li>Reading or writing blobs, blob properties, and blob metadata<li>Deleting blobs<li>Listing blobs in a container<li>Adding, updating, or deleting table entities<li>Querying tables<li>Adding and updating queue messages<li>Processing queue messages</ul><p>The SAS token should be stored in the Azure Key Vault.</p><h3 id="creating-an-sas-token-with-c"><span class="mr-2">Creating an SAS token with C#</span><a href="#creating-an-sas-token-with-c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can find the following code demo on <a href="https://github.com/WolfgangOfner/Azure-CreateSASToken" target="_blank" rel="noopener noreferrer">GitHub</a>. To learn how to create a container, queue and table see<span style="color: #ff0000;"> </span><a href="/implement-azure-storage-blobs-and-azure-files/" target="_blank" rel="noopener noreferrer">Implement Azure Storage blobs and Azure files</a> and <a href="/implement-azure-storage-tables-queues-and-azure-cosmos-db-table-api/" target="_blank" rel="noopener noreferrer">Implement Azure Storage Tables, Queues, and Azure Cosmos DB Table API</a>.</p><p>The following code creates an SAS token for a blob container with a start time and expiration time. Before you start, install the WindowsAzure.Storage NuGet package.</p><p>Add the following code to your App.config file and replace the placeholder with your account name and</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Add-the-connection-string-to-your-storage-account-to-the-App.config-file.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Add-the-connection-string-to-your-storage-account-to-the-App.config-file.jpg" alt="Add the connection string to your storage account to the App.config file" data-proofer-ignore></a><p> Add the connection string to your storage account to the App.config file</p></div><p>Use the following code to create an SAS token for your blob with read, write, delete and list rights. The token will expire in one hour.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-blob.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-blob.jpg" alt="Create an SAS token for a blob" data-proofer-ignore></a><p> Create an SAS token for a blob</p></div><p>With the SAS token, you can access your container.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Access-the-blob-container-with-the-SAS-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Access-the-blob-container-with-the-SAS-token.jpg" alt="Access the blob container with the SAS token" data-proofer-ignore></a><p> Access the blob container with the SAS token</p></div><p>Use the following code to create an SAS token for your queue with read, add, update and processMessages rights. The token will expire in one hour.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-queue.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-queue.jpg" alt="Create an SAS token for a queue" data-proofer-ignore></a><p> Create an SAS token for a queue</p></div><p>With the following code, you can access your queue and add a new message.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Access-the-queue-with-the-SAS-token-and-add-a-new-message.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Access-the-queue-with-the-SAS-token-and-add-a-new-message.jpg" alt="Access the queue with the SAS token and add a new message" data-proofer-ignore></a><p> Access the queue with the SAS token and add a new message</p></div><p>Use the following code to create an SAS token for your table with query, add, update and delete rights. The token will expire in one hour.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-table.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Create-an-SAS-token-for-a-table.jpg" alt="Create an SAS token for a table" data-proofer-ignore></a><p> Create an SAS token for a table</p></div><p>With the SAS token, you can access your table.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Access-the-table-with-the-SAS-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Access-the-table-with-the-SAS-token.jpg" alt="Access the table with the SAS token" data-proofer-ignore></a><p> Access the table with the SAS token</p></div><h3 id="creating-an-sas-token-in-the-azure-portal"><span class="mr-2">Creating an SAS token in the Azure Portal</span><a href="#creating-an-sas-token-in-the-azure-portal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Additionally, to creating the SAS token in your code, you can create it in the Azure Portal. To do that follow these steps:</p><ol><li>In your storage account select the Shared access signature blade under the Settings menu.<li>Select the following attributes:<ul><li>allowed services, resource types, and permissions<li>start and expiry date and time<li>optionally the allowed IP addresses<li>allowed protocols<li>signing key</ul><li>After you set your desired attributes, click on Generate SAS and connection string.<li>Below the button can you find the SAS token and the URLs to your resources.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Create-an-SAS-token-in-the-Azure-Portal.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Create-an-SAS-token-in-the-Azure-Portal.jpg" alt="Create an SAS token in the Azure Portal to Monitor storage" data-proofer-ignore></a><p> Create an SAS token in the Azure Portal</p></div><h3 id="renewing-an-sas-token"><span class="mr-2">Renewing an SAS token</span><a href="#renewing-an-sas-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can extend access to the same application or user by using new SAS tokens on requests. This should be done with appropriate authentication and authorization in place.</p><h3 id="validating-data"><span class="mr-2">Validating data</span><a href="#validating-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When you give write access to storage resources with SAS, the contents of those resources can be made corrupt or be tampered with by a malicious party. Be sure to validate system use of all resources exposed with SAS keys.</p><h2 id="create-stored-access-policies"><span class="mr-2">Create stored access policies</span><a href="#create-stored-access-policies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Stored access policies provide greater control over how you grant access to storage resources using SAS tokens. With a stored access policy, you can do the following after releasing an SAS token for resource access:</p><ul><li>Control permissions for the signature<li>Change the start and end time for a signature’s validity<li>Revoke access</ul><p>The stored access policy can be sued to control all issued SAS tokens that are based on the policy. It is best practice to use stored access policies wherever possible, or at least limit the lifetime of SAS tokens to avoid malicious use.</p><h3 id="create-and-test-stored-access-policies-programmatically"><span class="mr-2">Create and test stored access policies programmatically</span><a href="#create-and-test-stored-access-policies-programmatically" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can create SAS tokens and stored access policies programmatically with C#. I added two C# console applications to my GitHub account. The first application sets everything up and the test client tests the access with the SAS tokens.</p><p>Note that the test client won’t be able to delete blobs or container because stored access policy has only read and write rights.</p><p>Before you can start, you have to replace YourAccountName and YourAccessKey in the app.config with the name and access key of your storage account. Then you can run the first application and copy the output for the variables needed in the test client. Then you can run the test client and see the result.</p><p>You can find the application to create the stored access policies <a href="https://github.com/WolfgangOfner/Azure-CreateStoredAccessPolicy" target="_blank" rel="noopener noreferrer">here</a> and the test client <a href="https://github.com/WolfgangOfner/Azure-StoredAccessPolicyTestClient" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 id="regenerate-account-keys"><span class="mr-2">Regenerate account keys</span><a href="#regenerate-account-keys" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When you create a storage account, two 512 bit storage access keys are generated which are used for authentication to the storage account. Since there are two keys, it is possible to regenerate them without impacting the access to storage of your applications.</p><p>To regenerate your keys without interrupting the access of your applications, follow this strategy:</p><ol><li>Change your application configurations to use the secondary key.<li>Regenerate the first key.<li>Change your application configurations to use the primary key.<li>Regenerate the second key.</ol><p>To regenerate your storage account keys, follow these steps:</p><ol><li>In the Azure Portal, select your storage account and click on Access keys under the Settings menu.<li>Click on the Regenerate button of the key you want to regenerate.<li>Click on Yes in the confirmation dialog.<li>Your key is regenerated.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Regenerate-the-primary-key.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Regenerate-the-primary-key.jpg" alt="Regenerate the primary key" data-proofer-ignore></a><p> Regenerate the primary key</p></div><p>The keys should be stored in the Azure Key Vault.</p><h2 id="configure-and-use-cross-origin-resource-sharing"><span class="mr-2">Configure and use Cross-Origin Resource Sharing</span><a href="#configure-and-use-cross-origin-resource-sharing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Cross-Origin Resource Sharing (CORS) enables web applications running in the browser to call web APIs that are hosted by a different domain. By default CORS is disabled, but you can enable it for a specific storage service. To enable CORS for blobs, follow these steps:</p><ol><li>In the Azure Portal, select your storage account and click on CORS under the Blob Service menu. (There is a CORS blade for every resource type. If you want to add a CORS rule for your queue, select the CORS blade under the Queue Service menu)<li>Click on +Add at the top of the blade.<li>On the Add CORS rule blade, enter your configuration</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Add-a-new-CORS-rule-to-your-blob.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Add-a-new-CORS-rule-to-your-blob.jpg" alt="Add a new CORS rule to your blob" data-proofer-ignore></a><p> Add a new CORS rule to your blob</p></div><ol start="4"><li> On the screenshot above, you can see the allow origins are allowed by using *, only HTTP GET requests are allowed, allowed headers and exposed headers are all allowed and no maximum age for the request is defined.<li> After you entered your settings, click on Add.</ol><h2 id="configure-and-monitor-metrics"><span class="mr-2">Configure and Monitor metrics</span><a href="#configure-and-monitor-metrics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Storage Analytics metrics provide insight into transactions and capacity for your storage accounts. By default, the storage metrics are not enabled. You can enable them using the Azure Portal or PowerShell.</p><p>When you configure storage metrics for a storage account, tables are generated to store the output of the metrics collection. You set the level of metrics collection for transactions and the retention level for each service (blob, table, queue). Additionally, you can set the interval for the metric collection (hourly or by minute).</p><p>There are two levels of metrics collection:</p><div class="table-responsive"><div class="table-wrapper"><table class="table table-striped table-bordered table-hover"><tr><td> Metric collection level<td> Description<tr><td> Service level<td> The metrics include aggregate statistics for all requests, aggregated at the specified interval. If no requests are made, an aggregate entry is still created for the interval, indicating no requests for that period.<tr><td> API level<td> These metrics record every request to each service and only if a request is made within the interval.</table></div></div><p>By default, Storage Analytics will not delete any metrics data. When the shared 20 TB limit is reached, no new data can be written until space is freed. You can specify a retention period from 0 to 365 days. Metrics data is automatically deleted when the retention period is reached for the entry.</p><h3 id="configure-storage-metrics-and-retention"><span class="mr-2">Configure storage metrics and retention</span><a href="#configure-storage-metrics-and-retention" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To configure storage metrics and retention for Blob, Table, and Queue services, follow these steps:</p><ol><li>In the Azure portal, go to your storage account and select Diagnostics under the Monitoring menu.<li>On the Diagnostics blade, click On under the Status property to enable the options for metrics and logging.<li>You can set different settings for each storage type by switching between the tabs beneath the Status slider.<li>Set your desired settings and set a value for retention by moving the slider or entering a number between 0 and 365.<li>Click Save.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Configure-your-storage-metrics-and-retention.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Configure-your-storage-metrics-and-retention.jpg" alt="Configure your storage metrics and retention" data-proofer-ignore></a><p> Configure your storage metrics and retention</p></div><h3 id="analyze-storage-metrics"><span class="mr-2">Analyze storage metrics</span><a href="#analyze-storage-metrics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Storage Analytics metrics are collected. You can access the tables directly in the Azure portal to analyze and review the metrics. In the next sections, I will talk about different ways to access, review and analyze these metrics.</p><h3 id="monitor-storage-metrics"><span class="mr-2">Monitor storage metrics</span><a href="#monitor-storage-metrics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The available metrics in the Azure portal include total requests, total egress, average latency, and availability.</p><p>To monitor metrics, follow these steps:</p><ol><li>In the Azure portal, go to your storage account and select Metrics under the Blob, File, Table or Queue Service menu.<li>On the metrics blade, you can see graphs for the previously mentioned metrics.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/Metric-graphs.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/Metric-graphs.jpg" alt="Metric graphs" data-proofer-ignore></a><p> Metric graphs</p></div><ol start="3"><li> Click on a graph to see additional details and to modify it.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2018/04/View-the-details-of-a-metric-and-modify-the-graph.jpg"><img loading="lazy" data-src="/assets/img/posts/2018/04/View-the-details-of-a-metric-and-modify-the-graph.jpg" alt="View the details of a metric and modify the graph" data-proofer-ignore></a><p> View the details of a metric and modify the graph</p></div><h3 id="configure-storage-analytics-logging"><span class="mr-2">Configure Storage Analytics Logging</span><a href="#configure-storage-analytics-logging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Storage Analytics Logging provides details about successful and failed requests to each storage service. By default, storage logging is not enabled, but you can enable it using the management portal, PowerShell or by calling the management API directly.</p><p>When you configure Storage Analytics Logging for a storage account, a blob named $logs is automatically created to store the output of the logs. You can log any or all of the Blob, Table, or Queue service logs are created only for those services that have activity, so you will not be charged if you enable logging for a service that has no request. The logs are stored as block blobs as requests are logged and are periodically committed so that they are available as blobs.</p><p>After you enabled Storage Analytics, the log container cannot be deleted. However, the contents of the log container can be deleted.</p><p>Duplicate log entries may be present within the same hour. You can use the RequestId and operation number to uniquely identify an entry to filter duplicates.</p><h2 id="analyze-logs"><span class="mr-2">Analyze logs</span><a href="#analyze-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Logs are stored as block blobs in delimited text format. You can download logs for review and analysis using any tool compatible with that format. Within the logs, you will find entries for authenticated and anonymous requests.</p><p>Logs include status messages and operation logs.</p><h3 id="finding-your-logs"><span class="mr-2">Finding your logs</span><a href="#finding-your-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When storage logging is configured, log data is saved to blobs in the $logs container created for your storage account. You can’t see this container by listing containers, but you can navigate directly to the container to access, view, or download the logs.</p><p>To navigate to the $logs container, use a link following this convention: https://<accountname>.blob.core.windows.net/$logs</accountname></p><h3 id="view-logs-with-excel"><span class="mr-2">View logs with Excel</span><a href="#view-logs-with-excel" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To view logs in Excel, follow these steps:</p><ol><li>Open Excel, and on the Data menu, click From Text.<li>Find the log file and click Import.<li>During the import, select Delimited format, Semicolon as the only delimiter, and Double-Quote(“) as the text qualifier.</ol><p>After you loaded your logs into Excel, you can analyze and gather information such as:</p><ul><li>Number of requests from a specific IP range<li>Which tables or containers are being accessed and the frequency of those requests<li>Slow requests<li>How many times a particular blob is being accessed with an SAS URL<li>Details to assist in investigating network errors</ul><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this post, I talked about creating an SAS token to give access with specific permissions to users and how stored access policies can be created with these tokens. Then, I explained how to regenerate the keys of your storage account and how to enable CORS.</p><p>In the second part, I talked about how to enable monitoring and logging for your storage account and how to view and analyze these logs in the Azure portal and with Excel.</p><p>For more information about the 70-532 exam get the <a href="http://amzn.to/2EWNWMF" target="_blank" rel="noopener noreferrer">Exam Ref book from Microsoft</a> and continue reading my blog posts. I am covering all topics needed to pass the exam. You can find an overview of all posts related to the 70-532 exam <a href="/prepared-for-the-70-532-exam/" target="_blank" rel="noopener noreferrer">here</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/70-532/" class="post-tag no-text-decoration" >70-532</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/certification/" class="post-tag no-text-decoration" >Certification</a> <a href="/tags/exam/" class="post-tag no-text-decoration" >Exam</a> <a href="/tags/learning/" class="post-tag no-text-decoration" >Learning</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Manage+access+and+monitor+storage+-+Programming+With+Wolfgang&url=%2Fmanage-access-and-monitor-storage%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Manage+access+and+monitor+storage+-+Programming+With+Wolfgang&u=%2Fmanage-access-and-monitor-storage%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Manage+access+and+monitor+storage+-+Programming+With+Wolfgang&url=%2Fmanage-access-and-monitor-storage%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fmanage-access-and-monitor-storage%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/video/">Video</a> <a class="post-tag" href="/tags/youtube/">Youtube</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/prepared-for-the-70-532-exam/"><div class="card-body"> <em class="small" data-ts="1519392828" data-df="ll" > Feb 23, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How I prepared for the 70-532 Exam</h3><div class="text-muted small"><p> Recently I started to prepare for the Microsoft certification exam 70-532 “Developing Microsoft Azure Solutions” using the official Exam Ref book. This post contains a comprehensive list of blog po...</p></div></div></a></div><div class="card"> <a href="/deploy-workload-on-azure-arm-virtual-machines/"><div class="card-body"> <em class="small" data-ts="1520255937" data-df="ll" > Mar 5, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploy workload on Azure ARM virtual machines</h3><div class="text-muted small"><p> Azure ARM virtual machines can run a lot of different operating systems. In this posts, I will give an overview of these different types and I will also show how to create them in the Azure Portal....</p></div></div></a></div><div class="card"> <a href="/perform-configuration-management/"><div class="card-body"> <em class="small" data-ts="1520335271" data-df="ll" > Mar 6, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Perform Configuration Management</h3><div class="text-muted small"><p> In this post, I want to show how to use Windows PowerShell Desired State Configuration (DSC) and the VM Agent to perform various configuration management tasks like remote debugging and at the end,...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/implement-azure-storage-tables-queues-and-azure-cosmos-db-table-api/" class="btn btn-outline-primary" prompt="Older"><p>Implement Azure Storage Tables, Queues, and Azure Cosmos DB Table API</p></a> <a href="/implement-azure-sql-database/" class="btn btn-outline-primary" prompt="Newer"><p>Implement Azure SQL database</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/manage-access-and-monitor-storage/'; this.page.identifier = '/manage-access-and-monitor-storage/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/video/">Video</a> <a class="post-tag" href="/tags/youtube/">Youtube</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
