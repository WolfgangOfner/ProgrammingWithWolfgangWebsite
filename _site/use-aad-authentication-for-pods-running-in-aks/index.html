<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Use AAD Authentication for Pods running in AKS" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="AAD Pod Identity allows you to authenticate your applications inside an AKS cluster without a password against Azure Active Directory." /><meta property="og:description" content="AAD Pod Identity allows you to authenticate your applications inside an AKS cluster without a password against Azure Active Directory." /><link rel="canonical" href="/use-aad-authentication-for-pods-running-in-aks/" /><meta property="og:url" content="/use-aad-authentication-for-pods-running-in-aks/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-25T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Use AAD Authentication for Pods running in AKS" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2021-10-25T00:00:00+02:00","datePublished":"2021-10-25T00:00:00+02:00","description":"AAD Pod Identity allows you to authenticate your applications inside an AKS cluster without a password against Azure Active Directory.","headline":"Use AAD Authentication for Pods running in AKS","mainEntityOfPage":{"@type":"WebPage","@id":"/use-aad-authentication-for-pods-running-in-aks/"},"url":"/use-aad-authentication-for-pods-running-in-aks/"}</script><title>Use AAD Authentication for Pods running in AKS | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "hc0wl2v6mn"); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/youtube/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>YOUTUBE</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Use AAD Authentication for Pods running in AKS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Use AAD Authentication for Pods running in AKS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1635112800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 25, 2021 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1430 words"> <em>16 min</em></span> read</div></div><div class="post-content"><p>Since the dawn of time, authentication has been a problem for developers and security engineers. Weak passwords make it easy for attackers to get access to areas where they don’t belong. Even if you have a very long and complex password, you might be at risk. Passwords get leaked almost every day nowadays. The current recommendation for authentication is passwordless. This means that no password exists anymore and you authenticate with an authenticator app or a security key.</p><p>This approach is safe but not possible for applications. This is where Azure Active Directory authentication comes into play. Resources in Azure can authenticate using their identity and then get an access token from AAD. Using these identities is quite easy with standard resources like App Service or Key Vault but not as easy when using Kubernetes.</p><p>Today, I would like to show you how you can configure your Azure Kubernetes Service cluster to use AAD Pod Identity to authenticate against the AAD.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="what-are-managed-identities"><span class="mr-2">What are Managed Identities</span><a href="#what-are-managed-identities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Every application faces the same challenges when it comes to securing its credentials. Managed identities eliminate the need for credentials and help to make applications more secure at the same time. Since there are no passwords with managed identities, no password can be compromised which could give unauthorized people access to resources.</p><p>Managed identities can be used to access a database or an Azure Key Vault where the application can load all required credentials for resources that do not support managed identities yet. Additionally, managed identities can be used without any additional costs. There are two types of managed identities, system-assigned and user-assigned.</p><h3 id="system-assigned-managed-identity"><span class="mr-2">System-Assigned Managed Identity</span><a href="#system-assigned-managed-identity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Some resources in Azure like App Service or Azure Container Registry allow you to enable a managed identity directly on that service. This identity is created in the Azure AD and shares the same lifecycle as the service instance. When you delete the service, the system-assigned managed identity will be also deleted.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/System-assigned-managed-identity-in-ACR.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/System-assigned-managed-identity-in-ACR.jpg" alt="System assigned managed identity in ACR" data-proofer-ignore></a><p> System assigned managed identity in ACR</p></div><h3 id="user-assigned-managed-identity"><span class="mr-2">User-Assigned Managed Identity</span><a href="#user-assigned-managed-identity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A user-assigned managed identity is a standalone resource in Azure. It can be assigned the resource and can be used in the same way as the system-assigned managed identity to authenticate that resource. The user-assigned managed identity has an independent lifecycle. This means that you can delete the Azure resource to which the identity is assigned and the identity does not get deleted.</p><h2 id="enable-managed-identities-for-applications-running-in-azure-kubernetes-service-aks"><span class="mr-2">Enable Managed Identities for Applications running in Azure Kubernetes Service (AKS)</span><a href="#enable-managed-identities-for-applications-running-in-azure-kubernetes-service-aks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Enabling managed identities for applications in AKS, so-called pod identities, is unfortunately not straightforward. There are different documentation but neither of them works reliably. You can find a demo integration on <a href="https://azure.github.io/aad-pod-identity/docs/demo/standard_walkthrough/" target="_blank" rel="noopener noreferrer">GitHub</a> but the documentation is missing some steps and the scripts did not work for me (mostly due to wrong file paths).</p><p>Follow this guide to install pod identity on your AKS cluster and then test it with a demo application. Afterwards, I will go into the details of what is happening.</p><h3 id="set-up-your-aks-cluster-for-pod-identities"><span class="mr-2">Set up your AKS Cluster for Pod Identities</span><a href="#set-up-your-aks-cluster-for-pod-identities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For this tutorial, I will assume that you have no AKS cluster created yet. This demo uses the Azure CLI and bash. Before you begin, create a couple of variables, which you can use throughout this demo. Note to replace the value of SubscriptionId with the Id of your Azure Subscription.</p><script src="https://gist.github.com/WolfgangOfner/6d8c0345231d7214627bda6f9ca7a47d.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/Set-some-variables.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/Set-some-variables.jpg" alt="Set some variables" data-proofer-ignore></a><p> Set some variables</p></div><p>Next, create an AKS cluster with a managed identity and the azure network plugin.</p><script src="https://gist.github.com/WolfgangOfner/343c7136a87781e143047553c51f096d.js"></script><p>After the AKS cluster is created, retrieve the client Id of the managed identity of the cluster. Then use this client Id to assign the Managed Identity Operator and Virtual Machine Contributor roles to the managed identity.</p><script src="https://gist.github.com/WolfgangOfner/23bff74abc3a525743af89dbade2a6cf.js"></script><p>This finishes the setup of the AKS cluster. Connect to your newly created cluster and let’s continue to configure the pod identity.</p><script src="https://gist.github.com/WolfgangOfner/e66a01e046a431e84b69d88eb1583eab.js"></script><h3 id="configure-pod-identity-in-azure-kubernetes-service"><span class="mr-2">Configure Pod Identity in Azure Kubernetes Service</span><a href="#configure-pod-identity-in-azure-kubernetes-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Install the AAD Pod Identity Helm chart using Helm. If you do not know Helm, see <a href="/helm-getting-started">Helm - Getting Started</a> for more information. Add and install the Helm chart with the following command:</p><script src="https://gist.github.com/WolfgangOfner/49ece58a8d86c5d3192eee38140435fa.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/The-AAD-Pod-Identity-Helm-Chart-was-installed-successfully.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/The-AAD-Pod-Identity-Helm-Chart-was-installed-successfully.jpg" alt="The AAD Pod Identity Helm Chart was installed successfully" data-proofer-ignore></a><p> The AAD Pod Identity Helm Chart was installed successfully</p></div><p>After the installation is finished, you will see a message to verify that all associated pods have been started. Use the following command to check that:</p><script src="https://gist.github.com/WolfgangOfner/670add38913779a79ed98e8f7da0ef2b.js"></script><p>This should show that all pods are running.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/All-AAD-Pod-Identity-Pods-are-running.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/All-AAD-Pod-Identity-Pods-are-running.jpg" alt="All AAD Pod Identity Pods are running" data-proofer-ignore></a><p> All AAD Pod Identity Pods are running</p></div><p>Next, create a new identity and export its client Id and Id:</p><script src="https://gist.github.com/WolfgangOfner/1485648644bc1b14dc16c5d1334fdca0.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/Create-a-new-Identity.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/Create-a-new-Identity.jpg" alt="Create a new Identity" data-proofer-ignore></a><p> Create a new Identity</p></div><p>With this identity, create a new Kubernetes object of the type AzureIdentity and add the identity Id and client Id to it.</p><script src="https://gist.github.com/WolfgangOfner/4324e4b5f79ebfb43397e764c773ee36.js"></script><p>Optionally, you could save the AzureIdentity in a file and then apply this file. If you are using this approach, you have to replace the variables with their actual values though.</p><p>The last step of the configuration of pod identities is to create an AzureIdentityBinding using the following command:</p><script src="https://gist.github.com/WolfgangOfner/f39c35333e027ea1ffcead10923f8b41.js"></script><h3 id="test-the-usage-of-the-pod-identity"><span class="mr-2">Test the usage of the Pod Identity</span><a href="#test-the-usage-of-the-pod-identity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Microsoft has a test application that will retrieve a token and give you a success message when the operation is completed. If something went wrong, you will see an error message. Deploy the test application with the following command:</p><script src="https://gist.github.com/WolfgangOfner/1cfc2a01a3c862228c572ff18b9a72f3.js"></script><p>Wait for around a minute and then check the logs of the pod. You can do this either using kubectl or a dashboard. Kubectl gives you a wall of text that might be hard to read.</p><script src="https://gist.github.com/WolfgangOfner/0d7e50b0757f5f1b61387efa3ce8e8d2.js"></script><p>I prefer Octant as my dashboard. You can find more information about the usage and installation in <a href="/azure-kubernetes-service-getting-started/#access-the-aks-cluster">Azure Kubernetes Service - Getting Started</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/The-token-was-retrieved-successfully.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/The-token-was-retrieved-successfully.jpg" alt="The token was retrieved successfully" data-proofer-ignore></a><p> The token was retrieved successfully</p></div><h2 id="what-happens-inside-kubernetes-when-adding-pod-identity"><span class="mr-2">What happens inside Kubernetes when adding Pod Identity</span><a href="#what-happens-inside-kubernetes-when-adding-pod-identity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There was a lot going on during the demo which might be hard to understand at first. Let’s go through it step by step.</p><h3 id="azure-kubernetes-service-cluster-installation"><span class="mr-2">Azure Kubernetes Service Cluster Installation</span><a href="#azure-kubernetes-service-cluster-installation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The AKS cluster is created with the flag –network-plugin azure. AKS supports two network modes, kubenet and azure, whereas kubenet is the default mode.</p><p>AAD Pod Identity is disabled by default on clusters using the Kubnet network mode. This is due to security concerns because Kubenet is susceptible to APR spoofing. This makes it possible for pods to impersonate other pods and gain access to resources that they are not allowed to access. The Azure network plugin prevents ARP Spoofing.</p><p>After the cluster is installed, the code creates a service principal. This service principal is used to authenticate against the AAD and retrieve tokens for the pods. Adding the Managed Identity Operator and Virtual Machine Contributor roles to the service principal is necessary so it can assign and un-assign identities from the worker nodes that run on the VM scale set.</p><h3 id="managed-identity-controller-mic-and-node-managed-identity-nmi"><span class="mr-2">Managed Identity Controller (MIC) and Node Managed Identity (NMI)</span><a href="#managed-identity-controller-mic-and-node-managed-identity-nmi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The Managed Identity Controller (MIC) monitors pods through the Kubernetes API Server. When the MIC detects any changes, it adds or deletes AzureAssignedIdentity if needed. Keep in mind that the identity is applied when a pod is scheduled. This means if you change your configuration, you have to re-schedule your pods for the changes to be applied.</p><p>The Node Managed Identity (NMI) intercepts traffic on all nodes and makes an Azure Active Directory Authentication Library (ADAL) request to get a token on behalf of the pods. The request to get a token is sent to the Azure Instance Metadata Service (IMDS) at 169.254.169.254. The answer is redirected to the NMI pod due to changes to the iptable rules of the nodes.</p><h3 id="azureidentity-and-azureidenditybinding"><span class="mr-2">AzureIdentity and AzureIdendityBinding</span><a href="#azureidentity-and-azureidenditybinding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AzureIdentity can be a user-assigned identity, service principal, or service principal with a certificate and is used to authenticate the requests from the NMI to get a token from the AAD.</p><p>The AzureIdendityBinding connects the AzureIdentity to a pod. The AzureIdentity is assigned to a pod if the selectors are matching.</p><p>The following screenshot shows the workflow of the token acquisition.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/10/Token-acquisation-workflow.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/10/Token-acquisation-workflow.jpg" alt="Token acquisation workflow" data-proofer-ignore></a><p> Token acquisation workflow (<a href="https://azure.github.io/aad-pod-identity/docs/concepts/block-diagram-and-design/" target="_blank" rel="noopener noreferrer">GitHub</a>)</p></div><h3 id="uninstalling-aad-pod-identity"><span class="mr-2">Uninstalling AAD Pod Identity</span><a href="#uninstalling-aad-pod-identity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can use the following code to uninstall pod identity.</p><script src="https://gist.github.com/WolfgangOfner/c83ed13c4ded845afd89b96450994e02.js"></script><p>The iptables that got modified by the NMI pods should be cleaned up automatically when the pod identity pods are uninstalled. If the pods get terminated unexpectedly, the entries in the iptables are not removed. You can do that with the following commands:</p><script src="https://gist.github.com/WolfgangOfner/785981aa2a0b865c36e0451b354ecfd0.js"></script><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Using AAD authentication in Azure Kubernetes Service is unfortunately not straightforward, especially since the documentation is missing some crucial information. Nevertheless, going passwordless is definitely worth the hassle and will make it easier to manage your applications in the future.</p><p><a href="/implement-aad-authentication-to-access-azure-sql-databases">In my next post</a>, I will show you how to use this AAD authentication to access your database without a password.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/aks/" class="post-tag no-text-decoration" >AKS</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/aad/" class="post-tag no-text-decoration" >AAD</a> <a href="/tags/helm/" class="post-tag no-text-decoration" >Helm</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Use+AAD+Authentication+for+Pods+running+in+AKS+-+Programming+With+Wolfgang&url=%2Fuse-aad-authentication-for-pods-running-in-aks%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Use+AAD+Authentication+for+Pods+running+in+AKS+-+Programming+With+Wolfgang&u=%2Fuse-aad-authentication-for-pods-running-in-aks%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Use+AAD+Authentication+for+Pods+running+in+AKS+-+Programming+With+Wolfgang&url=%2Fuse-aad-authentication-for-pods-running-in-aks%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fuse-aad-authentication-for-pods-running-in-aks%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/video/">Video</a> <a class="post-tag" href="/tags/youtube/">Youtube</a> <a class="post-tag" href="/tags/conference/">Conference</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <em class="small" data-ts="1610838000" data-df="ll" > Jan 17, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software architect on different projects that focus on microservices, DevOps, and Kubernetes. Many of my consulting jobs consist of explaining microservices, why th...</p></div></div></a></div><div class="card"> <a href="/configure-custom-urls-to-access-microservices-running-in-kubernetes/"><div class="card-body"> <em class="small" data-ts="1621202400" data-df="ll" > May 17, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configure custom URLs to access Microservices running in Kubernetes</h3><div class="text-muted small"><p> In my last post, I created an Nginx Ingress controller and added rules to route to my two microservices. This solution worked but it was far from optimal. First, I had to add routing rules for my m...</p></div></div></a></div><div class="card"> <a href="/automatically-issue-ssl-certificates-and-use-ssl-termination-in-kubernetes/"><div class="card-body"> <em class="small" data-ts="1622412000" data-df="ll" > May 31, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Automatically issue SSL Certificates and use SSL Termination in Kubernetes</h3><div class="text-muted small"><p> In my last post, I created an Nginx ingress controller and assigned different URLs to its public URL. The Nginx controller analyses the URL and routes the traffic automatically to the right applica...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/automatically-scale-your-aks-cluster/" class="btn btn-outline-primary" prompt="Older"><p>Automatically scale your AKS Cluster</p></a> <a href="/implement-aad-authentication-to-access-azure-sql-databases/" class="btn btn-outline-primary" prompt="Newer"><p>Implement AAD Authentication to access Azure SQL Databases</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/use-aad-authentication-for-pods-running-in-aks/'; this.page.identifier = '/use-aad-authentication-for-pods-running-in-aks/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/video/">Video</a> <a class="post-tag" href="/tags/youtube/">Youtube</a> <a class="post-tag" href="/tags/conference/">Conference</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
