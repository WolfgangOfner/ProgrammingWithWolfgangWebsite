<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Set up Nginx as Ingress Controller in Kubernetes" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Nginx can be used as an Ingress controller for Kubernetes clusters and offers a wide range of features like routing, SSL termination, and preventing direct access to the microservices." /><meta property="og:description" content="Nginx can be used as an Ingress controller for Kubernetes clusters and offers a wide range of features like routing, SSL termination, and preventing direct access to the microservices." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-10T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Set up Nginx as Ingress Controller in Kubernetes" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/","description":"Nginx can be used as an Ingress controller for Kubernetes clusters and offers a wide range of features like routing, SSL termination, and preventing direct access to the microservices.","@type":"BlogPosting","headline":"Set up Nginx as Ingress Controller in Kubernetes","dateModified":"2021-05-10T00:00:00+02:00","datePublished":"2021-05-10T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/"},"@context":"https://schema.org"}</script><title>Set up Nginx as Ingress Controller in Kubernetes | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Set up Nginx as Ingress Controller in Kubernetes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Set up Nginx as Ingress Controller in Kubernetes</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Set up Nginx as Ingress Controller in Kubernetes</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 10, 2021, 12:00 AM +0200" > May 10 <i class="unloaded">2021-05-10T00:00:00+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1187 words">13 min</span></div></div><div class="post-content"><p>So far I have used a Service with the type LoadBalancer for my microservices. The service can be set up quickly and also gets a public IP address assign to access the microservice. Besides the load balancing, it has no features though. Therefore, I will replace the Service object with an Nginx ingress controller.</p><p>Today, I will implement the ingress controller and set up some basic rules to route the traffic to my microservices. In the next post, I will add SSL termination and the automatic creation of SSL certificates.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="install-nginx-as-ingress-controller">Install Nginx as Ingress Controller</h2><p>The idea is to have an Nginx controller as the only entry point to my Kubernetes cluster. This controller will have a public IP address and route the traffic to the right microservices. Additionally, I will change the existing Service of the microservices to the type ClusterIP which removes the public IP address and makes them accessible only through the Nginx Ingress controller.</p><p>To install Nginx, I will use a Helm chart. If you don’t know Helm, see my posts <a href="/helm-getting-started">Helm - Getting Started</a> and <a href="/deploy-kubernetes-using-helm">Deploy to Kubernetes using Helm Charts</a>. First, create a new namespace that will contain the Nginx controller. This will help with future maintenance.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl create namespace ingress-basic
</pre></table></code></div></div><p>Next, add the Nginx Ingress Helm chart to your AKS cluster and then install it with the following code:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

helm <span class="nb">install </span>nginx-ingress ingress-nginx/ingress-nginx 
    <span class="nt">--namespace</span> ingress-basic <span class="se">\</span>
    <span class="nt">--set</span> controller.replicaCount<span class="o">=</span>2 <span class="se">\</span>
    <span class="nt">--set</span> controller.nodeSelector.<span class="s2">"beta</span><span class="se">\.</span><span class="s2">kubernetes</span><span class="se">\.</span><span class="s2">io/os"</span><span class="o">=</span>linux <span class="se">\</span>
    <span class="nt">--set</span> defaultBackend.nodeSelector.<span class="s2">"beta</span><span class="se">\.</span><span class="s2">kubernetes</span><span class="se">\.</span><span class="s2">io/os"</span><span class="o">=</span>linux <span class="se">\</span>
    <span class="nt">--set</span> controller.admissionWebhooks.patch.nodeSelector.<span class="s2">"beta</span><span class="se">\.</span><span class="s2">kubernetes</span><span class="se">\.</span><span class="s2">io/os"</span><span class="o">=</span>linux
</pre></table></code></div></div><p>For this demo, it is enough to have two replicas but for your production environment, you might want to use three or more. You can configure it with the –set controller.replicaCount=2 flag. The installation of the Nginx ingress might take a couple of minutes. Especially the assignment of a public IP might take a bit. You can check the status with the following code:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl <span class="nt">--namespace</span> ingress-basic get services <span class="nt">-o</span> wide <span class="nt">-w</span> nginx-ingress-ingress-nginx-controller
</pre></table></code></div></div><p>This command also gives you the public (External) IP address of the controller:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/Nginx-got-installed-with-a-public-IP.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/Nginx-got-installed-with-a-public-IP.jpg" alt="Nginx got installed with a public IP" /></a><p> Nginx got installed with a public IP</p></div><p>Open the public IP and your browser and you should get the Nginx 404 page.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/The-default-Nginx-404-page.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/The-default-Nginx-404-page.jpg" alt="The default Nginx 404 page" /></a><p> The default Nginx 404 page</p></div><h2 id="configure-the-microservices-to-use-a-clusterip-service">Configure the Microservices to use a ClusterIP Service</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>I have two existing microservices in my demo repo which both use a Service of the type LoadBalancer. Before you can use the Nginx Ingress controller, you have to change the Service type to ClusterIP. Since the microservices use Helm, you can easily override values using the values.yaml file. I prefer to have my overrides in the values.release.yaml file and therefore, I added the following code there:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">service</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
</pre></table></code></div></div><p>That is all that is needed for the Service. Next, you have to create an Ingress object for each microservice to tell Nginx where the traffic should be routed. You can find the Ingress object definition inside the Helm chart:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="pi">{{</span><span class="nv">- if .Values.ingress.enabled -</span><span class="pi">}}</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.ingress.namespace</span> <span class="pi">}}</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.ingress.namespace</span> <span class="pi">}}</span>
<span class="pi">{{</span><span class="nv">- with .Values.ingress.annotations</span> <span class="pi">}}</span>
  <span class="na">annotations</span><span class="pi">:</span>
<span class="pi">{{</span> <span class="nv">toYaml . | indent 4</span> <span class="pi">}}</span>
<span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>      
  <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.ingress.path</span> <span class="pi">}}</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.ingress.pathtype</span> <span class="pi">}}</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "customerapi.fullname" .</span> <span class="pi">}}</span>
            <span class="na">port</span><span class="pi">:</span> 
              <span class="na">number</span><span class="pi">:</span> <span class="m">80</span>
<span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
</pre></table></code></div></div><p>This might look complicated at first glance but it is a simple Nginx rule. It starts with an if condition which lets you control whether the Ingress object should be created. Then it sets some metadata like name and namespace and inside the rules, it defines the path and the port of the application. If you use Kubernetes 1.14 to 1.18, you have to use apiVersion: networking.k8s.io/v1beta1. I am using Kubernetes 1.19.9 and therefore can use the GA version of the API.</p><p>Lastly, add the values for the Ingress object to the values.release.yaml file:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">ingress</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">annotations</span><span class="pi">:</span> 
    <span class="s">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="s">nginx.ingress.kubernetes.io/use-regex</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span> 
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">__K8sNamespace__</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
</pre></table></code></div></div><p>The K8sNamespace variable is defined in the Azure DevOps pipeline and will be replaced when the Tokenizer task is executed. You can read more about it in <a href="/replace-helm-variables-tokenizer">Replace Helm Chart Variables in your CI/CD Pipeline with Tokenizer</a>.</p><p>Deploy the application, open the URL of the Nginx controller and you will see the Swagger UI of the microservice:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/The-Swagger-UI-of-the-microservice.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/The-Swagger-UI-of-the-microservice.jpg" alt="The Swagger UI of the microservice" /></a><p> The Swagger UI of the microservice</p></div><p>This works fine but when you try to deploy the second microservice, you will get the following error message: Error from server (BadRequest): error when creating “orderapi-ingress.yaml”: admission webhook “validate.nginx.ingress.kubernetes.io” denied the request: host “_” and path “/” is already defined in ingress customerapi-test/customerapi-test. If you have two rules with / as the path, Nginx won’t know which one to take and therefore the deployment fails.</p><h2 id="add-individual-paths-to-the-microservices">Add individual Paths to the Microservices</h2><p>The solution for this problem is to add different paths for each microservice. For example, for the CustomerApi, I use /customerapi-test/?(.<em>) and for the OrderApi /orderapi-test/?(.</em>). Additionally, you have to configure this path in the Startup class of each microservice with the following code inside the Configure method:</p><pre><code class="language-CSharp">app.UsePathBase("/customerapi-test");
</code></pre><p>The values.release.yaml file will contain the following code at the end:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="na">service</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  
<span class="na">ingress</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">annotations</span><span class="pi">:</span> 
    <span class="s">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="s">nginx.ingress.kubernetes.io/use-regex</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>     
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">__K8sNamespace__</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/customerapi-test/?(.*)</span>
</pre></table></code></div></div><p>Note: by default, ingress is disabled to make it easier for readers to use the microservices. If you want to use the Ingress object, update the enabled value of the ingress section in the values.release.yaml file to true.</p><h2 id="testing-the-microservice-with-the-nginx-ingress-controller">Testing the Microservice with the Nginx Ingress Controller</h2><p>After you deployed both microservices, check if you can access the swagger json with the following URL: <Public-IP>/customerapi-test/swagger/v1/swagger.json. This should display the json file:</Public-IP></p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/Accessing-the-Swagger-json-file.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/Accessing-the-Swagger-json-file.jpg" alt="Accessing the Swagger json file" /></a><p> Accessing the Swagger json file</p></div><p>Next, try to call one of the methods, for example, the PrimeNumber method:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/Calling-the-PrimeNumber-method.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/Calling-the-PrimeNumber-method.jpg" alt="Calling the PrimeNumber method" /></a><p> Calling the PrimeNumber method</p></div><p>When you try to access the Swagger UI, you will get an error message though:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/Error-message-of-Swagger-UI.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/Error-message-of-Swagger-UI.jpg" alt="Error message of Swagger UI" /></a><p> Error message of Swagger UI</p></div><p>It is inconvenient that this is not working but I will leave it as it is for now. In my next post, I will replace the IP address with a DNS entry which should fix the problem. Lastly, check if the second microservice is also working with the following URL: <Public-IP>/orderapi-test/swagger/v1/swagger.json</Public-IP></p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/The-OrderApi-works-too.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/The-OrderApi-works-too.jpg" alt="The OrderApi works too" /></a><p> The OrderApi works too</p></div><h2 id="conclusion">Conclusion</h2><p>Nginx can be used as an Ingress controller for your Kubernetes cluster. The setup can be done within minutes using the Helm chart and allows you to have a single entry point into your cluster. This demo used two microservices and provides basic routing to access them. In my next post, I will map a DNS name to the IP and access the microservices using different DNS names.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/nginx/" class="post-tag no-text-decoration" >Nginx</a> <a href="/tags/yaml/" class="post-tag no-text-decoration" >YAML</a> <a href="/tags/ci-cd/" class="post-tag no-text-decoration" >CI-CD</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/aks/" class="post-tag no-text-decoration" >AKS</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Set up Nginx as Ingress Controller in Kubernetes - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Set up Nginx as Ingress Controller in Kubernetes - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Set up Nginx as Ingress Controller in Kubernetes - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/automatically-version-docker-container/">Automatically Version Docker Containers in Azure DevOps CI</a><li><a href="/deploy-microservices-to-multiple-environments-azure-devops/">Deploy Microservices to multiple Environments using Azure DevOps</a><li><a href="/implement-azure-service-fabric-apps/">Design and Implement Azure Service Fabric apps</a><li><a href="/implement-third-party-paas/">Design and implement third-party PaaS</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/use-infrastructure-as-code-to-deploy-infrastructure/"><div class="card-body"> <span class="timeago small" > Jun 28 <i class="unloaded">2021-06-28T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use Infrastructure as Code to deploy your Infrastructure with Azure DevOps</h3><div class="text-muted small"><p> Back in the day developers had to go through a lengthy process to get new hardware deployed. Often it took several weeks and then there was still something missing or the wrong version of the neede...</p></div></div></a></div><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <span class="timeago small" > Dec 2, 2020 <i class="unloaded">2020-12-02T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software engineer on different projects which focus on microservice, DevOps, and process automation. Many of my consulting jobs are about explaining microservice, w...</p></div></div></a></div><div class="card"> <a href="/microservice-with-database-kubernetes/"><div class="card-body"> <span class="timeago small" > Mar 22 <i class="unloaded">2021-03-22T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use a Database with a Microservice running in Kubernetes</h3><div class="text-muted small"><p> I showed in my last post how to automatically deploy database changes to your database. In this post, I will extend my microservice to use this database and also extend the deployment to provide a ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/deploy-docker-container-azure-functions/" class="btn btn-outline-primary"><p>Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</p></a> <a href="/configure-custom-urls-to-access-microservices-running-in-kubernetes/" class="btn btn-outline-primary"><p>Configure custom URLs to access Microservices running in Kubernetes</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/setup-nginx-ingress-controller-kubernetes/'; this.page.identifier = '/setup-nginx-ingress-controller-kubernetes/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
