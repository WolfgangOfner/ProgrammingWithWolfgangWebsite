<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="RabbitMQ in an ASP .NET Core 3.1 Microservice" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="Today, I will implement RabbitMQ, so the microservices can exchange data while staying independent, highly available, and high-performant." /><meta property="og:description" content="Today, I will implement RabbitMQ, so the microservices can exchange data while staying independent, highly available, and high-performant." /><link rel="canonical" href="/rabbitmq-in-an-asp-net-core-3-1-microservice/" /><meta property="og:url" content="/rabbitmq-in-an-asp-net-core-3-1-microservice/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-18T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="RabbitMQ in an ASP .NET Core 3.1 Microservice" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2020-04-18T00:00:00+02:00","datePublished":"2020-04-18T00:00:00+02:00","description":"Today, I will implement RabbitMQ, so the microservices can exchange data while staying independent, highly available, and high-performant.","headline":"RabbitMQ in an ASP .NET Core 3.1 Microservice","mainEntityOfPage":{"@type":"WebPage","@id":"/rabbitmq-in-an-asp-net-core-3-1-microservice/"},"url":"/rabbitmq-in-an-asp-net-core-3-1-microservice/"}</script><title>RabbitMQ in an ASP .NET Core 3.1 Microservice | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "hc0wl2v6mn"); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/videos/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>VIDEOS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>RabbitMQ in an ASP .NET Core 3.1 Microservice</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>RabbitMQ in an ASP .NET Core 3.1 Microservice</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1587160800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 18, 2020 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1841 words"> <em>21 min</em></span> read</div></div><div class="post-content"><p><a href="https://www.programmingwithwolfgang.com/document-your-microservice-with-swagger">In my last posts</a>, I created two microservices using ASP .NET Core 3.1. Today, I will implement RabbitMQ, so the microservices can exchange data while staying independent. RabbitMQ can also be used to publish data even without knowing the subscribers. This means that you can publish an update and whoever is interested can get the new information.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="what-is-rabbitmq-and-why-use-it"><span class="mr-2">What is RabbitMQ and why use it?</span><a href="#what-is-rabbitmq-and-why-use-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>RabbitMQ describes itself as the most widely deployed open-source message broker. It is easy to implement and supports a wide variety of technologies like Docker, .NET, or Go. It also offers plugins for monitoring, managing, or authentication. I chose RabbitMQ because it is well known, quickly implemented, and especially can be easily run using Docker.</p><h2 id="why-use-a-queue-to-send-data"><span class="mr-2">Why use a Queue to send Data?</span><a href="#why-use-a-queue-to-send-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that you know what RabbitMQ is, the next question is: why should you use a queue instead of directly sending data from one microservice to the other one. There are a couple of reasons why using a queue instead of directly sending data is better:</p><ul><li>Higher availability and better error handling<li>Better scalability<li>Share data with whoever wants/needs it<li>Better user experience due to asynchronous processing</ul><h3 id="higher-availability-and-better-error-handling"><span class="mr-2">Higher Availability and better Error Handling</span><a href="#higher-availability-and-better-error-handling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Errors happen all the time. In the past, we designed our systems to avoid errors. Nowadays we design our systems to catch errors and handle them in a user-friendly way.</p><p>Let’s say we have an online shop and the order service sends data to the process order service after the customer placed his order. If these services are connected directly and the process order service is offline, the customer will get an error message, for example, “An error occurred. Please try it again later”. This user probably won’t return and you lost the revenue of the order and a potential future customer.</p><p>If the order service places the order in a queue and the order processing service is offline, the customer will get a message that the order got placed and he or she might come back in the future. When the order processing service is back online, it will process all entries in the queue. You might know this behavior when booking a flight. After booking the flight it takes a couple of minutes until you get your confirmation per email.</p><h3 id="better-scalability"><span class="mr-2">Better Scalability</span><a href="#better-scalability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When you place messages in a queue, you can start new instances of your processor depending on the queue size. For example, you have one processor running, when there are ten items in the queue, you start another one, and so on. Nowadays with cloud technologies and serverless features, you can easily scale up to thousands of instances of your processor.</p><h3 id="share-data-with-whoever-wantsneeds-it"><span class="mr-2">Share Data with whoever wants/needs it</span><a href="#share-data-with-whoever-wantsneeds-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Most of the time, you don’t know who wants to process the information you have.</p><p>Let’s say our order service publishes the order to the queue. Then the order processing service, reporting services, and logistics services can process the data. Your service as a publisher doesn’t care who takes the information. This is especially useful when you have a new service in the future which wants your order data too. This service only has to read the data from the queue. If your publisher service sends the data directly to the other services, you would have to implement each call and change your service every time a new service wants the data.</p><h3 id="better-user-experience-due-to-asynchronous-processing"><span class="mr-2">Better User Experience due to asynchronous processing</span><a href="#better-user-experience-due-to-asynchronous-processing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Better user experience is the result of the three other advantages. The user is way less likely to see an error message and even when there is a lot of traffic like on Black Friday, your system can perform well due to the scalability and the asynchronous processing.</p><h2 id="implement-rabbitmq-with-net-core"><span class="mr-2">Implement RabbitMQ with .NET Core</span><a href="#implement-rabbitmq-with-net-core" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You can find the code of  the finished demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>RabbitMQ has a lot of features. I will only implement a simple version of it to publish data to a queue in the Customer service and to process the data in the Order service.</p><h3 id="implementation-of-publishing-data"><span class="mr-2">Implementation of publishing data</span><a href="#implementation-of-publishing-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I am a big fan of Separation of Concerns (SoC) and therefore I am creating a new project in the CustomerApi solution called CustomerApi.Message.Send. Next, I install the RabbitMQ.Client NuGet package and create the class CustomerUpdateSender in the project. I want to publish my Customer object to the queue every time the customer is updated. Therefore, I create the SendCustomer method which takes a Customer object as a parameter.</p><h4 id="publish-data-to-rabbitmq"><span class="mr-2">Publish Data to RabbitMQ</span><a href="#publish-data-to-rabbitmq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Publishing data to the queue is pretty simple. First, you have to create a connection to RabbitMQ using its hostname, a username, and a password using the ConnectionFactory. With this connection, you can use QueueDeclare to create a new queue if it doesn’t exist yet. The QueueDeclare method takes a couple of parameters like a name and whether the queue is durable.</p><script src="https://gist.github.com/WolfgangOfner/7180c5edd20d0b0b9d1e00270348d425.js"></script><p>After creating the connection to the queue, I convert my customer object to a JSON object using JsonConvert and then encode this JSON to UTF8.</p><script src="https://gist.github.com/WolfgangOfner/2038858666041509f250510be4552724.js"></script><p>The last step is to publish the previously generated byte array using BasicPublish. BasicPublish has like QueueDeclare a couple of useful parameters but to keep it simple, I only provide the queue name and my byte array.</p><script src="https://gist.github.com/WolfgangOfner/01b010d0a264667ee46122f0a7293f4e.js"></script><p>That’s all the logic you need to publish data to your queue. Before I can use it, I have to do two more things though. First, I have to register my CustomerUpdateSender class in the Startup class. I am also providing the settings for the queue such as the name or user from the appsettings. Therefore, I have to read this section in the Startup class.</p><script src="https://gist.github.com/WolfgangOfner/f26366219f4d74d8887be1bc88e25107.js"></script><p>The last step is to call the SendCustomer method when a customer is updated. This call is in the Handle method of the UpdateCustomerCommandHandler.</p><script src="https://gist.github.com/WolfgangOfner/835ba90f46b4142121a1fd05184aa091.js"></script><p>Note: I updated the implementation on November 27, 2020. Instead of creating a connection every time the method is called, I reuse the connection and only create a new channel. This follows the RabbitMQ best practices and helps to improve the performance significantly. I am not reusing the channel since I don’t need the highest performance and I want to keep the implementation simple. The new code looks as follows:</p><script src="https://gist.github.com/WolfgangOfner/27598498de3abb4f06c14dd8e34ed6e1.js"></script><h3 id="implementation-of-reading-data-from-rabbitmq"><span class="mr-2">Implementation of reading Data from RabbitMQ</span><a href="#implementation-of-reading-data-from-rabbitmq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Implementing the read functionality is a bit more complex because we have to constantly check the queue if there are new messages and if so, process them. I love .NET Core and it comes really handy here. .NET Core provides the abstract class BackgroundService which provides the method ExecuteAsync. This method can be overridden and is executed regularly in the background.</p><p>In the OrderApi solution, I create a new project called OrderApi.Messaging.Receive, install the RabbitMQ.Client NuGet and create a class called CustomerFullNameUpdateReceiver. This class inherits from the BackgroundService class and overrides the ExecuteAsync method.</p><p>In the constructor of the class, I initialize my queue the same way as in the CustomerApi using QueueDeclere. Additionally, I register events that I won’t implement now but might be useful in the future.</p><script src="https://gist.github.com/WolfgangOfner/977a31648dab713bf65e70ae2ce22aa0.js"></script><h4 id="reading-data-from-the-queue"><span class="mr-2">Reading Data from the Queue</span><a href="#reading-data-from-the-queue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In the ExecuteAsync method, I am subscribing to the receive event and whenever this event is fired, I am reading the message and encode its body which is my Customer object. Then I am using this Customer object to call another service that will do the update in the database.</p><script src="https://gist.github.com/WolfgangOfner/392b058ce1bf616723e32d891c59973a.js"></script><p>That’s all you have to do to read data from the queue. The last thing I have to do is to register my CustomerFullNameUpdateReceiver class as a background service in the Startup class.</p><script src="https://gist.github.com/WolfgangOfner/01537df76c4229c3f5591c2376a016bf.js"></script><p>The code above checks whether the setting RabbitMq:Enables is true. If it is set to true, the background service gets registered. This check is useful because so you can either use the appsettings.json file or provide an environment variable to override it.</p><h2 id="run-rabbitmq-in-docker"><span class="mr-2">Run RabbitMQ in Docker</span><a href="#run-rabbitmq-in-docker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The publish and receive functionalities are implemented. The last step before testing them is to start an instance of RabbitMQ. The easiest way is to run it in a Docker container. If you don’t know what Docker is or haven’t installed it, download Docker Desktop for Windows from <a href="https://docs.docker.com/docker-for-windows/" target="_blank" rel="noopener noreferrer">here</a> or for Mac from <a href="https://docs.docker.com/docker-for-mac/" target="_blank" rel="noopener noreferrer">here</a>. After you installed Docker, copy the two following lines in Powershell or bash:</p><script src="https://gist.github.com/WolfgangOfner/78bff5f7de1d1b0da283633b583fe2c7.js"></script> <script src="https://gist.github.com/WolfgangOfner/1e58b4944c20243a359ca1691d4a4ac1.js"></script><p>Don’t worry if you don’t understand them. Simplified these two lines download the RabbitMQ Docker image, start it as a container and configure the ports, the name, and the credentials.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Run-RabbitMQ-in-a-Docker-container.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/Run-RabbitMQ-in-a-Docker-container.jpg" alt="Run RabbitMQ in a Docker container" data-proofer-ignore></a><p> Run RabbitMQ in a Docker container</p></div><p>After RabbitMQ is started, you can navigate to localhost:15672 and login with guest as user and guest as password.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Login-into-the-RabbitMQ-management-portal.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/Login-into-the-RabbitMQ-management-portal.jpg" alt="Login into the RabbitMQ management portal" data-proofer-ignore></a><p> Login into the RabbitMQ management portal</p></div><p>Navigate to the Queues tab and you will see that there is no queue yet.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/No-queues-are-created-yet.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/No-queues-are-created-yet.jpg" alt="A message was published and consumed" data-proofer-ignore></a><p> A message was published and consumed</p></div><p>Now you can start the OrderApi and the CustomerApi project. The order of how you start them doesn’t matter. After you started the OrderApi project, the CustomerQueue will be created and you can see it in the management portal.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/The-CustomerQueue-was-created-from-the-CustomerApi-solution.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/The-CustomerQueue-was-created-from-the-CustomerApi-solution.jpg" alt="No queues are created yet" data-proofer-ignore></a><p> No queues are created yet</p></div><p>Click on CustomerQueue and you will see that there is no message in the queue yet and that there is one consumer (the OrderApi).</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Overview-of-the-CustomerQueue-and-its-Consumers.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/Overview-of-the-CustomerQueue-and-its-Consumers.jpg" alt="Overview of the CustomerQueue and its Consumers" data-proofer-ignore></a><p> Overview of the CustomerQueue and its Consumers</p></div><p>Go to the Put action of the CustomerApi and update a customer. If you use my in-memory database you can use the Guid “9f35b48d-cb87-4783-bfdb-21e36012930a”. The other values don’t matter for this test.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Update-a-customer.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/Update-a-customer.jpg" alt="Update a customer" data-proofer-ignore></a><p> Update a customer</p></div><p>After you sent the update request, go back to the RabbitMQ management portal and you will see that a message was published to the queue and also a message was consumed.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/A-message-was-published-and-consumed.jpg"><img loading="lazy" data-src="/assets/img/posts/2020/04/A-message-was-published-and-consumed.jpg" alt="A message was published and consumed" data-proofer-ignore></a><p> A message was published and consumed</p></div><h2 id="shortcomings-of-my-implementation"><span class="mr-2">Shortcomings of my Implementation</span><a href="#shortcomings-of-my-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the CustomerApi, there is no real exception handling right now. This means that if there is an error while processing a message, the message will be deleted from the queue and therefore be lost. Also if there is no connection to RabbitMQ, the message will be discarded and therefore lost. In a production environment, you should save this message somewhere and process it once all systems are back up and running.</p><p>Another problem is that after the message is read, it is removed from the queue. This means only one receiver is possible at the moment. There are also no unit tests for the implementation of the RabbitMQ client.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This post explained why you should use queues to decouple your microservices and how to implement RabbitMQ using Docker and ASP .NET Core 3.1. Keep in mind that this is a quick implementation and needs some work to be production-ready.</p><p><a href="/dockerize-an-asp-net-core-microservice-and-rabbitmq" target="_blank" rel="noopener noreferrer">In my next post</a>, I will dockerize the application which will make it way easier to run and distribute the whole application.</p><p>You can find the code of  the finished demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><p>Update: On November 27 2020, I refactored the registration of the service to make it more resilient and also change the implementation of the sender to reuse the connection instead of creating a new one for every message.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/docker/'>Docker</a>, <a href='/categories/asp-net/'>ASP.NET</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/net-core-3-1/" class="post-tag no-text-decoration" >.NET Core 3.1</a> <a href="/tags/c/" class="post-tag no-text-decoration" >C#</a> <a href="/tags/cqrs/" class="post-tag no-text-decoration" >CQRS</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/docker-compose/" class="post-tag no-text-decoration" >Docker-Compose</a> <a href="/tags/mediatr/" class="post-tag no-text-decoration" >MediatR</a> <a href="/tags/microservice/" class="post-tag no-text-decoration" >Microservice</a> <a href="/tags/rabbitmq/" class="post-tag no-text-decoration" >RabbitMQ</a> <a href="/tags/swagger/" class="post-tag no-text-decoration" >Swagger</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=RabbitMQ+in+an+ASP+.NET+Core+3.1+Microservice+-+Programming+With+Wolfgang&url=%2Frabbitmq-in-an-asp-net-core-3-1-microservice%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=RabbitMQ+in+an+ASP+.NET+Core+3.1+Microservice+-+Programming+With+Wolfgang&u=%2Frabbitmq-in-an-asp-net-core-3-1-microservice%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=RabbitMQ+in+an+ASP+.NET+Core+3.1+Microservice+-+Programming+With+Wolfgang&url=%2Frabbitmq-in-an-asp-net-core-3-1-microservice%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Frabbitmq-in-an-asp-net-core-3-1-microservice%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/programming-microservices-net-core-3-1/"><div class="card-body"> <em class="small" data-ts="1586728800" data-df="ll" > Apr 13, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Programming a Microservice with .NET Core 3.1</h3><div class="text-muted small"><p> In my last post, I talked about the theory of a microservice. Today it is going to be more practical. I will create two microservices using ASP .NET Core 3.1. Over the next posts., I will extend th...</p></div></div></a></div><div class="card"> <a href="/document-your-microservice-with-swagger/"><div class="card-body"> <em class="small" data-ts="1586901600" data-df="ll" > Apr 15, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Document your Microservice with Swagger</h3><div class="text-muted small"><p> Swagger is an open-source toolset that can be easily integrated into your solution and helps you to document and test your APIs. It is so simple that even non-technical people can use it. In my la...</p></div></div></a></div><div class="card"> <a href="/cqrs-in-asp-net-core-3-1/"><div class="card-body"> <em class="small" data-ts="1586988000" data-df="ll" > Apr 16, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CQRS in ASP .NET Core 3.1</h3><div class="text-muted small"><p> CQRS stands for Command Query Responsibility Segregation and is used to use different models for read and for write operations. In this post, I will explain how I implemented CQRS in my microservic...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/mediator-pattern-in-asp-net-core-3-1/" class="btn btn-outline-primary" prompt="Older"><p>Mediator Pattern in ASP .NET Core 3.1</p></a> <a href="/dockerize-an-asp-net-core-microservice-and-rabbitmq/" class="btn btn-outline-primary" prompt="Newer"><p>Dockerize an ASP .NET Core Microservice and RabbitMQ</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/rabbitmq-in-an-asp-net-core-3-1-microservice/'; this.page.identifier = '/rabbitmq-in-an-asp-net-core-3-1-microservice/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
