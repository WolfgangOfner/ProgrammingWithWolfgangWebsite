<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Implement AAD Authentication to access Azure SQL Databases" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Using Azure Active Directory authentication to access data from an Azure SQL Server can be implemented easily and helps you to go passwordless." /><meta property="og:description" content="Using Azure Active Directory authentication to access data from an Azure SQL Server can be implemented easily and helps you to go passwordless." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-01T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Implement AAD Authentication to access Azure SQL Databases" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"datePublished":"2021-11-01T00:00:00+01:00","dateModified":"2021-12-16T22:44:28+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/"},"@type":"BlogPosting","description":"Using Azure Active Directory authentication to access data from an Azure SQL Server can be implemented easily and helps you to go passwordless.","author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/","headline":"Implement AAD Authentication to access Azure SQL Databases","@context":"https://schema.org"}</script><title>Implement AAD Authentication to access Azure SQL Databases | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/mct-microsoft-certified-trainer.png" alt="MCT Microsoft Certified Trainer" width="200px" height="200px"></div><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Implement AAD Authentication to access Azure SQL Databases</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Implement AAD Authentication to access Azure SQL Databases</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Implement AAD Authentication to access Azure SQL Databases</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Nov 1, 2021, 12:00 AM +0100" > Nov 1, 2021 <i class="unloaded">2021-11-01T00:00:00+01:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 16, 2021, 10:44 PM +0100" > Dec 16, 2021 <i class="unloaded">2021-12-16T22:44:28+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1341 words">15 min</span></div></div><div class="post-content"><p>Microsoft promotes going passwordless for a while now. Azure offers authentication against the Azure Active Directory where applications can acquire access tokens using their identity. Another use case would be accessing an SQL database running on Azure. Although, in theory, this sounds very easy, my experience showed that it can get tricky.</p><p>Today I want to show you how to configure Azure SQL with Azure Active Directory authentication and how to avoid annoying pitfalls.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="configure-aad-authentication-for-an-azure-sql-server">Configure AAD Authentication for an Azure SQL Server</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo/tree/master/CustomerApi" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>In one of my previous posts, I have created an SQL Server that runs all my databases. If you also have an SQL server, you have to set an Active Directory admin. This admin can be either an AAD user or a group. Without this admin, the SQL server won’t be able to authenticate your users against the AAD.</p><p>You can either use the Azure portal or Azure CLI to set the Active Directory admin. If you use the portal, open your SQL server and select the Active Directory admin pane. There, click on Set admin, search for your user or group and save your selection.</p><p>If you use the Azure CLI, use the following query to get all AAD users:</p><script src="https://gist.github.com/WolfgangOfner/2a369b0bd181aaec0219fc066d7fc215.js"></script><p>The –query parameter only filters the response to only display the principal name of the AAD user.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Get-the-principal-name-of-all-AAD-users.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Get-the-principal-name-of-all-AAD-users.jpg" alt="Get the principal name of all AAD users" /></a><p> Get the principal name of all AAD users</p></div><p>My AAD currently has only one user and therefore returns only this one principal name. Once you know the principal name of the group or user you want to set as admin, you can filter using the –filter flag so your query only returns this one entity. Save the return value in a variable, so you can reuse it in the next step.</p><script src="https://gist.github.com/WolfgangOfner/fc620c85759c02f6ef8d58f5db8696f9.js"></script><p>With the user set to the variable, use the following command to set the Active Directory admin. Replace the resource group and server name with your corresponding values.</p><script src="https://gist.github.com/WolfgangOfner/40e53882bd0d349e93a7101783148bc7.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Set-the-Active-Directory-admin.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Set-the-Active-Directory-admin.jpg" alt="Set the Active Directory admin" /></a><p> Set the Active Directory admin</p></div><h2 id="configure-the-test-application-to-use-aad-authentication">Configure the Test Application to use AAD Authentication</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo/tree/master/CustomerApi" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>Open the SQL management tool of your choice, for me, it’s Microsoft SQL Server Management Studio (SSMS), and log in with the user you previously set as the Active Directory admin.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Log-in-using-the-server-admin-user.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Log-in-using-the-server-admin-user.jpg" alt="Log in using the server admin user" /></a><p> Log in using the server admin user</p></div><p>You should be able to log in and see all the databases on the server.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/The-login-was-successful.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/The-login-was-successful.jpg" alt="The login was successful" /></a><p> The-login-was-successful</p></div><p>Now it is time to test the login with a test application. To use AAD authentication when developing, you have to sign in to Visual Studio. Visual Studio then uses this user to request an access token and authenticate you to the SQL server. Since you should not use the admin account for your application, I log in with a different user.</p><p>Before you can use your test application, you have to make some small changes. First, install the following NuGet packages:</p><script src="https://gist.github.com/WolfgangOfner/ac7e15877b4f3d482ba16bb0c3b214ab.js"></script><p>Next, create a custom SQL authentication provider. This class requests an access token from the AAD.</p><script src="https://gist.github.com/WolfgangOfner/4faaf043f6fed35b567e61b71e2024d7.js"></script><p>With the authentication provider set up, register your DbContext in the Startup.cs class and add the previously created authentication provider.</p><script src="https://gist.github.com/WolfgangOfner/df5aeda2699ce2218a0e771b7864ccc8.js"></script><p>Lastly, set the following connection string in your appsettings.json file.</p><script src="https://gist.github.com/WolfgangOfner/a3b7c8ee3529784c771142559c03002e.js"></script><h2 id="testing-the-aad-authentication">Testing the AAD Authentication</h2><p>If you are using my demo application, make sure that you have set the “UseInMemoryDatabase” setting in the appsettings.json and appsettings.Development.json files to false. Otherwise, the application will use an in-memory database.</p><p>When you start the demo application, you will see the Swagger UI. Execute the Get request for Customer and you will see the following error message:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/The-login-to-the-Customer-database-failed.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/The-login-to-the-Customer-database-failed.jpg" alt="The-login-to-the-Customer-database-failed" /></a><p> The-login-to-the-Customer-database-failed</p></div><p>The login failed because the user logged in to Visual Studio has no access to the Customer database. You have to add your users to the database before they can access it.</p><h3 id="add-users-to-your-database">Add Users to your Database</h3><p>Log in to the database with the user you previously set as the admin. Add your Visual Studio user with the following code and also give the user the desired roles.</p><script src="https://gist.github.com/WolfgangOfner/9141fb00fad16c11cee75d3e756b931c.js"></script><p>Now you should be able to log in with this user. If you use SSMS, make sure that you select the Customer database as the default database. If you don’t set Customer as your default database, SSMS will use the Master database and since the user does not exist in this database, the login will fail.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/The-user-does-not-exist-in-the-Master-database.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/The-user-does-not-exist-in-the-Master-database.jpg" alt="The user does not exist in the Master database" /></a><p> The user does not exist in the Master database</p></div><h2 id="try-the-test-application-again">Try the Test Application again</h2><p>Start the test application and execute the Get request again. This time you should get some customers. You may get the following error though:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Login-to-the-SQL-server-failed.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Login-to-the-SQL-server-failed.jpg" alt="Login to the SQL server failed" /></a><p> Login to the SQL server failed</p></div><p>If you google this error message, you won’t find much helpful information. Also, Microsoft’s documentation doesn’t mention anything about this error.</p><p>The problem you encounter here is that your user exists in multiple tenants and the authentication provider does not know which tenant it should use. To fix this problem, you have to add the tenant where the SQL server resides to your authentication provider.</p><script src="https://gist.github.com/WolfgangOfner/ff225ea73729718378fbafe7b4a4e412.js"></script><p>Replace the XXX with your actual tenant Id.</p><p>Run your application again and now you should be able to retrieve the data from the database.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Successfully-retrieved-data-from-the-database.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Successfully-retrieved-data-from-the-database.jpg" alt="Successfully retrieved data from the database" /></a><p> Successfully retrieved data from the database</p></div><p>To verify that you loaded the data from the right database, log in to your database using SSMS and query the Customers in your Customer database. The result should be the same as you saw previously in your test application.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/11/Query-customers-from-the-database-using-SSMS.jpg"><img loading="lazy" src="/assets/img/posts/2021/11/Query-customers-from-the-database-using-SSMS.jpg" alt="Query customers from the database using SSMS" /></a><p> Query customers from the database using SSMS</p></div><h2 id="improving-the-test-application">Improving the Test Application</h2><p>The test application can retrieve data using the AAD authentication but the code is not pretty yet. Especially the part where the tenant Id is hard-coded into the authentication provider. Let’s improve this code a bit.</p><p>First add a new property, TenantId to the appsettings.json file.</p><script src="https://gist.github.com/WolfgangOfner/0097a26acdf4da885007bb9c39134765.js"></script><p>Next, add a constructor to your CustomAzureSqlAuthProvider with a string as the parameter. This string will contain the tenant Id. Assign the parameter to a private variable. Then replace the hard-coded tenant Id with the new private variable.</p><script src="https://gist.github.com/WolfgangOfner/e45dd2710f31631e342d0fcacc2e9e07.js"></script><p>Lastly, read the value of the tenant Id from the appsettings.json file and pass it to the constructor of your authentication provider in the Startup.cs class.</p><script src="https://gist.github.com/WolfgangOfner/2623f3a357887415caa6a529ae240219.js"></script><p>Run your application again to make sure that everything still works.</p><h2 id="pass-the-tenant-id-during-the-deployment">Pass the Tenant Id during the Deployment</h2><p>You want to pass the tenant id during the deployment to keep it secret. If you commit it to your version control, everyone would be able to read it. You have to take the following steps to pass the tenant id during the deployment:</p><p>Add a variable for the tenant id to your values.yaml or values.release.yaml file in your Helm chart. This variable has to start and finish with two underscores (__) so the Tokenizer task in the Azure DevOps pipeline can replace the value. Next, add your tenant id as a secret variable in your pipeline. Don’t forget to update the connection string in your deployment pipeline too.</p><p>The Tokenizer task will replace the tenant id in the Helm chart with your actual tenant id and therefore will override the empty TenantId value in your appsettings.json file. For a detailed explanation on how and why this works, see <a href="/replace-helm-variables-tokenizer">Replace Helm Chart Variables in your CI/CD Pipeline with Tokenizer</a>.</p><h2 id="conclusion">Conclusion</h2><p>Azure Active Directory authentication to access your databases is a great feature to get rid of passwords. This should also streamline the development process since you don’t have to share passwords with new developers. All you have to do is to add the developer to the desired database so they can log in.</p><p>There may be some roadblocks on the way and Microsoft’s documentation only showcases the happy path of the integration. This post should help you with the most common pitfalls and shows how to avoid them.</p><p><a href="/aad-authentication-for-applications-running-in-aks-to-access-azure-sql-databases">In my next post</a>, I will show you how to use AAD authentication with your application running in AKS.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo/tree/master/CustomerApi" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud/'>Cloud</a>, <a href='/categories/programming/'>Programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >SQL</a> <a href="/tags/aad/" class="post-tag no-text-decoration" >AAD</a> <a href="/tags/c/" class="post-tag no-text-decoration" >C#</a> <a href="/tags/net/" class="post-tag no-text-decoration" >.NET</a> <a href="/tags/entity-framework-core/" class="post-tag no-text-decoration" >Entity Framework Core</a> <a href="/tags/azure-cli/" class="post-tag no-text-decoration" >Azure CLI</a> <a href="/tags/azure-sql/" class="post-tag no-text-decoration" >Azure SQL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Implement AAD Authentication to access Azure SQL Databases - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Implement AAD Authentication to access Azure SQL Databases - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Implement AAD Authentication to access Azure SQL Databases - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/create-a-docker-image-in-an-azure-devops-ci-pipeline/">Create a Docker Image in an Azure DevOps CI Pipeline</a><li><a href="/azure-container-registry-kubernetes/">Use Azure Container Registry in Kubernetes</a><li><a href="/deploy-docker-container-azure-functions/">Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</a><li><a href="/update-dns-records-in-an-azure-devops-pipeline/">Update DNS Records in an Azure DevOps Pipeline</a><li><a href="/net-core-3-0-whats-new/">.NET Core 3.0 - What's new</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/aad-authentication-for-applications-running-in-aks-to-access-azure-sql-databases/"><div class="card-body"> <span class="timeago small" > Dec 6, 2021 <i class="unloaded">2021-12-06T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use AAD Authentication for Applications running in AKS to access Azure SQL Databases</h3><div class="text-muted small"><p> Removing passwords and using identities to access resources is the way to go for new applications. In my last posts Use AAD Authentication for Pods running in AKS and Implement AAD Authentication t...</p></div></div></a></div><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <span class="timeago small" > Dec 2, 2020 <i class="unloaded">2020-12-02T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software engineer on different projects which focus on microservice, DevOps, and process automation. Many of my consulting jobs are about explaining microservice, w...</p></div></div></a></div><div class="card"> <a href="/how-to-pass-az-303-and-az-304-certification-exams/"><div class="card-body"> <span class="timeago small" > May 24, 2021 <i class="unloaded">2021-05-24T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to pass the AZ-303 and AZ-304 Certification Exams</h3><div class="text-muted small"><p> Two weeks ago, I passed the AZ-304 exam and today I passed the AZ-303 exam giving me the Azure Solutions Architect Expert certification. This post will give you an overview of the exams what metho...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/use-aad-authentication-for-pods-running-in-aks/" class="btn btn-outline-primary"><p>Use AAD Authentication for Pods running in AKS</p></a> <a href="/automatically-set-service-bus-queue-connection-string-during-deployment/" class="btn btn-outline-primary"><p>Automatically set Azure Service Bus Queue Connection Strings during the Deployment</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/implement-aad-authentication-to-access-azure-sql-databases/'; this.page.identifier = '/implement-aad-authentication-to-access-azure-sql-databases/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
