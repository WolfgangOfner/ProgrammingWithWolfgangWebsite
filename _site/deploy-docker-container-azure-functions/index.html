<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Build and Deploy an Azure Function inside a Docker container and deploy it using an Azure DevOps YAML pipeline." /><meta property="og:description" content="Build and Deploy an Azure Function inside a Docker container and deploy it using an Azure DevOps YAML pipeline." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-03T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/","description":"Build and Deploy an Azure Function inside a Docker container and deploy it using an Azure DevOps YAML pipeline.","@type":"BlogPosting","headline":"Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline","dateModified":"2021-05-03T00:00:00+02:00","datePublished":"2021-05-03T00:00:00+02:00","@context":"https://schema.org"}</script><title>Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 3, 2021, 12:00 AM +0200" > May 3 <i class="unloaded">2021-05-03T00:00:00+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="992 words">11 min</span></div></div><div class="post-content"><p><a href="/deploy-azure-functions-azure-devops-pipelines">In my last post</a>, I created a YAML pipeline to build and deploy an Azure Function to Azure. Today, I will build the same Azure Function inside a Docker container and deploy the container to Azure.</p><h2 id="add-docker-to-the-azure-function">Add Docker to the Azure Function</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>To add Docker to the Azure Function, right-click the project in Visual Studio and click Add –&gt; Docker Support. Visual Studio automatically creates the Dockerfile for you.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>FROM mcr.microsoft.com/azure-functions/dotnet:3.0 AS base
WORKDIR /home/site/wwwroot
EXPOSE 80

FROM mcr.microsoft.com/dotnet/sdk:3.1 AS build
WORKDIR /src
COPY <span class="o">[</span><span class="s2">"OrderApi.Messaging.Receive/OrderApi.Messaging.Receive.csproj"</span>, <span class="s2">"OrderApi.Messaging.Receive/"</span><span class="o">]</span>
RUN dotnet restore <span class="s2">"OrderApi.Messaging.Receive/OrderApi.Messaging.Receive.csproj"</span>
COPY <span class="nb">.</span> <span class="nb">.</span>
WORKDIR <span class="s2">"/src/OrderApi.Messaging.Receive"</span>
RUN dotnet build <span class="s2">"OrderApi.Messaging.Receive.csproj"</span> <span class="nt">-c</span> Release <span class="nt">-o</span> /app/build

FROM build AS publish
RUN dotnet publish <span class="s2">"OrderApi.Messaging.Receive.csproj"</span> <span class="nt">-c</span> Release <span class="nt">-o</span> /app/publish

FROM base AS final
WORKDIR /home/site/wwwroot
COPY <span class="nt">--from</span><span class="o">=</span>publish /app/publish <span class="nb">.</span>
ENV <span class="nv">AzureWebJobsScriptRoot</span><span class="o">=</span>/home/site/wwwroot <span class="se">\</span>
    <span class="nv">AzureFunctionsJobHost__Logging__Console__IsEnabled</span><span class="o">=</span><span class="nb">true</span>
</pre></table></code></div></div><p>If you want to learn more about adding Docker to a .NET 5 project, see my post <a href="/dockerize-an-asp-net-core-microservice-and-rabbitmq">Dockerize an ASP .NET Core Microservice and RabbitMQ</a>.</p><h2 id="build-a-docker-container-inside-a-yaml-pipeline-in-azure-devops">Build a Docker Container inside a YAML Pipeline in Azure DevOps</h2><p>In Azure DevOps, create a new pipeline (or edit the one form last post) and add the following variables:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="na">variables</span><span class="pi">:</span>
  <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">OrderApi.Messaging.Receive'</span>  
  <span class="na">ConnectionString</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Server=tcp:$(SQLServerName),1433;Initial</span><span class="nv"> </span><span class="s">Catalog=$(DatabaseName);Persist</span><span class="nv"> </span><span class="s">Security</span><span class="nv"> </span><span class="s">Info=False;User</span><span class="nv"> </span><span class="s">ID=$(DbUser);Password=$(DbPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection</span><span class="nv"> </span><span class="s">Timeout=30;"</span>
  <span class="na">ContainerRegistry</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
  <span class="na">DatabaseName</span><span class="pi">:</span> <span class="s">Order</span>  
  <span class="na">SQLServerName</span><span class="pi">:</span> <span class="s">wolfgangmicroservicedemosql.database.windows.net</span> <span class="c1"># replace with your server url</span>
  <span class="na">Repository</span><span class="pi">:</span> <span class="s1">'</span><span class="s">wolfgangofner/orderapimessagingreceive'</span>
  <span class="na">Tag</span><span class="pi">:</span> <span class="s">$(GitVersion.NuGetVersionV2)</span>
</pre></table></code></div></div><p>Additionally, add DbUser, DbPassword, and QueueConnectionString as secret variables to the pipeline. These variables contain the database user and password and the connection string to the Azure Service Bus Queue. If you want to deploy your own Azure Function without a connection to other services, then you obviously don’t have to add the variables.</p><p>Next, add a job inside a stage and create a build version using GitVersion. If you want to learn more about versioning, see my post <a href="/automatically-version-docker-container">Automatically Version Docker Containers in Azure DevOps CI</a>.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build_and_Publish</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and Publish container</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build_and_Publish'</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and publish the container</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">gitversion/setup@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Install GitVersion</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">versionSpec</span><span class="pi">:</span> <span class="s1">'</span><span class="s">5.5.0'</span>
        
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">gitversion/execute@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Determine Version</span>
</pre></table></code></div></div><p>With the version number in place, add two more tasks to build the Docker container and then push it to a registry. In this demo, I am pushing it to DockerHub.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@2</span>  
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">containerRegistry</span><span class="pi">:</span> <span class="s">$(ContainerRegistry)</span>
    <span class="na">repository</span><span class="pi">:</span> <span class="s">$(Repository)</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build'</span>
    <span class="na">Dockerfile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/$(ArtifactName)/$(ArtifactName)/Dockerfile'</span>
    <span class="na">buildContext</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureFunctions/$(ArtifactName)'</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>      
      <span class="s">$(Tag)</span>
      <span class="s">latest   </span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">Container'</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@2</span>  
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">containerRegistry</span><span class="pi">:</span> <span class="s">$(ContainerRegistry)</span>
    <span class="na">repository</span><span class="pi">:</span> <span class="s">$(Repository)</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">push'</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>      
      <span class="s">$(Tag)</span>
      <span class="s">latest</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">Container'</span>
</pre></table></code></div></div><p>The last step is to deploy the previously created Docker container to the Azure Function and then pass the database and queue connection string to its settings. For more information about deploying an Azure Function with Azure DevOps see my last post, <a href="/deploy-azure-functions-azure-devops-pipelines">Deploy Azure Functions with Azure DevOps YAML Pipelines</a>. Note that the Azure Function must exist, otherwise the deployment will fail.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureFunctionAppContainer@1</span> 
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureServiceConnection'</span>
    <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">microservicedemoOrderApiMessagingReceive'</span>
    <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Repository):$(Tag)'</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureAppServiceSettings@1</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureServiceConnection'</span>
    <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">microservicedemoOrderApiMessagingReceive'</span>
    <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">MicroserviceDemo'</span>
    <span class="na">appSettings</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">[</span>
        <span class="s">{</span>
          <span class="s">"name": "QueueConnectionString",</span>
          <span class="s">"value": "$(QueueConnectionString)",</span>
          <span class="s">"slotSetting": false</span>
        <span class="s">},</span>
        <span class="s">{</span>
          <span class="s">"name": "DatabaseConnectionString",</span>
          <span class="s">"value": "$(ConnectionString)", </span>
          <span class="s">"slotSetting": false</span>
        <span class="s">}</span>
      <span class="s">]</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Update App Settings</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
</pre></table></code></div></div><p>The full pipeline looks as follows:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre><span class="na">name </span><span class="pi">:</span> <span class="s">OrderApi.Messaging.Receive-Docker-CI-azure-pipeline.yml</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="na">branches</span><span class="pi">:</span>
    <span class="na">include</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">master</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="na">include</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">AzureFunctions/OrderApi.Messaging.Receive/*</span>

<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-latest'</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">ArtifactName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">OrderApi.Messaging.Receive'</span>  
  <span class="na">ConnectionString</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Server=tcp:$(SQLServerName),1433;Initial</span><span class="nv"> </span><span class="s">Catalog=$(DatabaseName);Persist</span><span class="nv"> </span><span class="s">Security</span><span class="nv"> </span><span class="s">Info=False;User</span><span class="nv"> </span><span class="s">ID=$(DbUser);Password=$(DbPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection</span><span class="nv"> </span><span class="s">Timeout=30;"</span>
  <span class="na">ContainerRegistry</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
  <span class="na">DatabaseName</span><span class="pi">:</span> <span class="s">Order</span>  
  <span class="na">SQLServerName</span><span class="pi">:</span> <span class="s">wolfgangmicroservicedemosql.database.windows.net</span> <span class="c1"># replace with your server url</span>
  <span class="na">Repository</span><span class="pi">:</span> <span class="s1">'</span><span class="s">wolfgangofner/orderapimessagingreceive'</span>
  <span class="na">Tag</span><span class="pi">:</span> <span class="s">$(GitVersion.NuGetVersionV2)</span>

<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build_and_Publish</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and Publish container</span>
  <span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build_and_Publish'</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and publish the container</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">gitversion/setup@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Install GitVersion</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">versionSpec</span><span class="pi">:</span> <span class="s1">'</span><span class="s">5.5.0'</span>
        
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">gitversion/execute@0</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Determine Version</span>

    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">Container'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerRegistry</span><span class="pi">:</span> <span class="s">$(ContainerRegistry)</span>
        <span class="na">repository</span><span class="pi">:</span> <span class="s">$(Repository)</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">build'</span>
        <span class="na">Dockerfile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/$(ArtifactName)/$(ArtifactName)/Dockerfile'</span>
        <span class="na">buildContext</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureFunctions/$(ArtifactName)'</span>
        <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>      
          <span class="s">$(Tag)</span>
          <span class="s">latest        </span>
  
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@2</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">Container'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerRegistry</span><span class="pi">:</span> <span class="s">$(ContainerRegistry)</span>
        <span class="na">repository</span><span class="pi">:</span> <span class="s">$(Repository)</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">push'</span>
        <span class="na">tags</span><span class="pi">:</span> <span class="pi">|</span>      
          <span class="s">$(Tag)</span>
          <span class="s">latest</span>
      <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>

    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureFunctionAppContainer@1</span> 
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureServiceConnection'</span>
        <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">microservicedemoOrderApiMessagingReceive'</span>
        <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(Repository):$(Tag)'</span>

    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzureAppServiceSettings@1</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AzureServiceConnection'</span>
        <span class="na">appName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">microservicedemoOrderApiMessagingReceive'</span>
        <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">MicroserviceDemo'</span>
        <span class="na">appSettings</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">[</span>
            <span class="s">{</span>
              <span class="s">"name": "QueueConnectionString",</span>
              <span class="s">"value": "$(QueueConnectionString)",</span>
              <span class="s">"slotSetting": false</span>
            <span class="s">},</span>
            <span class="s">{</span>
              <span class="s">"name": "DatabaseConnectionString",</span>
              <span class="s">"value": "$(ConnectionString)", </span>
              <span class="s">"slotSetting": false</span>
            <span class="s">}</span>
          <span class="s">]</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s">Update App Settings</span>
      <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
</pre></table></code></div></div><p>Save the pipeline and run it.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/The-pipeline-ran-sucessfully.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/The-pipeline-ran-sucessfully.jpg" alt="The pipeline ran sucessfully" /></a><p> The pipeline ran sucessfully</p></div><p>You can see the Docker container with its two tags on DockerHub after the build is finished.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/05/The-Azure-Function-Container-got-pushed-to-DockerHub.jpg"><img loading="lazy" src="/assets/img/posts/2021/05/The-Azure-Function-Container-got-pushed-to-DockerHub.jpg" alt="The Azure Function Container got pushed to DockerHub" /></a><p> The Azure Function Container got pushed to DockerHub</p></div><p>Testing the Azure Function is exactly the same as in my last post, <a href="/deploy-azure-functions-azure-devops-pipelines/#testing-the-deployed-azure-function">Deploy Azure Functions with Azure DevOps YAML Pipelines</a>.</p><h2 id="conclusion">Conclusion</h2><p>This short post showed how to create a Docker container of an Azure Function inside an Azure DevOps YAML pipeline. The Docker image was published to DockerHub and then deployed to an existing Azure Function.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a>, <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/azure-functions/" class="post-tag no-text-decoration" >Azure Functions</a> <a href="/tags/yaml/" class="post-tag no-text-decoration" >YAML</a> <a href="/tags/ci-cd/" class="post-tag no-text-decoration" >CI-CD</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/azure-functions-process-queue-messages/">Use Azure Functions to Process Queue Messages</a><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/deploy-microservices-to-multiple-environments-azure-devops/">Deploy Microservices to multiple Environments using Azure DevOps</a><li><a href="/automatically-version-docker-container/">Automatically Version Docker Containers in Azure DevOps CI</a><li><a href="/design-and-implement-devops/">Design and Implement DevOps</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/deploy-azure-functions-azure-devops-pipelines/"><div class="card-body"> <span class="timeago small" > Apr 26 <i class="unloaded">2021-04-26T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploy Azure Functions with Azure DevOps YAML Pipelines</h3><div class="text-muted small"><p> In my last post, I created an Azure Function that reads messages from an Azure Service Bus Queue and then updates a database. The deployment of the Azure Function was manual using Visual Studio. S...</p></div></div></a></div><div class="card"> <a href="/setup-nginx-ingress-controller-kubernetes/"><div class="card-body"> <span class="timeago small" > May 10 <i class="unloaded">2021-05-10T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Set up Nginx as Ingress Controller in Kubernetes</h3><div class="text-muted small"><p> So far I have used a Service with the type LoadBalancer for my microservices. The service can be set up quickly and also gets a public IP address assign to access the microservice. Besides the load...</p></div></div></a></div><div class="card"> <a href="/configure-custom-urls-to-access-microservices-running-in-kubernetes/"><div class="card-body"> <span class="timeago small" > May 17 <i class="unloaded">2021-05-17T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configure custom URLs to access Microservices running in Kubernetes</h3><div class="text-muted small"><p> In my last post, I created an Nginx Ingress controller and added rules to route to my two microservices. This solution worked but it was far from optimal. First, I had to add routing rules for my m...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/deploy-azure-functions-azure-devops-pipelines/" class="btn btn-outline-primary"><p>Deploy Azure Functions with Azure DevOps YAML Pipelines</p></a> <a href="/setup-nginx-ingress-controller-kubernetes/" class="btn btn-outline-primary"><p>Set up Nginx as Ingress Controller in Kubernetes</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/deploy-docker-container-azure-functions/'; this.page.identifier = '/deploy-docker-container-azure-functions/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
