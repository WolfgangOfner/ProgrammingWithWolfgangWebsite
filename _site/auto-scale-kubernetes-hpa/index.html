<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Auto-scale in Kubernetes using the Horizontal Pod Autoscaler" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="The Horizontal Pod Autoscaler (hpa) can automatically scale your application out and in which helps you to offer a performant application and minimize your costs at the same time." /><meta property="og:description" content="The Horizontal Pod Autoscaler (hpa) can automatically scale your application out and in which helps you to offer a performant application and minimize your costs at the same time." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-15T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Auto-scale in Kubernetes using the Horizontal Pod Autoscaler" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/","description":"The Horizontal Pod Autoscaler (hpa) can automatically scale your application out and in which helps you to offer a performant application and minimize your costs at the same time.","@type":"BlogPosting","headline":"Auto-scale in Kubernetes using the Horizontal Pod Autoscaler","dateModified":"2021-05-19T22:25:07+02:00","datePublished":"2021-02-15T00:00:00+01:00","@context":"https://schema.org"}</script><title>Auto-scale in Kubernetes using the Horizontal Pod Autoscaler | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Auto-scale in Kubernetes using the Horizontal Pod Autoscaler</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Auto-scale in Kubernetes using the Horizontal Pod Autoscaler</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Auto-scale in Kubernetes using the Horizontal Pod Autoscaler</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 15, 2021, 12:00 AM +0100" > Feb 15 <i class="unloaded">2021-02-15T00:00:00+01:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, May 19, 2021, 10:25 PM +0200" > May 19 <i class="unloaded">2021-05-19T22:25:07+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1595 words">18 min</span></div></div><div class="post-content"><p>Running a performant, resilient application in the pre-cloud era was hard. Especially with unpredictable user traffic, it was often necessary to use more hardware than needed, just to make sure the application can handle an increased load. Kubernetes makes our life a lot easier and can automatically scale your application out and in, depending on the usage of your application.</p><p>Today, I will show how to use the Horizontal Pod Autoscaler (hpa) to automatically scale your application out and in which helps you to offer a performant application and minimize your costs at the same time.</p><h2 id="how-the-horizontal-pod-autoscaler-hpa-works">How the Horizontal Pod Autoscaler (HPA) works</h2><p>The Horizontal Pod Autoscaler automatically scales the number of your pods, depending on resource utilization like CPU. For example, if you target a 50% CPU utilization for your pods but your pods have an 80% CPU utilization, the hpa will automatically create new pods. If the CPU utilization falls below 50%, for example, 30%, the hpa terminates pods. This ensures that you always run enough pods to keep your users happy but also helps you to not waste money by running too many pods.</p><p>Besides CPU utilization, you can also use custom metrics to scale. These custom metrics can be, for example, response time, queue length, or hits-per-second. In my last post, <a href="/manage-resources-kubernetes">Manage Resources in Kubernetes</a>, I set resource requests for pods. If you don’t set them, the hpa won’t be able to scale based on CPU utilization.</p><p>In the hpa, you can configure the minimum and maximum amount of pods. This prevents the hpa from creating new pods (until you run out of resources) when your application goes haywire but also ensures a bottom line to guarantee high-availability. The Horizontal Pod Autoscaler checks by default the metrics every 15 seconds. You can configure the interval with the -horizontal-pod-autoscaler-sync-period flag.</p><h2 id="create-a-horizontal-pod-autoscaler">Create a Horizontal Pod Autoscaler</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>In my demo, I am using Helm to deploy my application to Kubernetes. You don’t have to use Helm though and can just apply the yaml file I will create to your Kubernetes cluster.</p><p>To create the Horizontal Pod Autoscaler, create a new yaml file named hpa inside the tempolates folder inside the Helm charts folder and past the following code into the file:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="pi">{{</span><span class="nv">- if .Values.hpa.enabled -</span><span class="pi">}}</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "customerapi.fullname" .</span> <span class="pi">}}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.hpa.maxReplicas</span> <span class="pi">}}</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.hpa.minReplicas</span> <span class="pi">}}</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "customerapi.fullname" .</span> <span class="pi">}}</span>
  <span class="na">targetCPUUtilizationPercentage</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Values.hpa.averageCpuUtilization</span> <span class="pi">}}</span>
<span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
</pre></table></code></div></div><p>This config creates a Horizontal Pod Autoscaler if the hpa.enabled flag is set to true. Then it configures the specification with the maximum and minimum amount of replicas and at the end the target metric. In this example, the target metric is CPU utilization. All values starting with .Values are provided by the values.yaml file. Using the values.yaml file allows you have one file where you can override the configuration of your Helm charts. In my next post, I will show how to use a Tokenizer to apply dynamic values during your deployment.</p><p>If you use the values.yaml file, add the following section:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="na">hpa</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">averageCpuUtilization</span><span class="pi">:</span> <span class="m">50</span>
</pre></table></code></div></div><p>If you don’t use the values file, you can replace the placeholders in the hpa with actual values:</p><p>This value can be configured using the –horizontal-pod-autoscaler-downscale-stabilization flag, which defaults to 5 minutes. This means that scaledowns will occur gradually, smoothing out the impact of rapidly fluctuating metric values.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "customerapi.fullname" .</span> <span class="pi">}}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "customerapi.fullname" .</span> <span class="pi">}}</span>
  <span class="na">targetCPUUtilizationPercentage</span><span class="pi">:</span> <span class="m">50</span>
<span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
</pre></table></code></div></div><p>Note that you should never run only one pod for production applications. I would recommend running at least 3 pods to ensure high-availability.</p><h2 id="deploy-the-horizontal-pod-autoscaler">Deploy the Horizontal Pod Autoscaler</h2><p>Deploy the hpa to your Kubernetes cluster. If you want to learn how to deploy the Helm charts to Kubernetes, check out my post <a href="/deploy-kubernetes-using-helm">Deploy to Kubernetes using Helm Charts</a>. After the deployment is finished, check that the hpa got deployed correctly. You can use kubectl or a dashboard to check if the hpa values are set correctly. For more information about using a dashboard, see my post <a href="/azure-kubernetes-service-getting-started">Azure Kubernetes Service - Getting Started</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-hpa-got-deployed.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-hpa-got-deployed.jpg" alt="The hpa got deployed" /></a><p> The hpa got deployed</p></div><h2 id="load-testing-a-microservice">Load testing a Microservice</h2><p>There are many load testing tools out there. I wrote a super simple one myself and added it to the root of the Github repository inside the AutoscalingDemo folder. The code looks as follows:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">HttpClient</span> <span class="n">Client</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ConcurrentBag</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">MillisecondsElapsed</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span>
    
    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">SendRequest</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">stopwatch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
        <span class="n">stopwatch</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>

        <span class="c1">// replace URL with your URL</span>
        <span class="kt">var</span> <span class="n">stringTask</span> <span class="p">=</span> <span class="n">Client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="s">"http://20.73.220.220/v1/PrimeNumber?nThPrimeNumber=50000"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">await</span> <span class="n">stringTask</span>

        <span class="n">stopwatch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Cyan</span><span class="p">;</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Milliseconds elapsed: </span><span class="p">{</span><span class="n">stopwatch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">Milliseconds</span><span class="p">}</span><span class="s"> to calculate result: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">)</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Green</span><span class="p">;</span>
        <span class="n">MillisecondsElapsed</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">stopwatch</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">Milliseconds</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Average request time: </span><span class="p">{</span><span class="n">MillisecondsElapsed</span><span class="p">.</span><span class="nf">Sum</span><span class="p">()</span> <span class="p">/</span> <span class="n">MillisecondsElapsed</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> milliseconds over </span><span class="p">{</span><span class="n">MillisecondsElapsed</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> requests"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">ResetColor</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">500</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">SendRequest</span><span class="p">);</span>
            <span class="n">thread</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>

            <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The test application creates 500 threads and calls my microservice to calculate a prime number. This is quite CPU heavy and will trigger the hpa to scale out my microservice. If you run this code, replace the string for the GetStringAsync method with your URL.</p><h3 id="load-test-the-microservice-without-auto-scaling">Load test the Microservice without auto-scaling</h3><p>First, I run the load test without the hpa. This means that only one pod processes all requests which should take some time because the pod will run at 100% capacity.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Run-the-load-test-with-one-pod.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Run-the-load-test-with-one-pod.jpg" alt="Run the load test with one pod" /></a><p> Run the load test with one pod</p></div><p>The average response time is 508 milliseconds and when I open the Swagger UI of the microservice, it feels unresponsive.</p><h3 id="load-test-the-microservice-with-auto-scaling-using-the-hpa">Load test the Microservice with auto-scaling using the HPA</h3><p>After deploying the hpa, I run the test again.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Run-the-load-test-with-auto-scaling.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Run-the-load-test-with-auto-scaling.jpg" alt="Run the load test with auto-scaling" /></a><p> Run the load test with auto-scaling</p></div><p>Using the hpa to scale out the microservice decreased the average response time to 198 milliseconds. Also, the Swagger UI feels responsive and usable.</p><h3 id="scaling-using-the-horizontal-pod-autoscaler">Scaling using the Horizontal Pod Autoscaler</h3><p>So far we have seen that the response time during the load time was way better when using a hpa. Let’s check what happened behind the scenes. If you open the hpa in the dashboard, you can see its events. There you can see that the hpa first scaled to four pods and then to seven.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-hpa-scaled-to-seven-pods.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-hpa-scaled-to-seven-pods.jpg" alt="The hpa scaled to seven pods" /></a><p> The hpa scaled to seven pods</p></div><p>When you check the pods of the microservice, you will see that seven pods are running.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Seven-pods-of-the-microservice-are-running.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Seven-pods-of-the-microservice-are-running.jpg" alt="Seven pods of the microservice are running" /></a><p> Seven pods of the microservice are running</p></div><p>After all, requests are processed (and a cooldown phase), the hpa scales in the pods. Since there is no load at all, it scales into only one pod. If you configured the minimum replicas to three, the hpa would scale into three pods.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-hpa-scaled-in-to-one-pod.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-hpa-scaled-in-to-one-pod.jpg" alt="The hpa scaled in to one pod" /></a><p> The hpa scaled in to one pod</p></div><h2 id="more-horizontal-pod-autoscaler-configuration">More Horizontal Pod Autoscaler Configuration</h2><p>The hpa offers a wide range of additional features and configurations. In this section, I will shortly highlight some of them.</p><h3 id="scale-in-delay">Scale in Delay</h3><p>Some workloads are highly variable which would lead to a constant scaling (in or out). To prevent this and have a more stable number of pods, use the –horizontal-pod-autoscaler-downscale-stabilization flag to set a timeframe between scale in operations. The default value is 5 minutes. This means if the hpa scales in, the next scale in can happen in the earliest 5 minutes.</p><h3 id="scaling-policies">Scaling Policies</h3><p>Scaling policies allow you to configure for how long a certain value has to be reached until scaling happens. This could be for example, only scale-out if the CPU utilization is higher than 70% for more than 30 seconds and only scale in if the CPU utilization is below 30% for 30 seconds. The code for this looks as follows:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">behavior</span><span class="pi">:</span>
  <span class="na">scaleDown</span><span class="pi">:</span>
    <span class="na">policies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
      <span class="na">value</span><span class="pi">:</span> <span class="m">30</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
  <span class="na">scaleUp</span><span class="pi">:</span>    
    <span class="na">policies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
      <span class="na">value</span><span class="pi">:</span> <span class="m">70</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
</pre></table></code></div></div><p>Policies can also be used to limit the rate of downscale, for example, only remove 3 pods per minute when scaling down.</p><h3 id="stabilization-window">Stabilization Window</h3><p>The stabilization window restricts the hpa from scaling out or in too frequently. For example, if you set the stabilization window to 3 minutes (180 seconds) the timespan between scaling operations is at least 180 minutes. You can configure the stabilization window for scaling out and in independently. The following code shows a stabilization window for scaling down:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">behavior</span><span class="pi">:</span>
  <span class="na">stabilizationWindowSeconds</span><span class="pi">:</span> <span class="m">180</span>
  <span class="na">scaleDown</span><span class="pi">:</span>
    <span class="na">policies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
      <span class="na">value</span><span class="pi">:</span> <span class="m">30</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="s">30</span>  
</pre></table></code></div></div><h2 id="conclusion">Conclusion</h2><p>The Horizontal Pod Autoscaler allows you to configure automatic scaling. This can be scaling out to increase the throughput and performance of your application or scaling in to reduce the used resources and therefore the costs. Scaling can be performed on simple metrics like CPU utilization or on more complicated metrics like response time or hits per second. Additionally, metrics can be combined.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/devops/'>DevOps</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aks/" class="post-tag no-text-decoration" >AKS</a> <a href="/tags/helm/" class="post-tag no-text-decoration" >Helm</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/yaml/" class="post-tag no-text-decoration" >YAML</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Auto-scale in Kubernetes using the Horizontal Pod Autoscaler - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Auto-scale in Kubernetes using the Horizontal Pod Autoscaler - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Auto-scale in Kubernetes using the Horizontal Pod Autoscaler - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/setup-nginx-ingress-controller-kubernetes/">Set up Nginx as Ingress Controller in Kubernetes</a><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/configure-custom-urls-to-access-microservices-running-in-kubernetes/">Configure custom URLs to access Microservices running in Kubernetes</a><li><a href="/how-to-pass-az-303-and-az-304-certification-exams/">How to pass the AZ-303 and AZ-304 Certification Exams</a><li><a href="/develop-azure-app-service-mobile-app/">Develop Azure App Service Mobile App</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <span class="timeago small" > Dec 2, 2020 <i class="unloaded">2020-12-02T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software engineer on different projects which focus on microservice, DevOps, and process automation. Many of my consulting jobs are about explaining microservice, w...</p></div></div></a></div><div class="card"> <a href="/manage-resources-kubernetes/"><div class="card-body"> <span class="timeago small" > Feb 8 <i class="unloaded">2021-02-08T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Manage Resources in Kubernetes</h3><div class="text-muted small"><p> Kubernetes is a great tool but it also has a steep learning curve. Today, I want to talk about how to limit the resources a container can use and how containers can request a minimum of resources o...</p></div></div></a></div><div class="card"> <a href="/replace-helm-variables-tokenizer/"><div class="card-body"> <span class="timeago small" > Feb 22 <i class="unloaded">2021-02-22T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Replace Helm Chart Variables in your CI/CD Pipeline with Tokenizer</h3><div class="text-muted small"><p> Helm is a great tool to deploy your application into Kubernetes. In my post, Helm - Getting Started, I also mentioned the values.yaml file which can be used to replace variables in the Helm chart. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/manage-resources-kubernetes/" class="btn btn-outline-primary"><p>Manage Resources in Kubernetes</p></a> <a href="/replace-helm-variables-tokenizer/" class="btn btn-outline-primary"><p>Replace Helm Chart Variables in your CI/CD Pipeline with Tokenizer</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/auto-scale-kubernetes-hpa/'; this.page.identifier = '/auto-scale-kubernetes-hpa/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
