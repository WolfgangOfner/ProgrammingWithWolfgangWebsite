<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Use a custom Docker container to deploy Dacpac packages to an SQL Server using a Linux build environment in Azure DevOps." /><meta property="og:description" content="Use a custom Docker container to deploy Dacpac packages to an SQL Server using a Linux build environment in Azure DevOps." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-15T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/","description":"Use a custom Docker container to deploy Dacpac packages to an SQL Server using a Linux build environment in Azure DevOps.","@type":"BlogPosting","headline":"Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps","dateModified":"2021-03-15T00:00:00+01:00","datePublished":"2021-03-15T00:00:00+01:00","@context":"https://schema.org"}</script><title>Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Mar 15, 2021, 12:00 AM +0100" > Mar 15 <i class="unloaded">2021-03-15T00:00:00+01:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1742 words">20 min</span></div></div><div class="post-content"><p>I showed <a href="/automatically-deploy-database-changes">in my last post</a> how to use SSDT to create a dacpac package and how to deploy it locally. The SSDT project uses .NET Framework 4.8 which means that it runs only on Windows. Azure DevOps has a task to deploy dacpac packages, but it also only supports Windows. To be able to use a Linux environment, I will create a .NET Core project to build the dacpac package and build my own Docker container with the sqlpackage installed to deploy the dacpac to an SQL Server.</p><h2 id="use-net-core-to-create-the-dacpac-package">Use .NET Core to create the Dacpac package</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>I have created a new folder in my solution, Database, which contains the SQL project. To build this project in a Linux environment, I add a new .NET Core 3.1 Class Library called CustomerApi.Database.Build. Next, I replace the SDK type with MSBuild.Sdk.SqlProj/1.11.4 and set the SQLServerVersion SqlAzure because I want to deploy it to an Azure SQL database.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">"MSBuild.Sdk.SqlProj/1.11.4"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp3.1<span class="nt">&lt;/TargetFramework&gt;</span>
    <span class="nt">&lt;SqlServerVersion&gt;</span>SqlAzure<span class="nt">&lt;/SqlServerVersion&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</pre></table></code></div></div><p>This references the MSBuild.Sdk.SqlProj project which can be found on <a href="https://github.com/rr-wfm/MSBuild.Sdk.SqlProj/" target="_blank" rel="noopener noreferrer">Github</a>. Unfortunately, this project doesn’t support .NET 5 yet, that’s why I use .NET Core 3.1.</p><h3 id="add-scripts-to-the-deployment-project">Add Scripts to the Deployment Project</h3><p>The created Dacpac package should execute SQL scripts before and after the deployment. To achieve that, I create a folder Scripts which contains two subfolders called, PostScripts and PreScripts. The folders contain the Script.PostDeployment, respectively the Script.PreDeployment script.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/03/Structure-of-the-scripts.jpg"><img loading="lazy" src="/assets/img/posts/2021/03/Structure-of-the-scripts.jpg" alt="Structure of the scripts" /></a><p> Structure of the scripts</p></div><p>These scripts contain all SQL scripts which should be executed. The PostScripts folder contains the 00_AddCustomers script and therefore, I have added it to the Script.PostDeployment file.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>:r ./00_AddCustomers.sql
</pre></table></code></div></div><p>Additionally, I have to add the following code to the .csproj file:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Remove=</span><span class="s">"Scripts\**\*.sql"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;None</span> <span class="na">Include=</span><span class="s">"Scripts\**\*.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;PostDeploy</span> <span class="na">Include=</span><span class="s">".\Scripts\PostScripts\Script.PostDeployment.sql"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PreDeploy</span> <span class="na">Include=</span><span class="s">".\Scripts\PreScripts\Script.PreDeployment.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
</pre></table></code></div></div><p>This code configures the execution of the scripts before and after the deployment.</p><p>Be aware that the scripts are executed every deployment. If your script inserts data, you have to make sure that it checks the data before it inserts it. I am using a merge statement to update existing data or create it if it doesn’t exist. This script looks complicated but is quite simple.</p><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span>

<span class="n">MERGE</span> <span class="k">INTO</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Customer</span><span class="p">]</span> <span class="k">AS</span> <span class="n">Target</span>
<span class="k">USING</span> <span class="p">(</span><span class="k">VALUES</span>
<span class="p">(</span><span class="s1">'9f35b48d-cb87-4783-bfdb-21e36012930a'</span><span class="p">,</span> <span class="s1">'Wolfgang'</span><span class="p">,</span><span class="s1">'Ofner'</span><span class="p">,</span> <span class="s1">'1989-11-23'</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'654b7573-9501-436a-ad36-94c5696ac28f'</span><span class="p">,</span> <span class="s1">'Darth'</span><span class="p">,</span><span class="s1">'Vader'</span><span class="p">,</span> <span class="s1">'1977-05-25'</span><span class="p">,</span> <span class="mi">43</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'971316e1-4966-4426-b1ea-a36c9dde1066'</span><span class="p">,</span> <span class="s1">'Son'</span><span class="p">,</span><span class="s1">'Goku'</span><span class="p">,</span> <span class="s1">'1937-04-16'</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
<span class="p">)</span> <span class="k">AS</span> <span class="k">Source</span> <span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">FirstName</span><span class="p">,</span> <span class="n">LastName</span><span class="p">,</span> <span class="n">Birthday</span><span class="p">,</span> <span class="n">Age</span><span class="p">)</span>
<span class="k">ON</span> <span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
<span class="k">WHEN</span> <span class="n">MATCHED</span> <span class="k">AND</span> <span class="p">(</span>
	<span class="k">NULLIF</span><span class="p">(</span><span class="k">Source</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="k">Source</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="k">Source</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span>
	<span class="k">NULLIF</span><span class="p">(</span><span class="k">Source</span><span class="p">.</span><span class="n">Birthday</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Birthday</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> 
	<span class="k">NULLIF</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Birthday</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">Birthday</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span><span class="k">THEN</span>
 <span class="k">UPDATE</span> <span class="k">SET</span>
  <span class="n">Id</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
  <span class="n">FirstName</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span>
  <span class="n">LastName</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span>
  <span class="n">Birthday</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">Birthday</span><span class="p">,</span>
  <span class="n">Age</span> <span class="o">=</span> <span class="k">Source</span><span class="p">.</span><span class="n">Age</span>
  
<span class="k">WHEN</span> <span class="k">NOT</span> <span class="n">MATCHED</span> <span class="k">BY</span> <span class="n">TARGET</span> <span class="k">THEN</span>
 <span class="k">INSERT</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">FirstName</span><span class="p">,</span> <span class="n">LastName</span><span class="p">,</span> <span class="n">Birthday</span><span class="p">,</span> <span class="n">Age</span><span class="p">)</span>
 <span class="k">VALUES</span><span class="p">(</span><span class="k">Source</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">Birthday</span><span class="p">,</span> <span class="k">Source</span><span class="p">.</span><span class="n">Age</span><span class="p">)</span>
<span class="k">WHEN</span> <span class="k">NOT</span> <span class="n">MATCHED</span> <span class="k">BY</span> <span class="k">SOURCE</span>  <span class="k">THEN</span>
 <span class="k">DELETE</span><span class="p">;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">mergeError</span> <span class="nb">int</span>
 <span class="p">,</span> <span class="o">@</span><span class="n">mergeCount</span> <span class="nb">int</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">mergeError</span> <span class="o">=</span> <span class="o">@@</span><span class="n">ERROR</span><span class="p">,</span> <span class="o">@</span><span class="n">mergeCount</span> <span class="o">=</span> <span class="o">@@</span><span class="n">ROWCOUNT</span>
<span class="n">IF</span> <span class="o">@</span><span class="n">mergeError</span> <span class="o">!=</span> <span class="mi">0</span>
 <span class="k">BEGIN</span>
 <span class="n">PRINT</span> <span class="s1">'ERROR OCCURRED IN MERGE FOR [dbo].[Customer]. Rows affected: '</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">mergeCount</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span> <span class="c1">-- SQL should always return zero rows affected</span>
 <span class="k">END</span>
<span class="k">ELSE</span>
 <span class="k">BEGIN</span>
 <span class="n">PRINT</span> <span class="s1">'[dbo].[Customer] rows affected by MERGE: '</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">mergeCount</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
 <span class="k">END</span>
</pre></table></code></div></div><h3 id="add-tables-to-the-deployment-project">Add Tables to the Deployment Project</h3><p>Lastly, I have to add the tables for my database. You can either add the SQL script in the root folder, or you can reference the SSDT project. Since I am lazy, I reference the SSDT project with the following code in the .csproj file</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Include=</span><span class="s">"..\CustomerApi.Database\dbo\**\*.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
</pre></table></code></div></div><p>This adds the Tables folder with the Customer table to the solution.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/03/Referencing-the-tables.jpg"><img loading="lazy" src="/assets/img/posts/2021/03/Referencing-the-tables.jpg" alt="Referencing the tables" /></a><p> Referencing the tables</p></div><h3 id="finished-project-and-build-problems">Finished Project and Build Problems</h3><p>The finished .csproj file looks as following:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">"MSBuild.Sdk.SqlProj/1.11.4"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp3.1<span class="nt">&lt;/TargetFramework&gt;</span>
    <span class="nt">&lt;SqlServerVersion&gt;</span>SqlAzure<span class="nt">&lt;/SqlServerVersion&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>

  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Include=</span><span class="s">"..\CustomerApi.Database\dbo\**\*.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Remove=</span><span class="s">"Scripts\**\*.sql"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;None</span> <span class="na">Include=</span><span class="s">"Scripts\**\*.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;PostDeploy</span> <span class="na">Include=</span><span class="s">".\Scripts\PostScripts\Script.PostDeployment.sql"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PreDeploy</span> <span class="na">Include=</span><span class="s">".\Scripts\PreScripts\Script.PreDeployment.sql"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

<span class="nt">&lt;/Project&gt;</span>
</pre></table></code></div></div><p>If you get an error building the project, add the following code to the MSBuild.exe.config:</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;assemblyBinding</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dependentAssembly&gt;</span>
    <span class="nt">&lt;assemblyIdentity</span> <span class="na">name=</span><span class="s">"System.Numerics.Vectors"</span> <span class="na">publicKeyToken=</span><span class="s">"b03f5f7f11d50a3a"</span> <span class="na">culture=</span><span class="s">"neutral"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;bindingRedirect</span> <span class="na">oldVersion=</span><span class="s">"0.0.0.0-4.1.3.0"</span> <span class="na">newVersion=</span><span class="s">"4.1.4.0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/dependentAssembly&gt;</span>
<span class="nt">&lt;/assemblyBinding&gt;</span>
</pre></table></code></div></div><p>You can find the file under C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin (The path will vary, depending on your version, e.g. Professional, Enterprise, etc.). This is a known MSBuild bug which exists for around a year already.</p><h2 id="build-the-database-project-in-the-dockerfile-to-create-a-dacpac-package">Build the Database Project in the Dockerfile to create a Dacpac Package</h2><p>After finished the database build project, it is time to include it in Dockerfile so it gets built in the CI/CD pipeline. The Dockerfile is located in the CustomerApi folder and contains already all statements to build the projects and run the tests. First, add a copy statement to copy the project inside the container:</p><div class="language-docker highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">COPY</span><span class="s"> ["CustomerApi.Database.Build/CustomerApi.Database.Build.csproj", "CustomerApi.Database.Build/"]</span>
</pre></table></code></div></div><p>Next, add the following section:</p><div class="language-docker highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> build AS dacpac</span>
<span class="k">ARG</span><span class="s"> BuildId=localhost</span>
<span class="k">LABEL</span><span class="s"> dacpac=${BuildId}</span>
<span class="k">WORKDIR</span><span class="s"> /src</span>
<span class="k">RUN </span>dotnet build <span class="s2">"CustomerApi.Database.Build/CustomerApi.Database.Build.csproj"</span> <span class="nt">-c</span> Release <span class="nt">-o</span> /dacpacs <span class="nt">--no-restore</span>
</pre></table></code></div></div><p>This code creates an intermediate container and labels it so you can access it later. Additionally, it builds the project and generates the dacpac package this way. If you were following this series, then you have seen the same method to collect the test results and code coverage.</p><h3 id="upload-the-dacpac-package">Upload the Dacpac Package</h3><p>After building the Dacpac package, you have to extract it from the Docker container and upload it as build artifact. This is done in the DockerBuildAndPush template which is located under pipelines/templates. Add the following code after the PublishCodeCoverage task:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="o">-</span><span class="w"> </span><span class="n">pwsh:</span><span class="w"> </span><span class="o">|</span><span class="w">
    </span><span class="nv">$id</span><span class="o">=</span><span class="n">docker</span><span class="w"> </span><span class="nx">images</span><span class="w"> </span><span class="nt">--filter</span><span class="w"> </span><span class="s2">"label=dacpac=$"</span><span class="w"> </span><span class="nt">-q</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="w">
    </span><span class="n">docker</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">dacpaccontainer</span><span class="w"> </span><span class="nv">$id</span><span class="w">
    </span><span class="n">docker</span><span class="w"> </span><span class="nx">cp</span><span class="w"> </span><span class="nx">dacpaccontainer:/dacpacs</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Build.ArtifactStagingDirectory</span><span class="p">)</span><span class="n">/dacpacs</span><span class="w">
    </span><span class="nx">docker</span><span class="w"> </span><span class="nx">rm</span><span class="w"> </span><span class="nx">dacpaccontainer</span><span class="w">
  </span><span class="n">displayName:</span><span class="w"> </span><span class="s1">'Copy DACPACs'</span><span class="w">

</span><span class="o">-</span><span class="w"> </span><span class="n">task:</span><span class="w"> </span><span class="nx">PublishBuildArtifacts</span><span class="err">@</span><span class="nx">1</span><span class="w">    
  </span><span class="n">inputs:</span><span class="w">
    </span><span class="nx">PathtoPublish:</span><span class="w"> </span><span class="s1">'$(Build.ArtifactStagingDirectory)/dacpacs'</span><span class="w">
    </span><span class="n">ArtifactName:</span><span class="w"> </span><span class="s1">'dacpacs'</span><span class="w">
  </span><span class="n">condition:</span><span class="w"> </span><span class="nx">and</span><span class="p">(</span><span class="n">succeeded</span><span class="p">(),</span><span class="w"> </span><span class="n">ne</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s1">'Build.Reason'</span><span class="p">],</span><span class="w"> </span><span class="s1">'PullRequest'</span><span class="p">))</span><span class="w">
  </span><span class="n">displayName:</span><span class="w"> </span><span class="s1">'Publish DACPAC'</span><span class="w">
</span></pre></table></code></div></div><p>This code takes a container with the dacpac label and extracts the dacpac file (This is the same as the extraction of the code coverage and test results). Then it uploads (publishes) it for the Azure DevOps agent.</p><h2 id="create-a-linux-container-to-deploy-the-dacpac-package">Create a Linux Container to Deploy the Dacpac package</h2><p>The Azure DevOps team has an open <a href="https://github.com/microsoft/azure-pipelines-tasks/issues/8408" target="_blank" rel="noopener noreferrer">Github</a> issue from 2018 about deploying dacpac on Linux. Unfortunately, we haven’t gotten any news if and when they will implement it. Therefore, I will use a Linux Docker container with sqlpackage installed to deploy the database. The Dockerfile was originally created by a colleague of mine. I have created a new folder, Infrastructure, in the root folder and added the Dockerfile there.</p><div class="language-docker highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/sdk:2.1-stretch</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> unzip <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    wget <span class="nt">-q</span> <span class="nt">-O</span> /opt/sqlpackage.zip https://go.microsoft.com/fwlink/?linkid<span class="o">=</span>2134311 <span class="o">&amp;&amp;</span> unzip <span class="nt">-qq</span> /opt/sqlpackage.zip <span class="nt">-d</span> /opt/sqlpackage <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x /opt/sqlpackage/sqlpackage <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-f</span> /opt/sqlpackage.zip

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> curl gnupg apt-transport-https <span class="o">&amp;&amp;</span> <span class="se">\
</span>    curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - <span class="o">&amp;&amp;</span> <span class="se">\
</span>    sh <span class="nt">-c</span> <span class="s1">'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-debian-stretch-prod stretch main" &gt; /etc/apt/sources.list.d/microsoft.list'</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> powershell
</pre></table></code></div></div><p>I also have uploaded the container to <a href="https://hub.docker.com/repository/docker/wolfgangofner/linuxsqlpackage" target="_blank" rel="noopener noreferrer">Dockerhub</a> and will use it in the CI/CD pipeline.</p><h2 id="deploy-your-database-using-the-dacpac-package">Deploy your Database using the Dacpac Package</h2><p>To deploy the dacpac package to the database, you should use a deployment task in your CI/CD pipeline. This task runs as a container job using the previously mentioned linux container with the sqlpackage installed. This deployment also runs only after the build succeeded and only if the build reason is not a pull request The code for that looks as follows:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">deployment</span><span class="pi">:</span> <span class="s">DeployDatabase</span>
  <span class="na">dependsOn</span><span class="pi">:</span> <span class="s">Build</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">Database'</span>   
  <span class="na">environment</span><span class="pi">:</span> <span class="s">Database</span> 
  <span class="na">container</span><span class="pi">:</span> <span class="s">linuxsqlpackage</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">runOnce</span><span class="pi">:</span>
      <span class="na">deploy</span><span class="pi">:</span>
        <span class="na">steps</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">template</span><span class="pi">:</span> <span class="s">templates/DatabaseDeploy.yml</span>
          <span class="na">parameters</span><span class="pi">:</span>          
              <span class="na">connectionString</span><span class="pi">:</span> <span class="s">$(ConnectionString)</span>
              <span class="na">dacpacPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">$(Agent.BuildDirectory)/dacpacs/$(ArtifactName).Database.Build.dacpac"</span>
</pre></table></code></div></div><p>This deployment executes the DatabaseDeploy template which takes two parameters, connectionString and dacpacPath. The template looks as follows:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="na">parameters</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">blockOnPossibleDataLoss</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">default</span><span class="pi">:</span> <span class="no">false</span> 
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">generateSmartDefaults</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">default</span><span class="pi">:</span> <span class="no">true</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">connectionString</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">default</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dacpacPath</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">default</span><span class="pi">:</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">download</span><span class="pi">:</span> <span class="s">current</span>
    <span class="na">artifact</span><span class="pi">:</span> <span class="s1">'</span><span class="s">dacpacs'</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Download</span><span class="nv"> </span><span class="s">DACPAC'</span>
  <span class="pi">-</span> <span class="na">pwsh</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">/opt/sqlpackage/sqlpackage /a:Publish /p:BlockOnPossibleDataLoss=$ /p:GenerateSmartDefaults=$ /tcs:"$" /sf:"$"    </span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">DACPAC'</span>
</pre></table></code></div></div><p>The deployment downloads the previously published dacpac artifact and the executes a sqlpackage publish with the connection string to the database and the path of the dacpac package.</p><h2 id="testing-the-database-deployment">Testing the Database Deployment</h2><p>I added the database deployment also to the OrderApi. You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>Before you can run the pipelines, you have to replace the SQLServerName variable with your server URL:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="na">SQLServerName</span><span class="pi">:</span> <span class="s">wolfgangmicroservicedemoserver.database.windows.net</span> <span class="c1"># replace with your server url</span>
</pre></table></code></div></div><p>Additionally, you have to add the DbUser and DbPassword variables in the pipeline. You can add the DbUser variable as a normal variable if you want. The DbPassword variable must be added as a secret variable though, otherwise, everyone can see the password.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/03/Add-secret-variables-to-your-pipeline.jpg"><img loading="lazy" src="/assets/img/posts/2021/03/Add-secret-variables-to-your-pipeline.jpg" alt="Add secret variables to your pipeline" /></a><p> Add secret variables to your pipeline</p></div><p>Run both (CustomerAPi and OrderApi) pipelines and you should see both databases deployed on your database server.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/03/Deploying-the-database-in-the-CI-CD-pipeline.jpg"><img loading="lazy" src="/assets/img/posts/2021/03/Deploying-the-database-in-the-CI-CD-pipeline.jpg" alt="Deploying the database in the CI-CD pipeline" /></a><p> Deploying the database in the CI-CD pipeline</p></div><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/03/The-databases-got-deployed-on-the-server.jpg"><img loading="lazy" src="/assets/img/posts/2021/03/The-databases-got-deployed-on-the-server.jpg" alt="The databases got deployed on the server" /></a><p> The databases got deployed on the server</p></div><h2 id="conclusion">Conclusion</h2><p>Dacpac is great to automate the database deployment including schema updates and the execution of scripts. Currently, the deployment is only supported on Windows but with a bit of tweaking, I was able to use .NET Core 3.1 and my own Linux Docker container to build and deploy it using Linux. Setting up everything is a bit of work but after you have done it once, you can easily copy and paste most of it into future projects.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a>, <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/ssdt/" class="post-tag no-text-decoration" >SSDT</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >SQL</a> <a href="/tags/dacpac/" class="post-tag no-text-decoration" >Dacpac</a> <a href="/tags/ci-cd/" class="post-tag no-text-decoration" >CI-CD</a> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Automatically Deploy your Database with Dacpac Packages using Linux and Azure DevOps - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/automatically-version-docker-container/">Automatically Version Docker Containers in Azure DevOps CI</a><li><a href="/deploy-microservices-to-multiple-environments-azure-devops/">Deploy Microservices to multiple Environments using Azure DevOps</a><li><a href="/implement-azure-service-fabric-apps/">Design and Implement Azure Service Fabric apps</a><li><a href="/implement-third-party-paas/">Design and implement third-party PaaS</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/microservice-with-database-kubernetes/"><div class="card-body"> <span class="timeago small" > Mar 22 <i class="unloaded">2021-03-22T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use a Database with a Microservice running in Kubernetes</h3><div class="text-muted small"><p> I showed in my last post how to automatically deploy database changes to your database. In this post, I will extend my microservice to use this database and also extend the deployment to provide a ...</p></div></div></a></div><div class="card"> <a href="/deploy-docker-container-azure-functions/"><div class="card-body"> <span class="timeago small" > May 3 <i class="unloaded">2021-05-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploy a Docker Container to Azure Functions using an Azure DevOps YAML Pipeline</h3><div class="text-muted small"><p> In my last post, I created a YAML pipeline to build and deploy an Azure Function to Azure. Today, I will build the same Azure Function inside a Docker container and deploy the container to Azure. ...</p></div></div></a></div><div class="card"> <a href="/setup-nginx-ingress-controller-kubernetes/"><div class="card-body"> <span class="timeago small" > May 10 <i class="unloaded">2021-05-10T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Set up Nginx as Ingress Controller in Kubernetes</h3><div class="text-muted small"><p> So far I have used a Service with the type LoadBalancer for my microservices. The service can be set up quickly and also gets a public IP address assign to access the microservice. Besides the load...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/automatically-deploy-database-changes/" class="btn btn-outline-primary"><p>Automatically deploy Database Changes with SSDT</p></a> <a href="/microservice-with-database-kubernetes/" class="btn btn-outline-primary"><p>Use a Database with a Microservice running in Kubernetes</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/deploy-dacpac-linux-azure-devops/'; this.page.identifier = '/deploy-dacpac-linux-azure-devops/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
