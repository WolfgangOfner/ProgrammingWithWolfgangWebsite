<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Use Azure Functions to Process Queue Messages" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Azure Functions is a serverless compute offering and lets developers execute code without thinking about the infrastructure it is running on." /><meta property="og:description" content="Azure Functions is a serverless compute offering and lets developers execute code without thinking about the infrastructure it is running on." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-19T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Use Azure Functions to Process Queue Messages" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/","description":"Azure Functions is a serverless compute offering and lets developers execute code without thinking about the infrastructure it is running on.","@type":"BlogPosting","headline":"Use Azure Functions to Process Queue Messages","dateModified":"2021-06-29T18:19:54+02:00","datePublished":"2021-04-19T00:00:00+02:00","@context":"https://schema.org"}</script><title>Use Azure Functions to Process Queue Messages | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Use Azure Functions to Process Queue Messages</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Use Azure Functions to Process Queue Messages</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Use Azure Functions to Process Queue Messages</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 19, 2021, 12:00 AM +0200" > Apr 19 <i class="unloaded">2021-04-19T00:00:00+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 29, 2021, 6:19 PM +0200" > Jun 29 <i class="unloaded">2021-06-29T18:19:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1661 words">19 min</span></div></div><div class="post-content"><p>Azure Functions is a serverless compute offering and lets developers execute code without thinking about the infrastructure it is running on. This helps to efficiently develop event-driven solutions.</p><p>This post will show how to use Azure Functions to read messages from an Azure Service Bus Queue and how to write data to an Azure SQL Database.</p><h2 id="what-are-azure-functions">What are Azure Functions?</h2><p>Azure Functions is a serverless compute platform that allows for quick development without the need to manage the underlying infrastructure. Serverless means that Microsoft abstracts the infrastructure away and fully manages its operation and scaling.</p><p>An Azure Function is usually one method that can be triggered by an event like an HTTP call or a message being placed in a queue. Microsoft offers a wide variety of triggers and programming languages like C#, Java, or Phyton for your function. You can use an App Service Plan which you pay monthly or you can use a Consumption plan and only pay when the function is running.</p><p>Azure Functions are great when you want to execute for background services like processing items on queues but it is not that great when users are waiting for the result because it might take some time to start the function.</p><h2 id="explaining-the-demo-application">Explaining the Demo Application</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>The demo application contains of microservices called OrderApi and CustomerApi. Every time a customer is updated, the CustomerApi places a message with the new information on either a RabbitMQ or Azure Service Bus Queue, depending on its Startup configuration. The OrderApi has a background service that checks the RabbitMQ queue for new messages and then takes these messages to update the customer names in its database.</p><p>The problem with this solution is that every container running in Kubernetes has this background service running. The background service always scales with the OrderAPI, even though it might not be necessary and therefore wastes resources and therefore increases the costs. Additionally, there is no insight into the background service and it would be nice to have some information about the queue processing logic, like how many messages were processed or how many errors happened.</p><p>I want to create an Azure Function to process the queue messages independently from the container running in Kubernetes and then will deactivate the background service entirely (I will leave it in the code in case you want to use it). The Azure Function will receive the queue message, load the orders of this customer, update the customer name and then save the orders in the database.</p><h2 id="create-your-first-azure-function">Create your first Azure Function</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>To create a new Azure Function, start Visual Studio, search for Azure Functions and click Next.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Create-a-new-Azure-Function.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Create-a-new-Azure-Function.jpg" alt="Create a new Azure Function" /></a><p> Create a new Azure Function</p></div><p>Enter a name and then select a trigger. As you can see, The template offers a wide variety of triggers such as HTTP, RabbitMQ, or SignalR. Select Service Bus Queue trigger and on the right side enter a name for the connection string and the queue name.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Configure-the-Function-Trigger.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Configure-the-Function-Trigger.jpg" alt="Configure the Function Trigger" /></a><p> Configure the Function Trigger</p></div><p>Click on Create and your first Azure Function gets created.</p><pre><code class="language-CSharp">public static class OrderNameUpdateFunction
{
    [FunctionName("OrderNameUpdateFunction")]
    public static void Run([ServiceBusTrigger("CustomerQueue", Connection = "YourConnectionString")]string myQueueItem, ILogger log)
    {
        log.LogInformation($"C# ServiceBus queue trigger function processed message: {myQueueItem}");
    }
}
</code></pre><p>In the Azure Portal, go to your Service Bus Namespace and select your CustomerQueue. There select the Shared access policies pane and create a new policy with Listen. After you saved the policy, click on it and you can see the Primary Connection String. If you want to learn how to create an Azure Service Bus Queues and more details about Shared access policies, see my post <a href="/replace-rabbitmq-azure-service-bus-queue">Replace RabbitMQ with Azure Service Bus Queues</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Copy-the-Connection-String-to-your-Azure-Service-Bus-Queue.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Copy-the-Connection-String-to-your-Azure-Service-Bus-Queue.jpg" alt="Copy the Connection String to your Azure Service Bus Queue" /></a><p> Copy the Connection String to your Azure Service Bus Queue</p></div><p>Copy the Primary Connection String and add the following line inside the Values to the local.settings.json file of your Azure Function:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s2">"</span><span class="s">QueueConnectionString"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Your</span><span class="nv"> </span><span class="s">Primary</span><span class="nv"> </span><span class="s">Connection</span><span class="nv"> </span><span class="s">String"</span>
</pre></table></code></div></div><p>Note that there is a problem with the Service Bus SDK and therefore you have to remove the Entity Path at the end of the connection string. In my case the is “EntityPath=customerqueue”. After you removed the EntityPath, set a breakpoint in the function, start the solution and then add something to your queue. As soon as you added a message to the queue, you will hit the breakpoint because the Azure Function was triggered. This confirms that your connection string and trigger are working.</p><h3 id="add-entity-framework-core-to-an-azure-function">Add Entity Framework Core to an Azure Function</h3><p>Install Entity Framework Core 3.1.14 via NuGet or add the following line to your project file:</p><pre><code class="language-XML">&lt;PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="3.1.14" /&gt;
</code></pre><p>Note that Entity Framework Core 5 currently has a dependency that is incompatible with Azure Functions. Azure Functions should be updated to .NET 5 soon. Next, create a new file and add the database context:</p><pre><code class="language-CSharp">public class OrderContext : DbContext
{
    public OrderContext(DbContextOptions&lt;OrderContext&gt; options) : base(options)
    {
    }

    public DbSet&lt;Order&gt; Order { get; set; }
}
</code></pre><p>Then create the Order and UpdateCustomerFullNameModel which you will need to load and update the orders.</p><pre><code class="language-CSharp">public class Order
{
    public Guid Id { get; set; }
    public int OrderState { get; set; }
    public Guid CustomerGuid { get; set; }
    public string CustomerFullName { get; set; }
}
</code></pre><pre><code class="language-CSharp">public class UpdateCustomerFullNameModel
{
    public Guid Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
}
</code></pre><p>Lastly, add the following line inside the Values section of the local.settings.json file to configure the connection string:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s2">"</span><span class="s">DatabaseConnectionString"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;YourDatabaseConnectionString&gt;"</span>
</pre></table></code></div></div><p>Replace <YourDatabaseConnectionString> with your connection string and you are good to go. Now let's set up dependency injection and inject the database context into the function.</YourDatabaseConnectionString></p><h3 id="add-dependency-injection-to-an-azure-function">Add Dependency Injection to an Azure Function</h3><p>To add dependency injection to an Azure Function, install the Microsoft.Azure.Functions.Extensions NuGet package. Then create a new class, called Startup with the following code:</p><pre><code class="language-CSharp">[assembly: FunctionsStartup(typeof(Startup))]

namespace OrderApi.Messaging.Receive
{
    class Startup : FunctionsStartup
    {
        public override void Configure(IFunctionsHostBuilder builder)
        {
            var connectionString = Environment.GetEnvironmentVariable("DatabaseConnectionString");
            builder.Services.AddDbContext&lt;OrderContext&gt;(options =&gt; options.UseSqlServer(connectionString));
        }
    }
}
</code></pre><p>This code reads the connection string from the settings file and adds it to the database context. Now you can use constructor injection to inject the database context into your function. The whole code for the function looks as follows:</p><pre><code class="language-CSharp">namespace OrderApi.Messaging.Receive
{
    public class OrderNameUpdateFunction
    {
        private readonly OrderContext _orderContext;

        public OrderNameUpdateFunction(OrderContext orderContext)
        {
            _orderContext = orderContext;
        }

        [FunctionName("OrderNameUpdateFunction")]
        public void Run([ServiceBusTrigger("CustomerQueue", Connection = "QueueConnectionString")] string queueItem, MessageReceiver messageReceiver, string locktoken)
        {
            try
            {
                var updateCustomerFullNameModel = JsonConvert.DeserializeObject&lt;UpdateCustomerFullNameModel&gt;(queueItem);

                var ordersToUpdate = _orderContext.Order.Where(x =&gt; x.CustomerGuid == updateCustomerFullNameModel.Id).ToList();

                if (ordersToUpdate.Any())
                {
                    foreach (var order in ordersToUpdate)
                    {
                        order.CustomerFullName = $"{updateCustomerFullNameModel.FirstName} {updateCustomerFullNameModel.LastName}";
                    }

                    _orderContext.Order.UpdateRange(ordersToUpdate);
                    _orderContext.SaveChanges();
                }
                else
                {
                    messageReceiver.DeadLetterAsync(locktoken);
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                messageReceiver.DeadLetterAsync(locktoken);
            }
        }
    }
}
</code></pre><p>The function deserializes the message into an UpdateCustomerFullNameModel object, then searches for all orders with the customer id from the deserialized object and updates all names. If something goes wrong, messageReceiver.DeadLetterAsync(locktoken) places the message in a dead letter queue. To use DeadLetterAsync() you have to install the Microsoft.Azure.WebJobs.Extensions.ServiceBus NuGet package.</p><h2 id="deploy-the-code-to-azure-functions">Deploy the Code to Azure Functions</h2><p>To publish your code, right-click the project and select Publish. This opens a new window where you select Azure and click Next.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Publish-the-Azure-Function-to-Azure.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Publish-the-Azure-Function-to-Azure.jpg" alt="Publish the Azure Function to Azure" /></a><p> Publish the Azure Function to Azure</p></div><p>On the next window, select the environment you want to use. Note that Windows has more options for editing the function in the Azure Portal but for this demo it doesn’t matter if you use Windows or Linux.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Deploy-the-Function-to-Linux.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Deploy-the-Function-to-Linux.jpg" alt="Deploy the Function to Linux" /></a><p> Deploy the Function to Linux</p></div><p>Next, provide a name, subscription, resource group, plan, and location for the new Azure Function.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Provide-basic-settings.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Provide-basic-settings.jpg" alt="Provide basic settings" /></a><p> Provide basic settings</p></div><p>After providing the settings, click on Finish and the publish profile will be created. Before you publish the function, you have to provide the connection string to the database and Service Bus Queue. On the right side, click on the three dots and then select Manage Azure App Service settings. This opens a new window with all Application settings. You can either copy the local values for the connection strings or paste the desired values in the text boxes.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Configure-the-remote-Connection-Strings.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Configure-the-remote-Connection-Strings.jpg" alt="Configure the remote Connection Strings" /></a><p> Configure the remote Connection Strings</p></div><p>Note to keep your connection strings secret and never check them into source control.</p><p>After inserting the connection strings, publish the Azure Function.</p><h2 id="testing-the-azure-function">Testing the Azure Function</h2><p>Open the CustomerAPI solution, add your database and queue connection strings in the appsettings file and start the application. In the Swagger UI update an existing user with the PUT operation.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Update-an-existing-customer.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/Update-an-existing-customer.jpg" alt="Update an existing Customer" /></a><p> Update an existing Customer</p></div><p>Updating the customer will also create a message on the Azure Service Bus Queue. For more information about the Azure Service Bus Queue, see my post <a href="/replace-rabbitmq-azure-service-bus-queue">Replace RabbitMQ with Azure Service Bus Queues</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/The-Customer-was-added-to-the-Service-Bus-Queue.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/The-Customer-was-added-to-the-Service-Bus-Queue.jpg" alt="The Customer was added to the Service Bus Queue" /></a><p> The Customer was added to the Service Bus Queue</p></div><p>Note you might not see the message if your Azure Function is already running because the message might be already processed. Open your Azure Function in the Azure Portal and on the Overview page, you can see that the function was executed once.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/The-Azure-Function-was-executed-once.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/The-Azure-Function-was-executed-once.jpg" alt="The Azure Function was executed once" /></a><p> The Azure Function was executed once</p></div><p>To make sure everything worked you can either check the Service Bus Queue to see that there is no message left or in the DeadLetter Queue or you can check the changed value in the database.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/No-message-in-the-DeadLetter-Queue.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/No-message-in-the-DeadLetter-Queue.jpg" alt="No message in the DeadLetter Queue" /></a><p> No message in the DeadLetter Queue</p></div><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/The-Customer-Name-got-updated.jpg"><img loading="lazy" src="/assets/img/posts/2021/04/The-Customer-Name-got-updated.jpg" alt="The Customer Name got updated" /></a><p> The Customer Name got updated</p></div><h2 id="conclusion">Conclusion</h2><p>Azure Functions is a great tool to implement event-driven solutions without worrying about the underlying infrastructure. You only pay when your function runs if you select the Consumption plan and can connect a wide variety of different services like RabbitMQ, Azure Event Hub, or Azure Service Bus Queues.</p><p>This post showed how to deploy an Azure Function from Visual Studio. In my next post, I will show you how to create a CI/CD pipeline in Azure DevOps to automate the deployment.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/azure-service-bus/" class="post-tag no-text-decoration" >Azure Service Bus</a> <a href="/tags/azure-functions/" class="post-tag no-text-decoration" >Azure Functions</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Use Azure Functions to Process Queue Messages - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Use Azure Functions to Process Queue Messages - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Use Azure Functions to Process Queue Messages - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/azure-functions-process-queue-messages/">Use Azure Functions to Process Queue Messages</a><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/deploy-microservices-to-multiple-environments-azure-devops/">Deploy Microservices to multiple Environments using Azure DevOps</a><li><a href="/automatically-version-docker-container/">Automatically Version Docker Containers in Azure DevOps CI</a><li><a href="/design-and-implement-devops/">Design and Implement DevOps</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/deploy-azure-functions-azure-devops-pipelines/"><div class="card-body"> <span class="timeago small" > Apr 26 <i class="unloaded">2021-04-26T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploy Azure Functions with Azure DevOps YAML Pipelines</h3><div class="text-muted small"><p> In my last post, I created an Azure Function that reads messages from an Azure Service Bus Queue and then updates a database. The deployment of the Azure Function was manual using Visual Studio. S...</p></div></div></a></div><div class="card"> <a href="/how-to-pass-az-303-and-az-304-certification-exams/"><div class="card-body"> <span class="timeago small" > May 24 <i class="unloaded">2021-05-24T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to pass the AZ-303 and AZ-304 Certification Exams</h3><div class="text-muted small"><p> Two weeks ago, I passed the AZ-304 exam and today I passed the AZ-303 exam giving me the Azure Solutions Architect Expert certification. This post will give you an overview of the exams what metho...</p></div></div></a></div><div class="card"> <a href="/free-website-hosting-with-azure/"><div class="card-body"> <span class="timeago small" > Jun 7, 2020 <i class="unloaded">2020-06-07T22:53:43+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Free Website Hosting with Azure</h3><div class="text-muted small"><p> Last week, I talked about hosting your static website with Azure Static Web Apps. Today, I will extend this example using a free Cosmos DB for the website data and Azure Functions to retrieve them....</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/replace-rabbitmq-azure-service-bus-queue/" class="btn btn-outline-primary"><p>Replace RabbitMQ with Azure Service Bus Queues</p></a> <a href="/deploy-azure-functions-azure-devops-pipelines/" class="btn btn-outline-primary"><p>Deploy Azure Functions with Azure DevOps YAML Pipelines</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/azure-functions-process-queue-messages/'; this.page.identifier = '/azure-functions-process-queue-messages/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
