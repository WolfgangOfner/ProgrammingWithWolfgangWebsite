<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Analyze Software Architecture with NDepend" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="A part of my job as a software consultant is to analyze existing software to find room for improvement to make the software better or to avoid these mistakes if the software is rewritten soon. The focus areas of your analysis vary depending on the requirements and there are also many good tools out there to help you. Today, I will give a high-level overview of how I approach the analysis of a software project using NDepend. NDepend NDepend is a tool for .NET developers that gives deep insight into the codebase. The tool can be installed as a Visual Studio extension and analyzes your code and then gives you different graphs and dashboards to dig deeper into found issues. NDepend comes with a lot of pre-configured rules to analyze the code. These rules can be easily modified or extended to fit your needs. For this post, I will stick with the default rules Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion. Install NDepend You can download a 14 day trial version from the NDepend website. After your download is finished, extract the zip file and run the installer. This will install the Visual Studio extension. Unfortunately, you have to keep this folder. If you delete it, the extension won’t work anymore. Also if you use Visual Studio to install the extension, you only get redirected to the download page. I would like it better if I could install the Visual Studio extension and don’t have to keep the folder. Analyze a .NET Core Software Project If you are a reader of my blog, you know that I am a big fan of microservices. One big advantage of them is that they are small and simple. “Unfortunately” they are not great to showcase an analysis tool because there is not much to analyze. Instead, I will use the open-source NopCommerce. You can download the project from Github. Unpack the zip file and then open the solution which is inside the src folder. Create a new NDepend project Before you can create an NDepend project to analyze the solution, you have to build it. After the build is finished (it might take quite some time) go to Extensions –&gt; NDepend and select Attach New NDepend Project to Current VS Solution. Create a new NDepend project This opens a new window where you can select the solution file you want to analyze. By default, the Nopcommerce solution file should already be selected. There you can also see all selected dlls. NDepend analyzes dlls rather than the solution file. That’s the reason why you have to build the solution before you can analyze it. Select the solution file Click on Analyze 22 .NET Assemblies and NDepend will analyze them and then create a dashboard with its findings. The NDepend Dashboard The dashboard might look quite overwhelming at first but it is quite simple. One thing I don’t like is that you have to add the code coverage results after the dashboard is created and then run the whole analysis process again. It would be nice if you could add the code coverage results before analyzing the project the first time. To add a code coverage you have to create it first. In Visual Studio select Test –&gt; Analyze Code Coverage for all Tests (or the shortcut CRTL+U. CRTL+K). This runs all tests and then adds the Code Coverage Results panel. There you can export the results. In the NDepend dashboard click on the code coverage and then select the previously exported file. Run the NDepend code analysis again and you should see the code coverage in the dashboard. The NDepend dashboard The dashboard gives you a nice overview of the project so you know what you are getting into. For example, you can see that the solution has 78755 lines of code but only 7.56% code coverage. This is already a very bad sign. The technical debt is displayed as 38.16% which equals to 856 days of work according to NDepend. I don’t know how NDepend comes up with this estimation but it gives you a good overview that the code of NopCommerce is probably in pretty bad shape. A nice feature of the dashboard is that you can basically click everywhere to get more information. For example, click on the issues and you will get a list of all the issues with an explanation of what’s wrong there. It also navigates you directly to the corresponding class or method. The graphs of the dashboard are more or less empty at the moment because they show the changes over time. I think this is a nice feature. Even if the technical debt is not too accurate, its trend still might be useful. For example, if you are at the beginning of a sprint at 30% and at the end of the sprint at 36%, you can see that you probably created a lot of technical debt and should plan some time soon to fix it. Analyze Dependencies between DLLs When you start analyzing an already existing project, it is always hard to get started and to figure out which projects are the center of the solution. NDepend helps you here with an interactive Dependency Graph. You can open it via Extensions –&gt; NDepend –&gt; Dependency Graph. The dependency graph NopCommerce is a big solution but on the graph, you can see that it looks like that the solution is separated into three parts and the core parts are on the right of the graph containing dlls like Nop.Web and Nop.Core. Now that you have a starting point, you can dig deeper into the important dlls. For example, Nop.Web.Framework. You can easily zoom in with your mouse and see all dependencies inside this project. If you click on a namespace, for example, Nop.Web.Framework.Mvc, it gets highlighted in orange and shows you all calls to other namespaces and where it is used. This shows that the namespace is the core of the whole dll. Dependencies of a namespace You can learn a lot about the solution with the Dependency Graph even before you saw a line of code. Cyclomatic Complexity The cyclomatic complexity is a metric that is used to indicate the complexity of code. It measures every available path through a method or class. For example, the following method has a cyclomatic complexity of 2 because there are two available paths. 1 2 3 4 5 6 7 8 9 10 11 public string SoSomething(int i = 0) { if (i == 0) { return &quot;zero&quot;; } else { return &quot;not zero&quot;; } } A rule of thumb is that a method should not have a cyclomatic complexity of more than 7. More than 7 means that the code is too complicated to efficiently understand and change. NDepend gives you a graphical overview of all namespaces and their cyclomatic complexity. Click on Extensions –&gt; NDepend –&gt; Code Metrics. There you can select the level, for example, method or namespace, and what you want to display. Select Cyclomatic Complexity and then Top 10. This highlights the 10 methods with the highest complexity. Code metrics overview I am not a big fan of the optical presentation but it can give you a starting point to look into the most complex methods. The list of the top 10 methods is way more useful to me. You can find it on the right when you use the Code Metrics or you can click on Method Complexity on the dashboard- Cyclomatic complexity top 10 The list tells you the Namespace, class, and method and its cyclomatic complexity. Even before looking into the code, you can see that it’s terrible because the complexity is in the hundreds. Remember, the rule of thumb says not more than 7 and then you see 123 or even 253 here. This is going to be a problem if developers have to touch this code. Technical Debt Technical debt describes the impact of the cost of additional work when you choose to implement a feature as fast as possible instead of taking a better approach. The more technical debt you acquire, the harder it will be to implement new features. That is the reason why projects which are 3-5 year olds see a drastic increase in time needed per feature. Let’s look at a real-life example. Instead of saving 20 years for a house, you take the shortcut and get a mortgage from the bank. You have to repay the debt with interest over the next 20 years. If you don’t repay the debt, it will increase due to the interest until you are unable to repay the mortgage and the bank will take your house. The same principle applies in software. If you always take shortcuts, the debt will increase until it’s too much and it will be almost impossible to implement new features because you introduce too many new features or have to change too much code. The NDepend dashboard shows the technical debt percentage, gives a rating, and estimates how much work you would need to invest to fix this debt. The NDepend dashboard AS you can see NDepend calculated the technical debt with 38.16%, gave the rating D, and estimates that it will take 856 days, or 3 years to fix it. No technical debt is not the goal and even if these 856 are estimated too high, it gives you an idea about the condition of the solution. With the complex dependencies, the missing code coverage combined with the technical debt, I can say that the NopCommerce solution is in pretty bad shape, even before looking at the code itself. NDepend aims at pointing out problems but also at helping you to resolve them. If you click on debt on the dashboard, you can see all issues listed on the right side. Overview of the technical debt By default it’s sorted by the time it takes to fix the issues but if you quickly go through the list, it gives you another indication about the bad state of the solution. You see a lot of code should be tested, method too big, too many parameters, type too big, too many fields, and so on. This all indicates that the methods and objects are very big and complex. Therefore they are hard to test or extend. Analyze the Software Architecture So far, I used NDepend to get an overview of all the problems and get an indication that the NopCommerce solution is in a pretty bad state. But even if NDepend said that everything is good, the condition could be really bad. In this section, I want to show you a couple of fast indications to get a first opinion of the state of the project. Test Quality Code coverage only tells you a part of the story, 7.56% like in NopCommerce is way too low though. Even if you have a high code coverage, you could have bad tests or are missing the edge cases of methods. Let’s have a look at the following method and its test. 1 2 3 4 5 6 7 8 9 10 11 public int Divide(int firstNumber, int secondNumber) { return firstNumber / secondNumber; } [Fact] public void Divide_DividesTwoInts_ShouldReturnResult() { var result= _testee.Divide(10, result.Should().Be(2); } This results in 100% code coverage. But if you think about the code, you will quickly see some flaws. If the second parameter is 0, you try to divide by 0 which is not allowed, and end in an exception. This means even with your 100% code coverage, your code produces an exception. Another problem you might see is that the result of the division is an integer. This means that the result is rounded and might lead to unexpected results, besides that it is very inaccurate. Test Quality in NopCommerce As you have seen in the section above, the code coverage gives you the first indication but you always should look at the tests themselves to classify their quality. NopCommerce has a code coverage of merely 7.56% but let’s have a look at the quality of the existing tests. Since we have an ASP.NET Core MVC project, let’s check the tests of the controllers first. Unfortunately, there is only one test and as you can see on the following code sample, even this test is useless and doesn’t help at all. 1 2 3 4 5 6 7 8 [TestFixture] public class CategoryControllerTests : Nop.Tests.TestsBase { public override void SetUp() { base.SetUp(); } } If you look through the tests, you will find a couple of tests for validators, automapper config, and models. Most of the tests are useless, for example, creating an object and then checking if the properties you set are still the same value. These tests only help you to get your code coverage percentage up but it doesn’t help the business running good software. Missing tests might indicate a problem with the architecture and/or too complicated classes which makes them untestable. Analyze the Project Structure After checking the lack of tests and the previously discovered complexity of too big classes, methods, and so on, I want to check if that’s the case. To do that I will start at the controllers and then go from layer to layer. I would expect a three-tier architecture where the controller takes a request and then calls a service. The service contains all the business logic and calls a repository. This repository handles all database operations. There could be more layers like a domain layer or a shared code library but this shouldn’t change too much. Since NopCommerce is an e-commerce shop, I guess that products, customers, and orders should be one of the main controllers. When you open the ProductController or the OrderController you will see that they have 3403 respectively 2826 lines of code. That is way too many! The constructor of the ProductController looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 public ProductController(IAclService aclService, IBackInStockSubscriptionService backInStockSubscriptionService, ICategoryService categoryService, ICopyProductService copyProductService, ICustomerActivityService customerActivityService, ICustomerService customerService, IDiscountService discountService, IDownloadService downloadService, IExportManager exportManager, IImportManager importManager, ILanguageService languageService, ILocalizationService localizationService, ILocalizedEntityService localizedEntityService, IManufacturerService manufacturerService, INopFileProvider fileProvider, INotificationService notificationService, IPdfService pdfService, IPermissionService permissionService, IPictureService pictureService, IProductAttributeParser productAttributeParser, IProductAttributeService productAttributeService, IProductModelFactory productModelFactory, IProductService productService, IProductTagService productTagService, ISettingService settingService, IShippingService shippingService, IShoppingCartService shoppingCartService, ISpecificationAttributeService specificationAttributeService, IStoreContext storeContext, IUrlRecordService urlRecordService, IWorkContext workContext, VendorSettings vendorSettings) { _aclService = aclService; _backInStockSubscriptionService = backInStockSubscriptionService; _categoryService = categoryService; _copyProductService = copyProductService; _customerActivityService = customerActivityService; _customerService = customerService; _discountService = discountService; _downloadService = downloadService; _exportManager = exportManager; _importManager = importManager; _languageService = languageService; _localizationService = localizationService; _localizedEntityService = localizedEntityService; _manufacturerService = manufacturerService; _fileProvider = fileProvider; _notificationService = notificationService; _pdfService = pdfService; _permissionService = permissionService; _pictureService = pictureService; _productAttributeParser = productAttributeParser; _productAttributeService = productAttributeService; _productModelFactory = productModelFactory; _productService = productService; _productTagService = productTagService; _settingService = settingService; _shippingService = shippingService; _shoppingCartService = shoppingCartService; _specificationAttributeService = specificationAttributeService; _storeContext = storeContext; _urlRecordService = urlRecordService; _workContext = workContext; _vendorSettings = vendorSettings; } There are a couple of important principles in software development. My favorite is the Single Responsible Principle (SRP) and Keep it simple stupid (KISS). If you see a constructor like this you already know that this class does more than one thing and is not simple at all. A massive constructor like this makes it also almost impossible to test because you have to fake every parameter before you can even start writing your first test. Complexity of methods In the previous section, I analyzed that the controllers are way too complicated. In this section, I will look into a method and try to find the service and repository layer (if they exist) and analyze their complexity. An online store needs products and without knowing anything about online shops, I would guess that this is a simple operation and therefore the method should be simple. Unfortunately, that’s not the case in NopCommerce. NDepend analyzed a cyclomatic complexity of 53 which is way higher than the maximum recommended 7. The method has almost 200 lines of code and looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 [HttpPost, ParameterBasedOnFormName(&quot;save-continue&quot;, &quot;continueEditing&quot;)] [FormValueRequired(&quot;save&quot;, &quot;save-continue&quot;)] public virtual IActionResult Create(CustomerModel model, bool continueEditing, IFormCollection form) { if (!_permissionService.Authorize(StandardPermissionProvider.ManageCustomers)) return AccessDeniedView if (!string.IsNullOrWhiteSpace(model.Email) &amp;&amp; _customerService.GetCustomerByEmail(model.Email) != null) ModelState.AddModelError(string.Empty, &quot;Email is already registered&quot;); if (!string.IsNullOrWhiteSpace(model.Username) &amp;&amp; _customerSettings.UsernamesEnabled &amp;&amp; _customerService.GetCustomerByUsername(model.Username) != null) { ModelState.AddModelError(string.Empty, &quot;Username is already registered&quot;); //validate customer roles var allCustomerRoles = _customerService.GetAllCustomerRoles(true); var newCustomerRoles = new List&lt;CustomerRole&gt;(); foreach (var customerRole in allCustomerRoles) if (model.SelectedCustomerRoleIds.Contains(customerRole.Id)) newCustomerRoles.Add(customerRole); var customerRolesError = ValidateCustomerRoles(newCustomerRoles, new List&lt;CustomerRole&gt;()); if (!string.IsNullOrEmpty(customerRolesError)) { ModelState.AddModelError(string.Empty, customerRolesError); _notificationService.ErrorNotification(customerRolesError); // Ensure that valid email address is entered if Registered role is checked to avoid registered customers with empty email address if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null &amp;&amp; !CommonHelper.IsValidEmail(model.Email)) { ModelState.AddModelError(string.Empty, _localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot; _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot;)); //custom customer attributes var customerAttributesXml = ParseCustomCustomerAttributes(form); if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null) { var customerAttributeWarnings = _customerAttributeParser.GetAttributeWarnings(customerAttributesXml); foreach (var error in customerAttributeWarnings) { ModelState.AddModelError(string.Empty, error); } if (ModelState.IsValid) { //fill entity from model var customer = model.ToEntity&lt;Customer&gt; customer.CustomerGuid = Guid.NewGuid(); customer.CreatedOnUtc = DateTime.UtcNow; customer.LastActivityDateUtc = DateTime.UtcNow; customer.RegisteredInStoreId = _storeContext.CurrentStore. _customerService.InsertCustomer(custome //form fields if (_dateTimeSettings.AllowCustomersToSetTimeZone) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.TimeZoneIdAttribute, model.TimeZoneId); if (_customerSettings.GenderEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.GenderAttribute, model.Gender); if (_customerSettings.FirstNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FirstNameAttribute, model.FirstName); if (_customerSettings.LastNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.LastNameAttribute, model.LastName); if (_customerSettings.DateOfBirthEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.DateOfBirthAttribute, model.DateOfBirth); if (_customerSettings.CompanyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CompanyAttribute, model.Company); if (_customerSettings.StreetAddressEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddressAttribute, model.StreetAddress); if (_customerSettings.StreetAddress2Enabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddress2Attribute, model.StreetAddress2); if (_customerSettings.ZipPostalCodeEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.ZipPostalCodeAttribute, model.ZipPostalCode); if (_customerSettings.CityEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CityAttribute, model.City); if (_customerSettings.CountyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountyAttribute, model.County); if (_customerSettings.CountryEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountryIdAttribute, model.CountryId); if (_customerSettings.CountryEnabled &amp;&amp; _customerSettings.StateProvinceEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StateProvinceIdAttribute, model.StateProvinceId); if (_customerSettings.PhoneEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.PhoneAttribute, model.Phone); if (_customerSettings.FaxEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FaxAttribute, model.Fa //custom customer attributes _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CustomCustomerAttributes, customerAttributesXm //newsletter subscriptions if (!string.IsNullOrEmpty(customer.Email)) { var allStores = _storeService.GetAllStores(); foreach (var store in allStores) { var newsletterSubscription = _newsLetterSubscriptionService .GetNewsLetterSubscriptionByEmailAndStoreId(customer.Email, store.Id); if (model.SelectedNewsletterSubscriptionStoreIds != null &amp;&amp; model.SelectedNewsletterSubscriptionStoreIds.Contains(store.Id)) { //subscribed if (newsletterSubscription == null) { _newsLetterSubscriptionService.InsertNewsLetterSubscription(new NewsLetterSubscription { NewsLetterSubscriptionGuid = Guid.NewGuid(), Email = customer.Email, Active = true, StoreId = store.Id, CreatedOnUtc = DateTime.UtcNow }); } } else { //not subscribed if (newsletterSubscription != null) { _newsLetterSubscriptionService.DeleteNewsLetterSubscription(newsletterSubscription); } } } //password if (!string.IsNullOrWhiteSpace(model.Password)) { var changePassRequest = new ChangePasswordRequest(model.Email, false, _customerSettings.DefaultPasswordFormat, model.Password); var changePassResult = _customerRegistrationService.ChangePassword(changePassRequest); if (!changePassResult.Success) { foreach (var changePassError in changePassResult.Errors) _notificationService.ErrorNotification(changePassError); } //customer roles foreach (var customerRole in newCustomerRoles) { //ensure that the current customer cannot add to &quot;Administrators&quot; system role if he&#39;s not an admin himself if (customerRole.SystemName == NopCustomerDefaults.AdministratorsRoleName &amp;&amp; !_customerService.IsAdmin(_workContext.CurrentCustomer)) contin _customerService.AddCustomerRoleMapping(new CustomerCustomerRoleMapping { CustomerId = customer.Id, CustomerRoleId = customerRole.Id }); _customerService.UpdateCustomer(custome //ensure that a customer with a vendor associated is not in &quot;Administrators&quot; role //otherwise, he won&#39;t have access to other functionality in admin area if (_customerService.IsAdmin(customer) &amp;&amp; customer.VendorId &gt; 0) { customer.VendorId = 0; _customerService.UpdateCustomer(custome _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.AdminCouldNotbeVendor&quot;)); //ensure that a customer in the Vendors role has a vendor account associated. //otherwise, he will have access to ALL products if (_customerService.IsVendor(customer) &amp;&amp; customer.VendorId == 0) { var vendorRole = _customerService.GetCustomerRoleBySystemName(NopCustomerDefaults.VendorsRoleName); _customerService.RemoveCustomerRoleMapping(customer, vendorRol _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.CannotBeInVendoRoleWithoutVendorAssociated&quot;)); //activity log _customerActivityService.InsertActivity(&quot;AddNewCustomer&quot;, string.Format(_localizationService.GetResource(&quot;ActivityLog.AddNewCustomer&quot;), customer.Id), customer); _notificationService.SuccessNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.Added&quot; if (!continueEditing) return RedirectToAction(&quot;List&quot;); return RedirectToAction(&quot;Edit&quot;, new { id = customer.Id }); //prepare model model = _customerModelFactory.PrepareCustomerModel(model, null, tru //if we got this far, something failed, redisplay form return View(model); } A controller should only take the request and then call services that handle the business logic. From a first glimpse, it looks like the controller does all the business logic already. This would also mean that you can’t reuse the code to create a product because it is in the controller and not in a service class. Additionally, the controller does way more than creating a product that violates the Single Responsible Principle. Due to its insanely high complexity, it is also almost impossible to write adequate tests for the code. Previously, I said that I will dive down the different layers but after seeing the controller I feel like I have seen enough to give a first verdict. Code Reusability and APIs Code reusability is an important factor when it comes to development speed and maintenance costs in the future. I like microservices and one feature of them is that they have many APIs which allow code to be shared easily. Let’s look at the following use case: you have your NopCommerce online shop and then get the task to develop a mobile app for your store. With a modern microservice architecture, you only have to build the mobile app which then calls all your APIs to load data or create orders. This should be done fairly quickly. What about our existing NopCommerce solution? As far as I have seen there are no APIs in the whole solution and as previously mentioned, all the business logic is in the controller. This means that it is not even possible to create a shared library of the service layer to share the code with the mobile app. While looking over the controller methods, I also saw that security checks like if the user has the right role are done in each controller method. Additionally, these checks read certain cookie values that are tied to the online shop and won’t be available in your mobile app. I have spent maybe half an hour in the code but can already tell you that it’s not possible to reuse the code without a lot of unnecessary extra work. Last Thoughts on Analyzing Software Architecture You can analyze the software architecture of a project with many goals in mind. It totally depends on the requirements of your analyzes. For example, if you should find out why software is running slowly, you would use a profiler or some measurement tools to find out which parts of your software are running slow. Then you can focus on these areas to improve the performance. Another aspect of analyzing a software project could be the deployment process. I haven’t talked about this at all but in a modern DevOps culture, all changes should be automatically tested and deployed (either after a change is committed or at the end of a sprint) and also should be reviewed before it gets merged in your master branch. Analyzing this process could span the build and deployment pipeline, what technologies are used, for example, Docker, and go even as far as analyzing how running the software works. For example, if you run it in Kubernetes with auto-scaling or if your application just crashes when it’s out of resources. Even if it’s not directly analyzing the software architecture, it makes sense to look at the planned and recently finished features. If there are only new features and no refactoring tasks and if the features took quite some time, you can already guess that the software is in a bad shape. Here it is also your job as a consultant or architect to intervene and try to convince the product owner/manager to spend more time refactoring. Conclusion This post gave you a high-level overview of how you can get started when analyzing the architecture of a software project. Look out for untestable code because this is often an indication of too complex code or a bad software architecture and keep software principles like the Single Responsible Principle, Separation of Concerns, and KISS in mind. Use tools to get a starting point and then start there to dive into the solution in more detail. I used NDepend to analyze the NopCommerce solution and get an overview of its state. If this post sounded like bashing NopCommerce, this was not my intention. I used it because I wanted to show you a realistic piece of software and pointed out my findings. If they were all great I would have mentioned that too. Unfortunately, the negative ones totally outranked the good ones. I hope NDepend improves the installation process in the future so you can install it as an extension in Visual Studio without downloading and keeping the NDepend folder somewhere on your computer. NDepend was easy to use and give me a great overview of the state of the project and provided useful links to dive into the pain points of the solution. For example, I found quickly super complicated methods and could fairly easily make a list of the top 10 things I want to improve. I am not believing too much in the amount of work it tells me to fix the technical debt but it gives me an indication. 856 days is massive and should be definitively lower. Also, the graphs on the dashboard are nice to point out the trend where the project is going. If the graphs show that the technical debt went up by quite a bit over the last month, it might be easier to convince your manager to do fewer new features and fix more of the technical debt in the next sprint. I mentioned a couple of times that I am a big fan of microservices. If you want to learn more about microservices, see my series “Microservice Series - From Zero to Hero”. Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion." /><meta property="og:description" content="A part of my job as a software consultant is to analyze existing software to find room for improvement to make the software better or to avoid these mistakes if the software is rewritten soon. The focus areas of your analysis vary depending on the requirements and there are also many good tools out there to help you. Today, I will give a high-level overview of how I approach the analysis of a software project using NDepend. NDepend NDepend is a tool for .NET developers that gives deep insight into the codebase. The tool can be installed as a Visual Studio extension and analyzes your code and then gives you different graphs and dashboards to dig deeper into found issues. NDepend comes with a lot of pre-configured rules to analyze the code. These rules can be easily modified or extended to fit your needs. For this post, I will stick with the default rules Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion. Install NDepend You can download a 14 day trial version from the NDepend website. After your download is finished, extract the zip file and run the installer. This will install the Visual Studio extension. Unfortunately, you have to keep this folder. If you delete it, the extension won’t work anymore. Also if you use Visual Studio to install the extension, you only get redirected to the download page. I would like it better if I could install the Visual Studio extension and don’t have to keep the folder. Analyze a .NET Core Software Project If you are a reader of my blog, you know that I am a big fan of microservices. One big advantage of them is that they are small and simple. “Unfortunately” they are not great to showcase an analysis tool because there is not much to analyze. Instead, I will use the open-source NopCommerce. You can download the project from Github. Unpack the zip file and then open the solution which is inside the src folder. Create a new NDepend project Before you can create an NDepend project to analyze the solution, you have to build it. After the build is finished (it might take quite some time) go to Extensions –&gt; NDepend and select Attach New NDepend Project to Current VS Solution. Create a new NDepend project This opens a new window where you can select the solution file you want to analyze. By default, the Nopcommerce solution file should already be selected. There you can also see all selected dlls. NDepend analyzes dlls rather than the solution file. That’s the reason why you have to build the solution before you can analyze it. Select the solution file Click on Analyze 22 .NET Assemblies and NDepend will analyze them and then create a dashboard with its findings. The NDepend Dashboard The dashboard might look quite overwhelming at first but it is quite simple. One thing I don’t like is that you have to add the code coverage results after the dashboard is created and then run the whole analysis process again. It would be nice if you could add the code coverage results before analyzing the project the first time. To add a code coverage you have to create it first. In Visual Studio select Test –&gt; Analyze Code Coverage for all Tests (or the shortcut CRTL+U. CRTL+K). This runs all tests and then adds the Code Coverage Results panel. There you can export the results. In the NDepend dashboard click on the code coverage and then select the previously exported file. Run the NDepend code analysis again and you should see the code coverage in the dashboard. The NDepend dashboard The dashboard gives you a nice overview of the project so you know what you are getting into. For example, you can see that the solution has 78755 lines of code but only 7.56% code coverage. This is already a very bad sign. The technical debt is displayed as 38.16% which equals to 856 days of work according to NDepend. I don’t know how NDepend comes up with this estimation but it gives you a good overview that the code of NopCommerce is probably in pretty bad shape. A nice feature of the dashboard is that you can basically click everywhere to get more information. For example, click on the issues and you will get a list of all the issues with an explanation of what’s wrong there. It also navigates you directly to the corresponding class or method. The graphs of the dashboard are more or less empty at the moment because they show the changes over time. I think this is a nice feature. Even if the technical debt is not too accurate, its trend still might be useful. For example, if you are at the beginning of a sprint at 30% and at the end of the sprint at 36%, you can see that you probably created a lot of technical debt and should plan some time soon to fix it. Analyze Dependencies between DLLs When you start analyzing an already existing project, it is always hard to get started and to figure out which projects are the center of the solution. NDepend helps you here with an interactive Dependency Graph. You can open it via Extensions –&gt; NDepend –&gt; Dependency Graph. The dependency graph NopCommerce is a big solution but on the graph, you can see that it looks like that the solution is separated into three parts and the core parts are on the right of the graph containing dlls like Nop.Web and Nop.Core. Now that you have a starting point, you can dig deeper into the important dlls. For example, Nop.Web.Framework. You can easily zoom in with your mouse and see all dependencies inside this project. If you click on a namespace, for example, Nop.Web.Framework.Mvc, it gets highlighted in orange and shows you all calls to other namespaces and where it is used. This shows that the namespace is the core of the whole dll. Dependencies of a namespace You can learn a lot about the solution with the Dependency Graph even before you saw a line of code. Cyclomatic Complexity The cyclomatic complexity is a metric that is used to indicate the complexity of code. It measures every available path through a method or class. For example, the following method has a cyclomatic complexity of 2 because there are two available paths. 1 2 3 4 5 6 7 8 9 10 11 public string SoSomething(int i = 0) { if (i == 0) { return &quot;zero&quot;; } else { return &quot;not zero&quot;; } } A rule of thumb is that a method should not have a cyclomatic complexity of more than 7. More than 7 means that the code is too complicated to efficiently understand and change. NDepend gives you a graphical overview of all namespaces and their cyclomatic complexity. Click on Extensions –&gt; NDepend –&gt; Code Metrics. There you can select the level, for example, method or namespace, and what you want to display. Select Cyclomatic Complexity and then Top 10. This highlights the 10 methods with the highest complexity. Code metrics overview I am not a big fan of the optical presentation but it can give you a starting point to look into the most complex methods. The list of the top 10 methods is way more useful to me. You can find it on the right when you use the Code Metrics or you can click on Method Complexity on the dashboard- Cyclomatic complexity top 10 The list tells you the Namespace, class, and method and its cyclomatic complexity. Even before looking into the code, you can see that it’s terrible because the complexity is in the hundreds. Remember, the rule of thumb says not more than 7 and then you see 123 or even 253 here. This is going to be a problem if developers have to touch this code. Technical Debt Technical debt describes the impact of the cost of additional work when you choose to implement a feature as fast as possible instead of taking a better approach. The more technical debt you acquire, the harder it will be to implement new features. That is the reason why projects which are 3-5 year olds see a drastic increase in time needed per feature. Let’s look at a real-life example. Instead of saving 20 years for a house, you take the shortcut and get a mortgage from the bank. You have to repay the debt with interest over the next 20 years. If you don’t repay the debt, it will increase due to the interest until you are unable to repay the mortgage and the bank will take your house. The same principle applies in software. If you always take shortcuts, the debt will increase until it’s too much and it will be almost impossible to implement new features because you introduce too many new features or have to change too much code. The NDepend dashboard shows the technical debt percentage, gives a rating, and estimates how much work you would need to invest to fix this debt. The NDepend dashboard AS you can see NDepend calculated the technical debt with 38.16%, gave the rating D, and estimates that it will take 856 days, or 3 years to fix it. No technical debt is not the goal and even if these 856 are estimated too high, it gives you an idea about the condition of the solution. With the complex dependencies, the missing code coverage combined with the technical debt, I can say that the NopCommerce solution is in pretty bad shape, even before looking at the code itself. NDepend aims at pointing out problems but also at helping you to resolve them. If you click on debt on the dashboard, you can see all issues listed on the right side. Overview of the technical debt By default it’s sorted by the time it takes to fix the issues but if you quickly go through the list, it gives you another indication about the bad state of the solution. You see a lot of code should be tested, method too big, too many parameters, type too big, too many fields, and so on. This all indicates that the methods and objects are very big and complex. Therefore they are hard to test or extend. Analyze the Software Architecture So far, I used NDepend to get an overview of all the problems and get an indication that the NopCommerce solution is in a pretty bad state. But even if NDepend said that everything is good, the condition could be really bad. In this section, I want to show you a couple of fast indications to get a first opinion of the state of the project. Test Quality Code coverage only tells you a part of the story, 7.56% like in NopCommerce is way too low though. Even if you have a high code coverage, you could have bad tests or are missing the edge cases of methods. Let’s have a look at the following method and its test. 1 2 3 4 5 6 7 8 9 10 11 public int Divide(int firstNumber, int secondNumber) { return firstNumber / secondNumber; } [Fact] public void Divide_DividesTwoInts_ShouldReturnResult() { var result= _testee.Divide(10, result.Should().Be(2); } This results in 100% code coverage. But if you think about the code, you will quickly see some flaws. If the second parameter is 0, you try to divide by 0 which is not allowed, and end in an exception. This means even with your 100% code coverage, your code produces an exception. Another problem you might see is that the result of the division is an integer. This means that the result is rounded and might lead to unexpected results, besides that it is very inaccurate. Test Quality in NopCommerce As you have seen in the section above, the code coverage gives you the first indication but you always should look at the tests themselves to classify their quality. NopCommerce has a code coverage of merely 7.56% but let’s have a look at the quality of the existing tests. Since we have an ASP.NET Core MVC project, let’s check the tests of the controllers first. Unfortunately, there is only one test and as you can see on the following code sample, even this test is useless and doesn’t help at all. 1 2 3 4 5 6 7 8 [TestFixture] public class CategoryControllerTests : Nop.Tests.TestsBase { public override void SetUp() { base.SetUp(); } } If you look through the tests, you will find a couple of tests for validators, automapper config, and models. Most of the tests are useless, for example, creating an object and then checking if the properties you set are still the same value. These tests only help you to get your code coverage percentage up but it doesn’t help the business running good software. Missing tests might indicate a problem with the architecture and/or too complicated classes which makes them untestable. Analyze the Project Structure After checking the lack of tests and the previously discovered complexity of too big classes, methods, and so on, I want to check if that’s the case. To do that I will start at the controllers and then go from layer to layer. I would expect a three-tier architecture where the controller takes a request and then calls a service. The service contains all the business logic and calls a repository. This repository handles all database operations. There could be more layers like a domain layer or a shared code library but this shouldn’t change too much. Since NopCommerce is an e-commerce shop, I guess that products, customers, and orders should be one of the main controllers. When you open the ProductController or the OrderController you will see that they have 3403 respectively 2826 lines of code. That is way too many! The constructor of the ProductController looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 public ProductController(IAclService aclService, IBackInStockSubscriptionService backInStockSubscriptionService, ICategoryService categoryService, ICopyProductService copyProductService, ICustomerActivityService customerActivityService, ICustomerService customerService, IDiscountService discountService, IDownloadService downloadService, IExportManager exportManager, IImportManager importManager, ILanguageService languageService, ILocalizationService localizationService, ILocalizedEntityService localizedEntityService, IManufacturerService manufacturerService, INopFileProvider fileProvider, INotificationService notificationService, IPdfService pdfService, IPermissionService permissionService, IPictureService pictureService, IProductAttributeParser productAttributeParser, IProductAttributeService productAttributeService, IProductModelFactory productModelFactory, IProductService productService, IProductTagService productTagService, ISettingService settingService, IShippingService shippingService, IShoppingCartService shoppingCartService, ISpecificationAttributeService specificationAttributeService, IStoreContext storeContext, IUrlRecordService urlRecordService, IWorkContext workContext, VendorSettings vendorSettings) { _aclService = aclService; _backInStockSubscriptionService = backInStockSubscriptionService; _categoryService = categoryService; _copyProductService = copyProductService; _customerActivityService = customerActivityService; _customerService = customerService; _discountService = discountService; _downloadService = downloadService; _exportManager = exportManager; _importManager = importManager; _languageService = languageService; _localizationService = localizationService; _localizedEntityService = localizedEntityService; _manufacturerService = manufacturerService; _fileProvider = fileProvider; _notificationService = notificationService; _pdfService = pdfService; _permissionService = permissionService; _pictureService = pictureService; _productAttributeParser = productAttributeParser; _productAttributeService = productAttributeService; _productModelFactory = productModelFactory; _productService = productService; _productTagService = productTagService; _settingService = settingService; _shippingService = shippingService; _shoppingCartService = shoppingCartService; _specificationAttributeService = specificationAttributeService; _storeContext = storeContext; _urlRecordService = urlRecordService; _workContext = workContext; _vendorSettings = vendorSettings; } There are a couple of important principles in software development. My favorite is the Single Responsible Principle (SRP) and Keep it simple stupid (KISS). If you see a constructor like this you already know that this class does more than one thing and is not simple at all. A massive constructor like this makes it also almost impossible to test because you have to fake every parameter before you can even start writing your first test. Complexity of methods In the previous section, I analyzed that the controllers are way too complicated. In this section, I will look into a method and try to find the service and repository layer (if they exist) and analyze their complexity. An online store needs products and without knowing anything about online shops, I would guess that this is a simple operation and therefore the method should be simple. Unfortunately, that’s not the case in NopCommerce. NDepend analyzed a cyclomatic complexity of 53 which is way higher than the maximum recommended 7. The method has almost 200 lines of code and looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 [HttpPost, ParameterBasedOnFormName(&quot;save-continue&quot;, &quot;continueEditing&quot;)] [FormValueRequired(&quot;save&quot;, &quot;save-continue&quot;)] public virtual IActionResult Create(CustomerModel model, bool continueEditing, IFormCollection form) { if (!_permissionService.Authorize(StandardPermissionProvider.ManageCustomers)) return AccessDeniedView if (!string.IsNullOrWhiteSpace(model.Email) &amp;&amp; _customerService.GetCustomerByEmail(model.Email) != null) ModelState.AddModelError(string.Empty, &quot;Email is already registered&quot;); if (!string.IsNullOrWhiteSpace(model.Username) &amp;&amp; _customerSettings.UsernamesEnabled &amp;&amp; _customerService.GetCustomerByUsername(model.Username) != null) { ModelState.AddModelError(string.Empty, &quot;Username is already registered&quot;); //validate customer roles var allCustomerRoles = _customerService.GetAllCustomerRoles(true); var newCustomerRoles = new List&lt;CustomerRole&gt;(); foreach (var customerRole in allCustomerRoles) if (model.SelectedCustomerRoleIds.Contains(customerRole.Id)) newCustomerRoles.Add(customerRole); var customerRolesError = ValidateCustomerRoles(newCustomerRoles, new List&lt;CustomerRole&gt;()); if (!string.IsNullOrEmpty(customerRolesError)) { ModelState.AddModelError(string.Empty, customerRolesError); _notificationService.ErrorNotification(customerRolesError); // Ensure that valid email address is entered if Registered role is checked to avoid registered customers with empty email address if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null &amp;&amp; !CommonHelper.IsValidEmail(model.Email)) { ModelState.AddModelError(string.Empty, _localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot; _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot;)); //custom customer attributes var customerAttributesXml = ParseCustomCustomerAttributes(form); if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null) { var customerAttributeWarnings = _customerAttributeParser.GetAttributeWarnings(customerAttributesXml); foreach (var error in customerAttributeWarnings) { ModelState.AddModelError(string.Empty, error); } if (ModelState.IsValid) { //fill entity from model var customer = model.ToEntity&lt;Customer&gt; customer.CustomerGuid = Guid.NewGuid(); customer.CreatedOnUtc = DateTime.UtcNow; customer.LastActivityDateUtc = DateTime.UtcNow; customer.RegisteredInStoreId = _storeContext.CurrentStore. _customerService.InsertCustomer(custome //form fields if (_dateTimeSettings.AllowCustomersToSetTimeZone) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.TimeZoneIdAttribute, model.TimeZoneId); if (_customerSettings.GenderEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.GenderAttribute, model.Gender); if (_customerSettings.FirstNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FirstNameAttribute, model.FirstName); if (_customerSettings.LastNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.LastNameAttribute, model.LastName); if (_customerSettings.DateOfBirthEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.DateOfBirthAttribute, model.DateOfBirth); if (_customerSettings.CompanyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CompanyAttribute, model.Company); if (_customerSettings.StreetAddressEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddressAttribute, model.StreetAddress); if (_customerSettings.StreetAddress2Enabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddress2Attribute, model.StreetAddress2); if (_customerSettings.ZipPostalCodeEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.ZipPostalCodeAttribute, model.ZipPostalCode); if (_customerSettings.CityEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CityAttribute, model.City); if (_customerSettings.CountyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountyAttribute, model.County); if (_customerSettings.CountryEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountryIdAttribute, model.CountryId); if (_customerSettings.CountryEnabled &amp;&amp; _customerSettings.StateProvinceEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StateProvinceIdAttribute, model.StateProvinceId); if (_customerSettings.PhoneEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.PhoneAttribute, model.Phone); if (_customerSettings.FaxEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FaxAttribute, model.Fa //custom customer attributes _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CustomCustomerAttributes, customerAttributesXm //newsletter subscriptions if (!string.IsNullOrEmpty(customer.Email)) { var allStores = _storeService.GetAllStores(); foreach (var store in allStores) { var newsletterSubscription = _newsLetterSubscriptionService .GetNewsLetterSubscriptionByEmailAndStoreId(customer.Email, store.Id); if (model.SelectedNewsletterSubscriptionStoreIds != null &amp;&amp; model.SelectedNewsletterSubscriptionStoreIds.Contains(store.Id)) { //subscribed if (newsletterSubscription == null) { _newsLetterSubscriptionService.InsertNewsLetterSubscription(new NewsLetterSubscription { NewsLetterSubscriptionGuid = Guid.NewGuid(), Email = customer.Email, Active = true, StoreId = store.Id, CreatedOnUtc = DateTime.UtcNow }); } } else { //not subscribed if (newsletterSubscription != null) { _newsLetterSubscriptionService.DeleteNewsLetterSubscription(newsletterSubscription); } } } //password if (!string.IsNullOrWhiteSpace(model.Password)) { var changePassRequest = new ChangePasswordRequest(model.Email, false, _customerSettings.DefaultPasswordFormat, model.Password); var changePassResult = _customerRegistrationService.ChangePassword(changePassRequest); if (!changePassResult.Success) { foreach (var changePassError in changePassResult.Errors) _notificationService.ErrorNotification(changePassError); } //customer roles foreach (var customerRole in newCustomerRoles) { //ensure that the current customer cannot add to &quot;Administrators&quot; system role if he&#39;s not an admin himself if (customerRole.SystemName == NopCustomerDefaults.AdministratorsRoleName &amp;&amp; !_customerService.IsAdmin(_workContext.CurrentCustomer)) contin _customerService.AddCustomerRoleMapping(new CustomerCustomerRoleMapping { CustomerId = customer.Id, CustomerRoleId = customerRole.Id }); _customerService.UpdateCustomer(custome //ensure that a customer with a vendor associated is not in &quot;Administrators&quot; role //otherwise, he won&#39;t have access to other functionality in admin area if (_customerService.IsAdmin(customer) &amp;&amp; customer.VendorId &gt; 0) { customer.VendorId = 0; _customerService.UpdateCustomer(custome _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.AdminCouldNotbeVendor&quot;)); //ensure that a customer in the Vendors role has a vendor account associated. //otherwise, he will have access to ALL products if (_customerService.IsVendor(customer) &amp;&amp; customer.VendorId == 0) { var vendorRole = _customerService.GetCustomerRoleBySystemName(NopCustomerDefaults.VendorsRoleName); _customerService.RemoveCustomerRoleMapping(customer, vendorRol _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.CannotBeInVendoRoleWithoutVendorAssociated&quot;)); //activity log _customerActivityService.InsertActivity(&quot;AddNewCustomer&quot;, string.Format(_localizationService.GetResource(&quot;ActivityLog.AddNewCustomer&quot;), customer.Id), customer); _notificationService.SuccessNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.Added&quot; if (!continueEditing) return RedirectToAction(&quot;List&quot;); return RedirectToAction(&quot;Edit&quot;, new { id = customer.Id }); //prepare model model = _customerModelFactory.PrepareCustomerModel(model, null, tru //if we got this far, something failed, redisplay form return View(model); } A controller should only take the request and then call services that handle the business logic. From a first glimpse, it looks like the controller does all the business logic already. This would also mean that you can’t reuse the code to create a product because it is in the controller and not in a service class. Additionally, the controller does way more than creating a product that violates the Single Responsible Principle. Due to its insanely high complexity, it is also almost impossible to write adequate tests for the code. Previously, I said that I will dive down the different layers but after seeing the controller I feel like I have seen enough to give a first verdict. Code Reusability and APIs Code reusability is an important factor when it comes to development speed and maintenance costs in the future. I like microservices and one feature of them is that they have many APIs which allow code to be shared easily. Let’s look at the following use case: you have your NopCommerce online shop and then get the task to develop a mobile app for your store. With a modern microservice architecture, you only have to build the mobile app which then calls all your APIs to load data or create orders. This should be done fairly quickly. What about our existing NopCommerce solution? As far as I have seen there are no APIs in the whole solution and as previously mentioned, all the business logic is in the controller. This means that it is not even possible to create a shared library of the service layer to share the code with the mobile app. While looking over the controller methods, I also saw that security checks like if the user has the right role are done in each controller method. Additionally, these checks read certain cookie values that are tied to the online shop and won’t be available in your mobile app. I have spent maybe half an hour in the code but can already tell you that it’s not possible to reuse the code without a lot of unnecessary extra work. Last Thoughts on Analyzing Software Architecture You can analyze the software architecture of a project with many goals in mind. It totally depends on the requirements of your analyzes. For example, if you should find out why software is running slowly, you would use a profiler or some measurement tools to find out which parts of your software are running slow. Then you can focus on these areas to improve the performance. Another aspect of analyzing a software project could be the deployment process. I haven’t talked about this at all but in a modern DevOps culture, all changes should be automatically tested and deployed (either after a change is committed or at the end of a sprint) and also should be reviewed before it gets merged in your master branch. Analyzing this process could span the build and deployment pipeline, what technologies are used, for example, Docker, and go even as far as analyzing how running the software works. For example, if you run it in Kubernetes with auto-scaling or if your application just crashes when it’s out of resources. Even if it’s not directly analyzing the software architecture, it makes sense to look at the planned and recently finished features. If there are only new features and no refactoring tasks and if the features took quite some time, you can already guess that the software is in a bad shape. Here it is also your job as a consultant or architect to intervene and try to convince the product owner/manager to spend more time refactoring. Conclusion This post gave you a high-level overview of how you can get started when analyzing the architecture of a software project. Look out for untestable code because this is often an indication of too complex code or a bad software architecture and keep software principles like the Single Responsible Principle, Separation of Concerns, and KISS in mind. Use tools to get a starting point and then start there to dive into the solution in more detail. I used NDepend to analyze the NopCommerce solution and get an overview of its state. If this post sounded like bashing NopCommerce, this was not my intention. I used it because I wanted to show you a realistic piece of software and pointed out my findings. If they were all great I would have mentioned that too. Unfortunately, the negative ones totally outranked the good ones. I hope NDepend improves the installation process in the future so you can install it as an extension in Visual Studio without downloading and keeping the NDepend folder somewhere on your computer. NDepend was easy to use and give me a great overview of the state of the project and provided useful links to dive into the pain points of the solution. For example, I found quickly super complicated methods and could fairly easily make a list of the top 10 things I want to improve. I am not believing too much in the amount of work it tells me to fix the technical debt but it gives me an indication. 856 days is massive and should be definitively lower. Also, the graphs on the dashboard are nice to point out the trend where the project is going. If the graphs show that the technical debt went up by quite a bit over the last month, it might be easier to convince your manager to do fewer new features and fix more of the technical debt in the next sprint. I mentioned a couple of times that I am a big fan of microservices. If you want to learn more about microservices, see my series “Microservice Series - From Zero to Hero”. Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-01T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Analyze Software Architecture with NDepend" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/","description":"A part of my job as a software consultant is to analyze existing software to find room for improvement to make the software better or to avoid these mistakes if the software is rewritten soon. The focus areas of your analysis vary depending on the requirements and there are also many good tools out there to help you. Today, I will give a high-level overview of how I approach the analysis of a software project using NDepend. NDepend NDepend is a tool for .NET developers that gives deep insight into the codebase. The tool can be installed as a Visual Studio extension and analyzes your code and then gives you different graphs and dashboards to dig deeper into found issues. NDepend comes with a lot of pre-configured rules to analyze the code. These rules can be easily modified or extended to fit your needs. For this post, I will stick with the default rules Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion. Install NDepend You can download a 14 day trial version from the NDepend website. After your download is finished, extract the zip file and run the installer. This will install the Visual Studio extension. Unfortunately, you have to keep this folder. If you delete it, the extension won’t work anymore. Also if you use Visual Studio to install the extension, you only get redirected to the download page. I would like it better if I could install the Visual Studio extension and don’t have to keep the folder. Analyze a .NET Core Software Project If you are a reader of my blog, you know that I am a big fan of microservices. One big advantage of them is that they are small and simple. “Unfortunately” they are not great to showcase an analysis tool because there is not much to analyze. Instead, I will use the open-source NopCommerce. You can download the project from Github. Unpack the zip file and then open the solution which is inside the src folder. Create a new NDepend project Before you can create an NDepend project to analyze the solution, you have to build it. After the build is finished (it might take quite some time) go to Extensions –&gt; NDepend and select Attach New NDepend Project to Current VS Solution. Create a new NDepend project This opens a new window where you can select the solution file you want to analyze. By default, the Nopcommerce solution file should already be selected. There you can also see all selected dlls. NDepend analyzes dlls rather than the solution file. That’s the reason why you have to build the solution before you can analyze it. Select the solution file Click on Analyze 22 .NET Assemblies and NDepend will analyze them and then create a dashboard with its findings. The NDepend Dashboard The dashboard might look quite overwhelming at first but it is quite simple. One thing I don’t like is that you have to add the code coverage results after the dashboard is created and then run the whole analysis process again. It would be nice if you could add the code coverage results before analyzing the project the first time. To add a code coverage you have to create it first. In Visual Studio select Test –&gt; Analyze Code Coverage for all Tests (or the shortcut CRTL+U. CRTL+K). This runs all tests and then adds the Code Coverage Results panel. There you can export the results. In the NDepend dashboard click on the code coverage and then select the previously exported file. Run the NDepend code analysis again and you should see the code coverage in the dashboard. The NDepend dashboard The dashboard gives you a nice overview of the project so you know what you are getting into. For example, you can see that the solution has 78755 lines of code but only 7.56% code coverage. This is already a very bad sign. The technical debt is displayed as 38.16% which equals to 856 days of work according to NDepend. I don’t know how NDepend comes up with this estimation but it gives you a good overview that the code of NopCommerce is probably in pretty bad shape. A nice feature of the dashboard is that you can basically click everywhere to get more information. For example, click on the issues and you will get a list of all the issues with an explanation of what’s wrong there. It also navigates you directly to the corresponding class or method. The graphs of the dashboard are more or less empty at the moment because they show the changes over time. I think this is a nice feature. Even if the technical debt is not too accurate, its trend still might be useful. For example, if you are at the beginning of a sprint at 30% and at the end of the sprint at 36%, you can see that you probably created a lot of technical debt and should plan some time soon to fix it. Analyze Dependencies between DLLs When you start analyzing an already existing project, it is always hard to get started and to figure out which projects are the center of the solution. NDepend helps you here with an interactive Dependency Graph. You can open it via Extensions –&gt; NDepend –&gt; Dependency Graph. The dependency graph NopCommerce is a big solution but on the graph, you can see that it looks like that the solution is separated into three parts and the core parts are on the right of the graph containing dlls like Nop.Web and Nop.Core. Now that you have a starting point, you can dig deeper into the important dlls. For example, Nop.Web.Framework. You can easily zoom in with your mouse and see all dependencies inside this project. If you click on a namespace, for example, Nop.Web.Framework.Mvc, it gets highlighted in orange and shows you all calls to other namespaces and where it is used. This shows that the namespace is the core of the whole dll. Dependencies of a namespace You can learn a lot about the solution with the Dependency Graph even before you saw a line of code. Cyclomatic Complexity The cyclomatic complexity is a metric that is used to indicate the complexity of code. It measures every available path through a method or class. For example, the following method has a cyclomatic complexity of 2 because there are two available paths. 1 2 3 4 5 6 7 8 9 10 11 public string SoSomething(int i = 0) { if (i == 0) { return &quot;zero&quot;; } else { return &quot;not zero&quot;; } } A rule of thumb is that a method should not have a cyclomatic complexity of more than 7. More than 7 means that the code is too complicated to efficiently understand and change. NDepend gives you a graphical overview of all namespaces and their cyclomatic complexity. Click on Extensions –&gt; NDepend –&gt; Code Metrics. There you can select the level, for example, method or namespace, and what you want to display. Select Cyclomatic Complexity and then Top 10. This highlights the 10 methods with the highest complexity. Code metrics overview I am not a big fan of the optical presentation but it can give you a starting point to look into the most complex methods. The list of the top 10 methods is way more useful to me. You can find it on the right when you use the Code Metrics or you can click on Method Complexity on the dashboard- Cyclomatic complexity top 10 The list tells you the Namespace, class, and method and its cyclomatic complexity. Even before looking into the code, you can see that it’s terrible because the complexity is in the hundreds. Remember, the rule of thumb says not more than 7 and then you see 123 or even 253 here. This is going to be a problem if developers have to touch this code. Technical Debt Technical debt describes the impact of the cost of additional work when you choose to implement a feature as fast as possible instead of taking a better approach. The more technical debt you acquire, the harder it will be to implement new features. That is the reason why projects which are 3-5 year olds see a drastic increase in time needed per feature. Let’s look at a real-life example. Instead of saving 20 years for a house, you take the shortcut and get a mortgage from the bank. You have to repay the debt with interest over the next 20 years. If you don’t repay the debt, it will increase due to the interest until you are unable to repay the mortgage and the bank will take your house. The same principle applies in software. If you always take shortcuts, the debt will increase until it’s too much and it will be almost impossible to implement new features because you introduce too many new features or have to change too much code. The NDepend dashboard shows the technical debt percentage, gives a rating, and estimates how much work you would need to invest to fix this debt. The NDepend dashboard AS you can see NDepend calculated the technical debt with 38.16%, gave the rating D, and estimates that it will take 856 days, or 3 years to fix it. No technical debt is not the goal and even if these 856 are estimated too high, it gives you an idea about the condition of the solution. With the complex dependencies, the missing code coverage combined with the technical debt, I can say that the NopCommerce solution is in pretty bad shape, even before looking at the code itself. NDepend aims at pointing out problems but also at helping you to resolve them. If you click on debt on the dashboard, you can see all issues listed on the right side. Overview of the technical debt By default it’s sorted by the time it takes to fix the issues but if you quickly go through the list, it gives you another indication about the bad state of the solution. You see a lot of code should be tested, method too big, too many parameters, type too big, too many fields, and so on. This all indicates that the methods and objects are very big and complex. Therefore they are hard to test or extend. Analyze the Software Architecture So far, I used NDepend to get an overview of all the problems and get an indication that the NopCommerce solution is in a pretty bad state. But even if NDepend said that everything is good, the condition could be really bad. In this section, I want to show you a couple of fast indications to get a first opinion of the state of the project. Test Quality Code coverage only tells you a part of the story, 7.56% like in NopCommerce is way too low though. Even if you have a high code coverage, you could have bad tests or are missing the edge cases of methods. Let’s have a look at the following method and its test. 1 2 3 4 5 6 7 8 9 10 11 public int Divide(int firstNumber, int secondNumber) { return firstNumber / secondNumber; } [Fact] public void Divide_DividesTwoInts_ShouldReturnResult() { var result= _testee.Divide(10, result.Should().Be(2); } This results in 100% code coverage. But if you think about the code, you will quickly see some flaws. If the second parameter is 0, you try to divide by 0 which is not allowed, and end in an exception. This means even with your 100% code coverage, your code produces an exception. Another problem you might see is that the result of the division is an integer. This means that the result is rounded and might lead to unexpected results, besides that it is very inaccurate. Test Quality in NopCommerce As you have seen in the section above, the code coverage gives you the first indication but you always should look at the tests themselves to classify their quality. NopCommerce has a code coverage of merely 7.56% but let’s have a look at the quality of the existing tests. Since we have an ASP.NET Core MVC project, let’s check the tests of the controllers first. Unfortunately, there is only one test and as you can see on the following code sample, even this test is useless and doesn’t help at all. 1 2 3 4 5 6 7 8 [TestFixture] public class CategoryControllerTests : Nop.Tests.TestsBase { public override void SetUp() { base.SetUp(); } } If you look through the tests, you will find a couple of tests for validators, automapper config, and models. Most of the tests are useless, for example, creating an object and then checking if the properties you set are still the same value. These tests only help you to get your code coverage percentage up but it doesn’t help the business running good software. Missing tests might indicate a problem with the architecture and/or too complicated classes which makes them untestable. Analyze the Project Structure After checking the lack of tests and the previously discovered complexity of too big classes, methods, and so on, I want to check if that’s the case. To do that I will start at the controllers and then go from layer to layer. I would expect a three-tier architecture where the controller takes a request and then calls a service. The service contains all the business logic and calls a repository. This repository handles all database operations. There could be more layers like a domain layer or a shared code library but this shouldn’t change too much. Since NopCommerce is an e-commerce shop, I guess that products, customers, and orders should be one of the main controllers. When you open the ProductController or the OrderController you will see that they have 3403 respectively 2826 lines of code. That is way too many! The constructor of the ProductController looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 public ProductController(IAclService aclService, IBackInStockSubscriptionService backInStockSubscriptionService, ICategoryService categoryService, ICopyProductService copyProductService, ICustomerActivityService customerActivityService, ICustomerService customerService, IDiscountService discountService, IDownloadService downloadService, IExportManager exportManager, IImportManager importManager, ILanguageService languageService, ILocalizationService localizationService, ILocalizedEntityService localizedEntityService, IManufacturerService manufacturerService, INopFileProvider fileProvider, INotificationService notificationService, IPdfService pdfService, IPermissionService permissionService, IPictureService pictureService, IProductAttributeParser productAttributeParser, IProductAttributeService productAttributeService, IProductModelFactory productModelFactory, IProductService productService, IProductTagService productTagService, ISettingService settingService, IShippingService shippingService, IShoppingCartService shoppingCartService, ISpecificationAttributeService specificationAttributeService, IStoreContext storeContext, IUrlRecordService urlRecordService, IWorkContext workContext, VendorSettings vendorSettings) { _aclService = aclService; _backInStockSubscriptionService = backInStockSubscriptionService; _categoryService = categoryService; _copyProductService = copyProductService; _customerActivityService = customerActivityService; _customerService = customerService; _discountService = discountService; _downloadService = downloadService; _exportManager = exportManager; _importManager = importManager; _languageService = languageService; _localizationService = localizationService; _localizedEntityService = localizedEntityService; _manufacturerService = manufacturerService; _fileProvider = fileProvider; _notificationService = notificationService; _pdfService = pdfService; _permissionService = permissionService; _pictureService = pictureService; _productAttributeParser = productAttributeParser; _productAttributeService = productAttributeService; _productModelFactory = productModelFactory; _productService = productService; _productTagService = productTagService; _settingService = settingService; _shippingService = shippingService; _shoppingCartService = shoppingCartService; _specificationAttributeService = specificationAttributeService; _storeContext = storeContext; _urlRecordService = urlRecordService; _workContext = workContext; _vendorSettings = vendorSettings; } There are a couple of important principles in software development. My favorite is the Single Responsible Principle (SRP) and Keep it simple stupid (KISS). If you see a constructor like this you already know that this class does more than one thing and is not simple at all. A massive constructor like this makes it also almost impossible to test because you have to fake every parameter before you can even start writing your first test. Complexity of methods In the previous section, I analyzed that the controllers are way too complicated. In this section, I will look into a method and try to find the service and repository layer (if they exist) and analyze their complexity. An online store needs products and without knowing anything about online shops, I would guess that this is a simple operation and therefore the method should be simple. Unfortunately, that’s not the case in NopCommerce. NDepend analyzed a cyclomatic complexity of 53 which is way higher than the maximum recommended 7. The method has almost 200 lines of code and looks as follows: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 [HttpPost, ParameterBasedOnFormName(&quot;save-continue&quot;, &quot;continueEditing&quot;)] [FormValueRequired(&quot;save&quot;, &quot;save-continue&quot;)] public virtual IActionResult Create(CustomerModel model, bool continueEditing, IFormCollection form) { if (!_permissionService.Authorize(StandardPermissionProvider.ManageCustomers)) return AccessDeniedView if (!string.IsNullOrWhiteSpace(model.Email) &amp;&amp; _customerService.GetCustomerByEmail(model.Email) != null) ModelState.AddModelError(string.Empty, &quot;Email is already registered&quot;); if (!string.IsNullOrWhiteSpace(model.Username) &amp;&amp; _customerSettings.UsernamesEnabled &amp;&amp; _customerService.GetCustomerByUsername(model.Username) != null) { ModelState.AddModelError(string.Empty, &quot;Username is already registered&quot;); //validate customer roles var allCustomerRoles = _customerService.GetAllCustomerRoles(true); var newCustomerRoles = new List&lt;CustomerRole&gt;(); foreach (var customerRole in allCustomerRoles) if (model.SelectedCustomerRoleIds.Contains(customerRole.Id)) newCustomerRoles.Add(customerRole); var customerRolesError = ValidateCustomerRoles(newCustomerRoles, new List&lt;CustomerRole&gt;()); if (!string.IsNullOrEmpty(customerRolesError)) { ModelState.AddModelError(string.Empty, customerRolesError); _notificationService.ErrorNotification(customerRolesError); // Ensure that valid email address is entered if Registered role is checked to avoid registered customers with empty email address if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null &amp;&amp; !CommonHelper.IsValidEmail(model.Email)) { ModelState.AddModelError(string.Empty, _localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot; _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.ValidEmailRequiredRegisteredRole&quot;)); //custom customer attributes var customerAttributesXml = ParseCustomCustomerAttributes(form); if (newCustomerRoles.Any() &amp;&amp; newCustomerRoles.FirstOrDefault(c =&gt; c.SystemName == NopCustomerDefaults.RegisteredRoleName) != null) { var customerAttributeWarnings = _customerAttributeParser.GetAttributeWarnings(customerAttributesXml); foreach (var error in customerAttributeWarnings) { ModelState.AddModelError(string.Empty, error); } if (ModelState.IsValid) { //fill entity from model var customer = model.ToEntity&lt;Customer&gt; customer.CustomerGuid = Guid.NewGuid(); customer.CreatedOnUtc = DateTime.UtcNow; customer.LastActivityDateUtc = DateTime.UtcNow; customer.RegisteredInStoreId = _storeContext.CurrentStore. _customerService.InsertCustomer(custome //form fields if (_dateTimeSettings.AllowCustomersToSetTimeZone) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.TimeZoneIdAttribute, model.TimeZoneId); if (_customerSettings.GenderEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.GenderAttribute, model.Gender); if (_customerSettings.FirstNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FirstNameAttribute, model.FirstName); if (_customerSettings.LastNameEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.LastNameAttribute, model.LastName); if (_customerSettings.DateOfBirthEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.DateOfBirthAttribute, model.DateOfBirth); if (_customerSettings.CompanyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CompanyAttribute, model.Company); if (_customerSettings.StreetAddressEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddressAttribute, model.StreetAddress); if (_customerSettings.StreetAddress2Enabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StreetAddress2Attribute, model.StreetAddress2); if (_customerSettings.ZipPostalCodeEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.ZipPostalCodeAttribute, model.ZipPostalCode); if (_customerSettings.CityEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CityAttribute, model.City); if (_customerSettings.CountyEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountyAttribute, model.County); if (_customerSettings.CountryEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CountryIdAttribute, model.CountryId); if (_customerSettings.CountryEnabled &amp;&amp; _customerSettings.StateProvinceEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.StateProvinceIdAttribute, model.StateProvinceId); if (_customerSettings.PhoneEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.PhoneAttribute, model.Phone); if (_customerSettings.FaxEnabled) _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.FaxAttribute, model.Fa //custom customer attributes _genericAttributeService.SaveAttribute(customer, NopCustomerDefaults.CustomCustomerAttributes, customerAttributesXm //newsletter subscriptions if (!string.IsNullOrEmpty(customer.Email)) { var allStores = _storeService.GetAllStores(); foreach (var store in allStores) { var newsletterSubscription = _newsLetterSubscriptionService .GetNewsLetterSubscriptionByEmailAndStoreId(customer.Email, store.Id); if (model.SelectedNewsletterSubscriptionStoreIds != null &amp;&amp; model.SelectedNewsletterSubscriptionStoreIds.Contains(store.Id)) { //subscribed if (newsletterSubscription == null) { _newsLetterSubscriptionService.InsertNewsLetterSubscription(new NewsLetterSubscription { NewsLetterSubscriptionGuid = Guid.NewGuid(), Email = customer.Email, Active = true, StoreId = store.Id, CreatedOnUtc = DateTime.UtcNow }); } } else { //not subscribed if (newsletterSubscription != null) { _newsLetterSubscriptionService.DeleteNewsLetterSubscription(newsletterSubscription); } } } //password if (!string.IsNullOrWhiteSpace(model.Password)) { var changePassRequest = new ChangePasswordRequest(model.Email, false, _customerSettings.DefaultPasswordFormat, model.Password); var changePassResult = _customerRegistrationService.ChangePassword(changePassRequest); if (!changePassResult.Success) { foreach (var changePassError in changePassResult.Errors) _notificationService.ErrorNotification(changePassError); } //customer roles foreach (var customerRole in newCustomerRoles) { //ensure that the current customer cannot add to &quot;Administrators&quot; system role if he&#39;s not an admin himself if (customerRole.SystemName == NopCustomerDefaults.AdministratorsRoleName &amp;&amp; !_customerService.IsAdmin(_workContext.CurrentCustomer)) contin _customerService.AddCustomerRoleMapping(new CustomerCustomerRoleMapping { CustomerId = customer.Id, CustomerRoleId = customerRole.Id }); _customerService.UpdateCustomer(custome //ensure that a customer with a vendor associated is not in &quot;Administrators&quot; role //otherwise, he won&#39;t have access to other functionality in admin area if (_customerService.IsAdmin(customer) &amp;&amp; customer.VendorId &gt; 0) { customer.VendorId = 0; _customerService.UpdateCustomer(custome _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.AdminCouldNotbeVendor&quot;)); //ensure that a customer in the Vendors role has a vendor account associated. //otherwise, he will have access to ALL products if (_customerService.IsVendor(customer) &amp;&amp; customer.VendorId == 0) { var vendorRole = _customerService.GetCustomerRoleBySystemName(NopCustomerDefaults.VendorsRoleName); _customerService.RemoveCustomerRoleMapping(customer, vendorRol _notificationService.ErrorNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.CannotBeInVendoRoleWithoutVendorAssociated&quot;)); //activity log _customerActivityService.InsertActivity(&quot;AddNewCustomer&quot;, string.Format(_localizationService.GetResource(&quot;ActivityLog.AddNewCustomer&quot;), customer.Id), customer); _notificationService.SuccessNotification(_localizationService.GetResource(&quot;Admin.Customers.Customers.Added&quot; if (!continueEditing) return RedirectToAction(&quot;List&quot;); return RedirectToAction(&quot;Edit&quot;, new { id = customer.Id }); //prepare model model = _customerModelFactory.PrepareCustomerModel(model, null, tru //if we got this far, something failed, redisplay form return View(model); } A controller should only take the request and then call services that handle the business logic. From a first glimpse, it looks like the controller does all the business logic already. This would also mean that you can’t reuse the code to create a product because it is in the controller and not in a service class. Additionally, the controller does way more than creating a product that violates the Single Responsible Principle. Due to its insanely high complexity, it is also almost impossible to write adequate tests for the code. Previously, I said that I will dive down the different layers but after seeing the controller I feel like I have seen enough to give a first verdict. Code Reusability and APIs Code reusability is an important factor when it comes to development speed and maintenance costs in the future. I like microservices and one feature of them is that they have many APIs which allow code to be shared easily. Let’s look at the following use case: you have your NopCommerce online shop and then get the task to develop a mobile app for your store. With a modern microservice architecture, you only have to build the mobile app which then calls all your APIs to load data or create orders. This should be done fairly quickly. What about our existing NopCommerce solution? As far as I have seen there are no APIs in the whole solution and as previously mentioned, all the business logic is in the controller. This means that it is not even possible to create a shared library of the service layer to share the code with the mobile app. While looking over the controller methods, I also saw that security checks like if the user has the right role are done in each controller method. Additionally, these checks read certain cookie values that are tied to the online shop and won’t be available in your mobile app. I have spent maybe half an hour in the code but can already tell you that it’s not possible to reuse the code without a lot of unnecessary extra work. Last Thoughts on Analyzing Software Architecture You can analyze the software architecture of a project with many goals in mind. It totally depends on the requirements of your analyzes. For example, if you should find out why software is running slowly, you would use a profiler or some measurement tools to find out which parts of your software are running slow. Then you can focus on these areas to improve the performance. Another aspect of analyzing a software project could be the deployment process. I haven’t talked about this at all but in a modern DevOps culture, all changes should be automatically tested and deployed (either after a change is committed or at the end of a sprint) and also should be reviewed before it gets merged in your master branch. Analyzing this process could span the build and deployment pipeline, what technologies are used, for example, Docker, and go even as far as analyzing how running the software works. For example, if you run it in Kubernetes with auto-scaling or if your application just crashes when it’s out of resources. Even if it’s not directly analyzing the software architecture, it makes sense to look at the planned and recently finished features. If there are only new features and no refactoring tasks and if the features took quite some time, you can already guess that the software is in a bad shape. Here it is also your job as a consultant or architect to intervene and try to convince the product owner/manager to spend more time refactoring. Conclusion This post gave you a high-level overview of how you can get started when analyzing the architecture of a software project. Look out for untestable code because this is often an indication of too complex code or a bad software architecture and keep software principles like the Single Responsible Principle, Separation of Concerns, and KISS in mind. Use tools to get a starting point and then start there to dive into the solution in more detail. I used NDepend to analyze the NopCommerce solution and get an overview of its state. If this post sounded like bashing NopCommerce, this was not my intention. I used it because I wanted to show you a realistic piece of software and pointed out my findings. If they were all great I would have mentioned that too. Unfortunately, the negative ones totally outranked the good ones. I hope NDepend improves the installation process in the future so you can install it as an extension in Visual Studio without downloading and keeping the NDepend folder somewhere on your computer. NDepend was easy to use and give me a great overview of the state of the project and provided useful links to dive into the pain points of the solution. For example, I found quickly super complicated methods and could fairly easily make a list of the top 10 things I want to improve. I am not believing too much in the amount of work it tells me to fix the technical debt but it gives me an indication. 856 days is massive and should be definitively lower. Also, the graphs on the dashboard are nice to point out the trend where the project is going. If the graphs show that the technical debt went up by quite a bit over the last month, it might be easier to convince your manager to do fewer new features and fix more of the technical debt in the next sprint. I mentioned a couple of times that I am a big fan of microservices. If you want to learn more about microservices, see my series “Microservice Series - From Zero to Hero”. Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion.","@type":"BlogPosting","headline":"Analyze Software Architecture with NDepend","dateModified":"2021-02-01T00:00:00+01:00","datePublished":"2021-02-01T00:00:00+01:00","@context":"https://schema.org"}</script><title>Analyze Software Architecture with NDepend | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/wolfgang-small.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Analyze Software Architecture with NDepend</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Analyze Software Architecture with NDepend</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Analyze Software Architecture with NDepend</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 1, 2021, 12:00 AM +0100" > Feb 1 <i class="unloaded">2021-02-01T00:00:00+01:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4428 words">52 min</span></div></div><div class="post-content"><p>A part of my job as a software consultant is to analyze existing software to find room for improvement to make the software better or to avoid these mistakes if the software is rewritten soon. The focus areas of your analysis vary depending on the requirements and there are also many good tools out there to help you.</p><p>Today, I will give a high-level overview of how I approach the analysis of a software project using NDepend.</p><h2 id="ndepend">NDepend</h2><p>NDepend is a tool for .NET developers that gives deep insight into the codebase. The tool can be installed as a Visual Studio extension and analyzes your code and then gives you different graphs and dashboards to dig deeper into found issues. NDepend comes with a lot of pre-configured rules to analyze the code. These rules can be easily modified or extended to fit your needs. For this post, I will stick with the default rules</p><p>Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion.</p><h3 id="install-ndepend">Install NDepend</h3><p>You can download a 14 day trial version from the <a href="https://www.ndepend.com/download" target="_blank" rel="noopener noreferrer">NDepend website</a>. After your download is finished, extract the zip file and run the installer. This will install the Visual Studio extension.</p><p>Unfortunately, you have to keep this folder. If you delete it, the extension won’t work anymore. Also if you use Visual Studio to install the extension, you only get redirected to the download page. I would like it better if I could install the Visual Studio extension and don’t have to keep the folder.</p><h3 id="analyze-a-net-core-software-project">Analyze a .NET Core Software Project</h3><p>If you are a reader of my blog, you know that I am a big fan of microservices. One big advantage of them is that they are small and simple. “Unfortunately” they are not great to showcase an analysis tool because there is not much to analyze. Instead, I will use the open-source NopCommerce. You can download the project from <a href="https://github.com/nopSolutions/nopCommerce/tree/4.30-bug-fixes" target="_blank" rel="noopener noreferrer">Github</a>. Unpack the zip file and then open the solution which is inside the src folder.</p><h3 id="create-a-new-ndepend-project">Create a new NDepend project</h3><p>Before you can create an NDepend project to analyze the solution, you have to build it. After the build is finished (it might take quite some time) go to Extensions –&gt; NDepend and select Attach New NDepend Project to Current VS Solution.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Create-a-new-NDepend-project.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Create-a-new-NDepend-project.jpg" alt="Create a new NDepend project" /></a><p> Create a new NDepend project</p></div><p>This opens a new window where you can select the solution file you want to analyze. By default, the Nopcommerce solution file should already be selected. There you can also see all selected dlls. NDepend analyzes dlls rather than the solution file. That’s the reason why you have to build the solution before you can analyze it.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Select-the-solution-file.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Select-the-solution-file.jpg" alt="Select the solution file" /></a><p> Select the solution file</p></div><p>Click on Analyze 22 .NET Assemblies and NDepend will analyze them and then create a dashboard with its findings.</p><h3 id="the-ndepend-dashboard">The NDepend Dashboard</h3><p>The dashboard might look quite overwhelming at first but it is quite simple. One thing I don’t like is that you have to add the code coverage results after the dashboard is created and then run the whole analysis process again. It would be nice if you could add the code coverage results before analyzing the project the first time.</p><p>To add a code coverage you have to create it first. In Visual Studio select Test –&gt; Analyze Code Coverage for all Tests (or the shortcut CRTL+U. CRTL+K). This runs all tests and then adds the Code Coverage Results panel. There you can export the results.</p><p>In the NDepend dashboard click on the code coverage and then select the previously exported file. Run the NDepend code analysis again and you should see the code coverage in the dashboard.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-NDepend-dashboard.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-NDepend-dashboard.jpg" alt="The NDepend dashboard" /></a><p> The NDepend dashboard</p></div><p>The dashboard gives you a nice overview of the project so you know what you are getting into. For example, you can see that the solution has 78755 lines of code but only 7.56% code coverage. This is already a very bad sign. The technical debt is displayed as 38.16% which equals to 856 days of work according to NDepend. I don’t know how NDepend comes up with this estimation but it gives you a good overview that the code of NopCommerce is probably in pretty bad shape.</p><p>A nice feature of the dashboard is that you can basically click everywhere to get more information. For example, click on the issues and you will get a list of all the issues with an explanation of what’s wrong there. It also navigates you directly to the corresponding class or method.</p><p>The graphs of the dashboard are more or less empty at the moment because they show the changes over time. I think this is a nice feature. Even if the technical debt is not too accurate, its trend still might be useful. For example, if you are at the beginning of a sprint at 30% and at the end of the sprint at 36%, you can see that you probably created a lot of technical debt and should plan some time soon to fix it.</p><h3 id="analyze-dependencies-between-dlls">Analyze Dependencies between DLLs</h3><p>When you start analyzing an already existing project, it is always hard to get started and to figure out which projects are the center of the solution. NDepend helps you here with an interactive Dependency Graph. You can open it via Extensions –&gt; NDepend –&gt; Dependency Graph.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-dependency-graph.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-dependency-graph.jpg" alt="The dependency graph" /></a><p> The dependency graph</p></div><p>NopCommerce is a big solution but on the graph, you can see that it looks like that the solution is separated into three parts and the core parts are on the right of the graph containing dlls like Nop.Web and Nop.Core. Now that you have a starting point, you can dig deeper into the important dlls. For example, Nop.Web.Framework. You can easily zoom in with your mouse and see all dependencies inside this project. If you click on a namespace, for example, Nop.Web.Framework.Mvc, it gets highlighted in orange and shows you all calls to other namespaces and where it is used. This shows that the namespace is the core of the whole dll.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Dependencies-of-a-namespace.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Dependencies-of-a-namespace.jpg" alt="Dependencies of a namespace" /></a><p> Dependencies of a namespace</p></div><p>You can learn a lot about the solution with the Dependency Graph even before you saw a line of code.</p><h3 id="cyclomatic-complexity">Cyclomatic Complexity</h3><p>The cyclomatic complexity is a metric that is used to indicate the complexity of code. It measures every available path through a method or class. For example, the following method has a cyclomatic complexity of 2 because there are two available paths.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="kt">string</span> <span class="nf">SoSomething</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"zero"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"not zero"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>A rule of thumb is that a method should not have a cyclomatic complexity of more than 7. More than 7 means that the code is too complicated to efficiently understand and change.</p><p>NDepend gives you a graphical overview of all namespaces and their cyclomatic complexity. Click on Extensions –&gt; NDepend –&gt; Code Metrics. There you can select the level, for example, method or namespace, and what you want to display. Select Cyclomatic Complexity and then Top 10. This highlights the 10 methods with the highest complexity.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Code-metrics-overview.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Code-metrics-overview.jpg" alt="Code metrics overview" /></a><p> Code metrics overview</p></div><p>I am not a big fan of the optical presentation but it can give you a starting point to look into the most complex methods. The list of the top 10 methods is way more useful to me. You can find it on the right when you use the Code Metrics or you can click on Method Complexity on the dashboard-</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Cyclomatic-complexity-top-10.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Cyclomatic-complexity-top-10.jpg" alt="Cyclomatic complexity top 10" /></a><p> Cyclomatic complexity top 10</p></div><p>The list tells you the Namespace, class, and method and its cyclomatic complexity. Even before looking into the code, you can see that it’s terrible because the complexity is in the hundreds. Remember, the rule of thumb says not more than 7 and then you see 123 or even 253 here. This is going to be a problem if developers have to touch this code.</p><h3 id="technical-debt">Technical Debt</h3><p>Technical debt describes the impact of the cost of additional work when you choose to implement a feature as fast as possible instead of taking a better approach. The more technical debt you acquire, the harder it will be to implement new features. That is the reason why projects which are 3-5 year olds see a drastic increase in time needed per feature.</p><p>Let’s look at a real-life example. Instead of saving 20 years for a house, you take the shortcut and get a mortgage from the bank. You have to repay the debt with interest over the next 20 years. If you don’t repay the debt, it will increase due to the interest until you are unable to repay the mortgage and the bank will take your house.</p><p>The same principle applies in software. If you always take shortcuts, the debt will increase until it’s too much and it will be almost impossible to implement new features because you introduce too many new features or have to change too much code.</p><p>The NDepend dashboard shows the technical debt percentage, gives a rating, and estimates how much work you would need to invest to fix this debt.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/The-NDepend-dashboard.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/The-NDepend-dashboard.jpg" alt="The NDepend dashboard" /></a><p> The NDepend dashboard</p></div><p>AS you can see NDepend calculated the technical debt with 38.16%, gave the rating D, and estimates that it will take 856 days, or 3 years to fix it. No technical debt is not the goal and even if these 856 are estimated too high, it gives you an idea about the condition of the solution. With the complex dependencies, the missing code coverage combined with the technical debt, I can say that the NopCommerce solution is in pretty bad shape, even before looking at the code itself.</p><p>NDepend aims at pointing out problems but also at helping you to resolve them. If you click on debt on the dashboard, you can see all issues listed on the right side.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/02/Overview-of-the-debt.jpg"><img loading="lazy" src="/assets/img/posts/2021/02/Overview-of-the-debt.jpg" alt="Overview of the technical debt" /></a><p> Overview of the technical debt</p></div><p>By default it’s sorted by the time it takes to fix the issues but if you quickly go through the list, it gives you another indication about the bad state of the solution. You see a lot of code should be tested, method too big, too many parameters, type too big, too many fields, and so on. This all indicates that the methods and objects are very big and complex. Therefore they are hard to test or extend.</p><h2 id="analyze-the-software-architecture">Analyze the Software Architecture</h2><p>So far, I used NDepend to get an overview of all the problems and get an indication that the NopCommerce solution is in a pretty bad state. But even if NDepend said that everything is good, the condition could be really bad. In this section, I want to show you a couple of fast indications to get a first opinion of the state of the project.</p><h3 id="test-quality">Test Quality</h3><p>Code coverage only tells you a part of the story, 7.56% like in NopCommerce is way too low though. Even if you have a high code coverage, you could have bad tests or are missing the edge cases of methods. Let’s have a look at the following method and its test.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="kt">int</span> <span class="nf">Divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">firstNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondNumber</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">firstNumber</span> <span class="p">/</span> <span class="n">secondNumber</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Divide_DividesTwoInts_ShouldReturnResult</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span><span class="p">=</span> <span class="n">_testee</span><span class="p">.</span><span class="nf">Divide</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> 
    <span class="n">result</span><span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">Be</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This results in 100% code coverage. But if you think about the code, you will quickly see some flaws. If the second parameter is 0, you try to divide by 0 which is not allowed, and end in an exception. This means even with your 100% code coverage, your code produces an exception. Another problem you might see is that the result of the division is an integer. This means that the result is rounded and might lead to unexpected results, besides that it is very inaccurate.</p><h4 id="test-quality-in-nopcommerce">Test Quality in NopCommerce</h4><p>As you have seen in the section above, the code coverage gives you the first indication but you always should look at the tests themselves to classify their quality. NopCommerce has a code coverage of merely 7.56% but let’s have a look at the quality of the existing tests. Since we have an ASP.NET Core MVC project, let’s check the tests of the controllers first. Unfortunately, there is only one test and as you can see on the following code sample, even this test is useless and doesn’t help at all.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">TestFixture</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CategoryControllerTests</span> <span class="p">:</span> <span class="n">Nop</span><span class="p">.</span><span class="n">Tests</span><span class="p">.</span><span class="n">TestsBase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">SetUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">SetUp</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If you look through the tests, you will find a couple of tests for validators, automapper config, and models. Most of the tests are useless, for example, creating an object and then checking if the properties you set are still the same value. These tests only help you to get your code coverage percentage up but it doesn’t help the business running good software.</p><p>Missing tests might indicate a problem with the architecture and/or too complicated classes which makes them untestable.</p><h2 id="analyze-the-project-structure">Analyze the Project Structure</h2><p>After checking the lack of tests and the previously discovered complexity of too big classes, methods, and so on, I want to check if that’s the case. To do that I will start at the controllers and then go from layer to layer. I would expect a three-tier architecture where the controller takes a request and then calls a service. The service contains all the business logic and calls a repository. This repository handles all database operations. There could be more layers like a domain layer or a shared code library but this shouldn’t change too much.</p><p>Since NopCommerce is an e-commerce shop, I guess that products, customers, and orders should be one of the main controllers. When you open the ProductController or the OrderController you will see that they have 3403 respectively 2826 lines of code. That is way too many!</p><p>The constructor of the ProductController looks as follows:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="nf">ProductController</span><span class="p">(</span><span class="n">IAclService</span> <span class="n">aclService</span><span class="p">,</span>
    <span class="n">IBackInStockSubscriptionService</span> <span class="n">backInStockSubscriptionService</span><span class="p">,</span>
    <span class="n">ICategoryService</span> <span class="n">categoryService</span><span class="p">,</span>
    <span class="n">ICopyProductService</span> <span class="n">copyProductService</span><span class="p">,</span>
    <span class="n">ICustomerActivityService</span> <span class="n">customerActivityService</span><span class="p">,</span>
    <span class="n">ICustomerService</span> <span class="n">customerService</span><span class="p">,</span>
    <span class="n">IDiscountService</span> <span class="n">discountService</span><span class="p">,</span>
    <span class="n">IDownloadService</span> <span class="n">downloadService</span><span class="p">,</span>
    <span class="n">IExportManager</span> <span class="n">exportManager</span><span class="p">,</span>
    <span class="n">IImportManager</span> <span class="n">importManager</span><span class="p">,</span>
    <span class="n">ILanguageService</span> <span class="n">languageService</span><span class="p">,</span>
    <span class="n">ILocalizationService</span> <span class="n">localizationService</span><span class="p">,</span>
    <span class="n">ILocalizedEntityService</span> <span class="n">localizedEntityService</span><span class="p">,</span>
    <span class="n">IManufacturerService</span> <span class="n">manufacturerService</span><span class="p">,</span>
    <span class="n">INopFileProvider</span> <span class="n">fileProvider</span><span class="p">,</span>
    <span class="n">INotificationService</span> <span class="n">notificationService</span><span class="p">,</span>
    <span class="n">IPdfService</span> <span class="n">pdfService</span><span class="p">,</span>
    <span class="n">IPermissionService</span> <span class="n">permissionService</span><span class="p">,</span>
    <span class="n">IPictureService</span> <span class="n">pictureService</span><span class="p">,</span>
    <span class="n">IProductAttributeParser</span> <span class="n">productAttributeParser</span><span class="p">,</span>
    <span class="n">IProductAttributeService</span> <span class="n">productAttributeService</span><span class="p">,</span>
    <span class="n">IProductModelFactory</span> <span class="n">productModelFactory</span><span class="p">,</span>
    <span class="n">IProductService</span> <span class="n">productService</span><span class="p">,</span>
    <span class="n">IProductTagService</span> <span class="n">productTagService</span><span class="p">,</span>
    <span class="n">ISettingService</span> <span class="n">settingService</span><span class="p">,</span>
    <span class="n">IShippingService</span> <span class="n">shippingService</span><span class="p">,</span>
    <span class="n">IShoppingCartService</span> <span class="n">shoppingCartService</span><span class="p">,</span>
    <span class="n">ISpecificationAttributeService</span> <span class="n">specificationAttributeService</span><span class="p">,</span>
    <span class="n">IStoreContext</span> <span class="n">storeContext</span><span class="p">,</span>
    <span class="n">IUrlRecordService</span> <span class="n">urlRecordService</span><span class="p">,</span>
    <span class="n">IWorkContext</span> <span class="n">workContext</span><span class="p">,</span>
    <span class="n">VendorSettings</span> <span class="n">vendorSettings</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_aclService</span> <span class="p">=</span> <span class="n">aclService</span><span class="p">;</span>
    <span class="n">_backInStockSubscriptionService</span> <span class="p">=</span> <span class="n">backInStockSubscriptionService</span><span class="p">;</span>
    <span class="n">_categoryService</span> <span class="p">=</span> <span class="n">categoryService</span><span class="p">;</span>
    <span class="n">_copyProductService</span> <span class="p">=</span> <span class="n">copyProductService</span><span class="p">;</span>
    <span class="n">_customerActivityService</span> <span class="p">=</span> <span class="n">customerActivityService</span><span class="p">;</span>
    <span class="n">_customerService</span> <span class="p">=</span> <span class="n">customerService</span><span class="p">;</span>
    <span class="n">_discountService</span> <span class="p">=</span> <span class="n">discountService</span><span class="p">;</span>
    <span class="n">_downloadService</span> <span class="p">=</span> <span class="n">downloadService</span><span class="p">;</span>
    <span class="n">_exportManager</span> <span class="p">=</span> <span class="n">exportManager</span><span class="p">;</span>
    <span class="n">_importManager</span> <span class="p">=</span> <span class="n">importManager</span><span class="p">;</span>
    <span class="n">_languageService</span> <span class="p">=</span> <span class="n">languageService</span><span class="p">;</span>
    <span class="n">_localizationService</span> <span class="p">=</span> <span class="n">localizationService</span><span class="p">;</span>
    <span class="n">_localizedEntityService</span> <span class="p">=</span> <span class="n">localizedEntityService</span><span class="p">;</span>
    <span class="n">_manufacturerService</span> <span class="p">=</span> <span class="n">manufacturerService</span><span class="p">;</span>
    <span class="n">_fileProvider</span> <span class="p">=</span> <span class="n">fileProvider</span><span class="p">;</span>
    <span class="n">_notificationService</span> <span class="p">=</span> <span class="n">notificationService</span><span class="p">;</span>
    <span class="n">_pdfService</span> <span class="p">=</span> <span class="n">pdfService</span><span class="p">;</span>
    <span class="n">_permissionService</span> <span class="p">=</span> <span class="n">permissionService</span><span class="p">;</span>
    <span class="n">_pictureService</span> <span class="p">=</span> <span class="n">pictureService</span><span class="p">;</span>
    <span class="n">_productAttributeParser</span> <span class="p">=</span> <span class="n">productAttributeParser</span><span class="p">;</span>
    <span class="n">_productAttributeService</span> <span class="p">=</span> <span class="n">productAttributeService</span><span class="p">;</span>
    <span class="n">_productModelFactory</span> <span class="p">=</span> <span class="n">productModelFactory</span><span class="p">;</span>
    <span class="n">_productService</span> <span class="p">=</span> <span class="n">productService</span><span class="p">;</span>
    <span class="n">_productTagService</span> <span class="p">=</span> <span class="n">productTagService</span><span class="p">;</span>
    <span class="n">_settingService</span> <span class="p">=</span> <span class="n">settingService</span><span class="p">;</span>
    <span class="n">_shippingService</span> <span class="p">=</span> <span class="n">shippingService</span><span class="p">;</span>
    <span class="n">_shoppingCartService</span> <span class="p">=</span> <span class="n">shoppingCartService</span><span class="p">;</span>
    <span class="n">_specificationAttributeService</span> <span class="p">=</span> <span class="n">specificationAttributeService</span><span class="p">;</span>
    <span class="n">_storeContext</span> <span class="p">=</span> <span class="n">storeContext</span><span class="p">;</span>
    <span class="n">_urlRecordService</span> <span class="p">=</span> <span class="n">urlRecordService</span><span class="p">;</span>
    <span class="n">_workContext</span> <span class="p">=</span> <span class="n">workContext</span><span class="p">;</span>
    <span class="n">_vendorSettings</span> <span class="p">=</span> <span class="n">vendorSettings</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>There are a couple of important principles in software development. My favorite is the Single Responsible Principle (SRP) and Keep it simple stupid (KISS). If you see a constructor like this you already know that this class does more than one thing and is not simple at all. A massive constructor like this makes it also almost impossible to test because you have to fake every parameter before you can even start writing your first test.</p><h3 id="complexity-of-methods">Complexity of methods</h3><p>In the previous section, I analyzed that the controllers are way too complicated. In this section, I will look into a method and try to find the service and repository layer (if they exist) and analyze their complexity. An online store needs products and without knowing anything about online shops, I would guess that this is a simple operation and therefore the method should be simple. Unfortunately, that’s not the case in NopCommerce. NDepend analyzed a cyclomatic complexity of 53 which is way higher than the maximum recommended 7. The method has almost 200 lines of code and looks as follows:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">HttpPost</span><span class="p">,</span> <span class="nf">ParameterBasedOnFormName</span><span class="p">(</span><span class="s">"save-continue"</span><span class="p">,</span> <span class="s">"continueEditing"</span><span class="p">)]</span>
<span class="p">[</span><span class="nf">FormValueRequired</span><span class="p">(</span><span class="s">"save"</span><span class="p">,</span> <span class="s">"save-continue"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">virtual</span> <span class="n">IActionResult</span> <span class="nf">Create</span><span class="p">(</span><span class="n">CustomerModel</span> <span class="n">model</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">continueEditing</span><span class="p">,</span> <span class="n">IFormCollection</span> <span class="n">form</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">_permissionService</span><span class="p">.</span><span class="nf">Authorize</span><span class="p">(</span><span class="n">StandardPermissionProvider</span><span class="p">.</span><span class="n">ManageCustomers</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AccessDeniedView</span>
    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">_customerService</span><span class="p">.</span><span class="nf">GetCustomerByEmail</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="s">"Email is already registered"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Username</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">_customerSettings</span><span class="p">.</span><span class="n">UsernamesEnabled</span> <span class="p">&amp;&amp;</span>
        <span class="n">_customerService</span><span class="p">.</span><span class="nf">GetCustomerByUsername</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Username</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="s">"Username is already registered"</span><span class="p">);</span>

    <span class="c1">//validate customer roles</span>
    <span class="kt">var</span> <span class="n">allCustomerRoles</span> <span class="p">=</span> <span class="n">_customerService</span><span class="p">.</span><span class="nf">GetAllCustomerRoles</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">newCustomerRoles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">CustomerRole</span><span class="p">&gt;();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">customerRole</span> <span class="k">in</span> <span class="n">allCustomerRoles</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">SelectedCustomerRoleIds</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">customerRole</span><span class="p">.</span><span class="n">Id</span><span class="p">))</span>
            <span class="n">newCustomerRoles</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">customerRole</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">customerRolesError</span> <span class="p">=</span> <span class="nf">ValidateCustomerRoles</span><span class="p">(</span><span class="n">newCustomerRoles</span><span class="p">,</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">CustomerRole</span><span class="p">&gt;());</span>
    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">customerRolesError</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">customerRolesError</span><span class="p">);</span>
        <span class="n">_notificationService</span><span class="p">.</span><span class="nf">ErrorNotification</span><span class="p">(</span><span class="n">customerRolesError</span><span class="p">);</span>

    <span class="c1">// Ensure that valid email address is entered if Registered role is checked to avoid registered customers with empty email address</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newCustomerRoles</span><span class="p">.</span><span class="nf">Any</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">newCustomerRoles</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">SystemName</span> <span class="p">==</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">RegisteredRoleName</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span>
        <span class="p">!</span><span class="n">CommonHelper</span><span class="p">.</span><span class="nf">IsValidEmail</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Email</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"Admin.Customers.Customers.ValidEmailRequiredRegisteredRole"</span>
        <span class="n">_notificationService</span><span class="p">.</span><span class="nf">ErrorNotification</span><span class="p">(</span><span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"Admin.Customers.Customers.ValidEmailRequiredRegisteredRole"</span><span class="p">));</span>

    <span class="c1">//custom customer attributes</span>
    <span class="kt">var</span> <span class="n">customerAttributesXml</span> <span class="p">=</span> <span class="nf">ParseCustomCustomerAttributes</span><span class="p">(</span><span class="n">form</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newCustomerRoles</span><span class="p">.</span><span class="nf">Any</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">newCustomerRoles</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">SystemName</span> <span class="p">==</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">RegisteredRoleName</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">customerAttributeWarnings</span> <span class="p">=</span> <span class="n">_customerAttributeParser</span><span class="p">.</span><span class="nf">GetAttributeWarnings</span><span class="p">(</span><span class="n">customerAttributesXml</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">error</span> <span class="k">in</span> <span class="n">customerAttributeWarnings</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//fill entity from model</span>
        <span class="kt">var</span> <span class="n">customer</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">ToEntity</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span>
        <span class="n">customer</span><span class="p">.</span><span class="n">CustomerGuid</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">();</span>
        <span class="n">customer</span><span class="p">.</span><span class="n">CreatedOnUtc</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="n">customer</span><span class="p">.</span><span class="n">LastActivityDateUtc</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="n">customer</span><span class="p">.</span><span class="n">RegisteredInStoreId</span> <span class="p">=</span> <span class="n">_storeContext</span><span class="p">.</span><span class="n">CurrentStore</span><span class="p">.</span>
        <span class="n">_customerService</span><span class="p">.</span><span class="nf">InsertCustomer</span><span class="p">(</span><span class="n">custome</span>
        <span class="c1">//form fields</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_dateTimeSettings</span><span class="p">.</span><span class="n">AllowCustomersToSetTimeZone</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">TimeZoneIdAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">TimeZoneId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">GenderEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">GenderAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">Gender</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">FirstNameEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">FirstNameAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">FirstName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">LastNameEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">LastNameAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">DateOfBirthEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">DateOfBirthAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">DateOfBirth</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">CompanyEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">CompanyAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">Company</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">StreetAddressEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">StreetAddressAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">StreetAddress</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">StreetAddress2Enabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">StreetAddress2Attribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">StreetAddress2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">ZipPostalCodeEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">ZipPostalCodeAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">ZipPostalCode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">CityEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">CityAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">City</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">CountyEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">CountyAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">County</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">CountryEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">CountryIdAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">CountryId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">CountryEnabled</span> <span class="p">&amp;&amp;</span> <span class="n">_customerSettings</span><span class="p">.</span><span class="n">StateProvinceEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">StateProvinceIdAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">StateProvinceId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">PhoneEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">PhoneAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">Phone</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerSettings</span><span class="p">.</span><span class="n">FaxEnabled</span><span class="p">)</span>
            <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">FaxAttribute</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">Fa</span>
        <span class="c1">//custom customer attributes</span>
        <span class="n">_genericAttributeService</span><span class="p">.</span><span class="nf">SaveAttribute</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">CustomCustomerAttributes</span><span class="p">,</span> <span class="n">customerAttributesXm</span>
        <span class="c1">//newsletter subscriptions</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">customer</span><span class="p">.</span><span class="n">Email</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">allStores</span> <span class="p">=</span> <span class="n">_storeService</span><span class="p">.</span><span class="nf">GetAllStores</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">store</span> <span class="k">in</span> <span class="n">allStores</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">newsletterSubscription</span> <span class="p">=</span> <span class="n">_newsLetterSubscriptionService</span>
                    <span class="p">.</span><span class="nf">GetNewsLetterSubscriptionByEmailAndStoreId</span><span class="p">(</span><span class="n">customer</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">SelectedNewsletterSubscriptionStoreIds</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span>
                    <span class="n">model</span><span class="p">.</span><span class="n">SelectedNewsletterSubscriptionStoreIds</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">Id</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//subscribed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">newsletterSubscription</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">_newsLetterSubscriptionService</span><span class="p">.</span><span class="nf">InsertNewsLetterSubscription</span><span class="p">(</span><span class="k">new</span> <span class="n">NewsLetterSubscription</span>
                        <span class="p">{</span>
                            <span class="n">NewsLetterSubscriptionGuid</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">(),</span>
                            <span class="n">Email</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
                            <span class="n">Active</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                            <span class="n">StoreId</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
                            <span class="n">CreatedOnUtc</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span>
                        <span class="p">});</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">//not subscribed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">newsletterSubscription</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">_newsLetterSubscriptionService</span><span class="p">.</span><span class="nf">DeleteNewsLetterSubscription</span><span class="p">(</span><span class="n">newsletterSubscription</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
    
        <span class="c1">//password</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Password</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">changePassRequest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ChangePasswordRequest</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">_customerSettings</span><span class="p">.</span><span class="n">DefaultPasswordFormat</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">Password</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">changePassResult</span> <span class="p">=</span> <span class="n">_customerRegistrationService</span><span class="p">.</span><span class="nf">ChangePassword</span><span class="p">(</span><span class="n">changePassRequest</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">changePassResult</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">changePassError</span> <span class="k">in</span> <span class="n">changePassResult</span><span class="p">.</span><span class="n">Errors</span><span class="p">)</span>
                    <span class="n">_notificationService</span><span class="p">.</span><span class="nf">ErrorNotification</span><span class="p">(</span><span class="n">changePassError</span><span class="p">);</span>
            <span class="p">}</span>
    
        <span class="c1">//customer roles</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">customerRole</span> <span class="k">in</span> <span class="n">newCustomerRoles</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//ensure that the current customer cannot add to "Administrators" system role if he's not an admin himself</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">customerRole</span><span class="p">.</span><span class="n">SystemName</span> <span class="p">==</span> <span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">AdministratorsRoleName</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">_customerService</span><span class="p">.</span><span class="nf">IsAdmin</span><span class="p">(</span><span class="n">_workContext</span><span class="p">.</span><span class="n">CurrentCustomer</span><span class="p">))</span>
                <span class="n">contin</span>
            <span class="n">_customerService</span><span class="p">.</span><span class="nf">AddCustomerRoleMapping</span><span class="p">(</span><span class="k">new</span> <span class="n">CustomerCustomerRoleMapping</span> <span class="p">{</span> <span class="n">CustomerId</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">CustomerRoleId</span> <span class="p">=</span> <span class="n">customerRole</span><span class="p">.</span><span class="n">Id</span> <span class="p">});</span>
    
        <span class="n">_customerService</span><span class="p">.</span><span class="nf">UpdateCustomer</span><span class="p">(</span><span class="n">custome</span>
        <span class="c1">//ensure that a customer with a vendor associated is not in "Administrators" role</span>
        <span class="c1">//otherwise, he won't have access to other functionality in admin area</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerService</span><span class="p">.</span><span class="nf">IsAdmin</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">customer</span><span class="p">.</span><span class="n">VendorId</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">customer</span><span class="p">.</span><span class="n">VendorId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="n">_customerService</span><span class="p">.</span><span class="nf">UpdateCustomer</span><span class="p">(</span><span class="n">custome</span>
            <span class="n">_notificationService</span><span class="p">.</span><span class="nf">ErrorNotification</span><span class="p">(</span><span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"Admin.Customers.Customers.AdminCouldNotbeVendor"</span><span class="p">));</span>
    
        <span class="c1">//ensure that a customer in the Vendors role has a vendor account associated.</span>
        <span class="c1">//otherwise, he will have access to ALL products</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_customerService</span><span class="p">.</span><span class="nf">IsVendor</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">customer</span><span class="p">.</span><span class="n">VendorId</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">vendorRole</span> <span class="p">=</span> <span class="n">_customerService</span><span class="p">.</span><span class="nf">GetCustomerRoleBySystemName</span><span class="p">(</span><span class="n">NopCustomerDefaults</span><span class="p">.</span><span class="n">VendorsRoleName</span><span class="p">);</span>
            <span class="n">_customerService</span><span class="p">.</span><span class="nf">RemoveCustomerRoleMapping</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">vendorRol</span>
            <span class="n">_notificationService</span><span class="p">.</span><span class="nf">ErrorNotification</span><span class="p">(</span><span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"Admin.Customers.Customers.CannotBeInVendoRoleWithoutVendorAssociated"</span><span class="p">));</span>
    
        <span class="c1">//activity log</span>
        <span class="n">_customerActivityService</span><span class="p">.</span><span class="nf">InsertActivity</span><span class="p">(</span><span class="s">"AddNewCustomer"</span><span class="p">,</span>
            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"ActivityLog.AddNewCustomer"</span><span class="p">),</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span><span class="p">),</span> <span class="n">customer</span><span class="p">);</span>
        <span class="n">_notificationService</span><span class="p">.</span><span class="nf">SuccessNotification</span><span class="p">(</span><span class="n">_localizationService</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(</span><span class="s">"Admin.Customers.Customers.Added"</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">continueEditing</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"List"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Edit"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span> <span class="p">});</span>

    <span class="c1">//prepare model</span>
    <span class="n">model</span> <span class="p">=</span> <span class="n">_customerModelFactory</span><span class="p">.</span><span class="nf">PrepareCustomerModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">tru</span>
    <span class="c1">//if we got this far, something failed, redisplay form</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>A controller should only take the request and then call services that handle the business logic. From a first glimpse, it looks like the controller does all the business logic already. This would also mean that you can’t reuse the code to create a product because it is in the controller and not in a service class. Additionally, the controller does way more than creating a product that violates the Single Responsible Principle. Due to its insanely high complexity, it is also almost impossible to write adequate tests for the code.</p><p>Previously, I said that I will dive down the different layers but after seeing the controller I feel like I have seen enough to give a first verdict.</p><h2 id="code-reusability-and-apis">Code Reusability and APIs</h2><p>Code reusability is an important factor when it comes to development speed and maintenance costs in the future. I like microservices and one feature of them is that they have many APIs which allow code to be shared easily.</p><p>Let’s look at the following use case: you have your NopCommerce online shop and then get the task to develop a mobile app for your store. With a modern microservice architecture, you only have to build the mobile app which then calls all your APIs to load data or create orders. This should be done fairly quickly. What about our existing NopCommerce solution?</p><p>As far as I have seen there are no APIs in the whole solution and as previously mentioned, all the business logic is in the controller. This means that it is not even possible to create a shared library of the service layer to share the code with the mobile app. While looking over the controller methods, I also saw that security checks like if the user has the right role are done in each controller method. Additionally, these checks read certain cookie values that are tied to the online shop and won’t be available in your mobile app.</p><p>I have spent maybe half an hour in the code but can already tell you that it’s not possible to reuse the code without a lot of unnecessary extra work.</p><h2 id="last-thoughts-on-analyzing-software-architecture">Last Thoughts on Analyzing Software Architecture</h2><p>You can analyze the software architecture of a project with many goals in mind. It totally depends on the requirements of your analyzes. For example, if you should find out why software is running slowly, you would use a profiler or some measurement tools to find out which parts of your software are running slow. Then you can focus on these areas to improve the performance.</p><p>Another aspect of analyzing a software project could be the deployment process. I haven’t talked about this at all but in a modern DevOps culture, all changes should be automatically tested and deployed (either after a change is committed or at the end of a sprint) and also should be reviewed before it gets merged in your master branch. Analyzing this process could span the build and deployment pipeline, what technologies are used, for example, Docker, and go even as far as analyzing how running the software works. For example, if you run it in Kubernetes with auto-scaling or if your application just crashes when it’s out of resources.</p><p>Even if it’s not directly analyzing the software architecture, it makes sense to look at the planned and recently finished features. If there are only new features and no refactoring tasks and if the features took quite some time, you can already guess that the software is in a bad shape. Here it is also your job as a consultant or architect to intervene and try to convince the product owner/manager to spend more time refactoring.</p><h2 id="conclusion">Conclusion</h2><p>This post gave you a high-level overview of how you can get started when analyzing the architecture of a software project. Look out for untestable code because this is often an indication of too complex code or a bad software architecture and keep software principles like the Single Responsible Principle, Separation of Concerns, and KISS in mind. Use tools to get a starting point and then start there to dive into the solution in more detail.</p><p>I used NDepend to analyze the NopCommerce solution and get an overview of its state. If this post sounded like bashing NopCommerce, this was not my intention. I used it because I wanted to show you a realistic piece of software and pointed out my findings. If they were all great I would have mentioned that too. Unfortunately, the negative ones totally outranked the good ones. I hope NDepend improves the installation process in the future so you can install it as an extension in Visual Studio without downloading and keeping the NDepend folder somewhere on your computer.</p><p>NDepend was easy to use and give me a great overview of the state of the project and provided useful links to dive into the pain points of the solution. For example, I found quickly super complicated methods and could fairly easily make a list of the top 10 things I want to improve. I am not believing too much in the amount of work it tells me to fix the technical debt but it gives me an indication. 856 days is massive and should be definitively lower. Also, the graphs on the dashboard are nice to point out the trend where the project is going. If the graphs show that the technical debt went up by quite a bit over the last month, it might be easier to convince your manager to do fewer new features and fix more of the technical debt in the next sprint.</p><p>I mentioned a couple of times that I am a big fan of microservices. If you want to learn more about microservices, see my series <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><p>Note: NDepend provided me with a free license but they didn’t get a preview version of this article nor do I accept any change requests in this article from them. Everything written here is my independent opinion.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/miscellaneous/'>Miscellaneous</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/software-architecture/" class="post-tag no-text-decoration" >Software Architecture</a> <a href="/tags/tools/" class="post-tag no-text-decoration" >Tools</a> <a href="/tags/ndepend/" class="post-tag no-text-decoration" >NDepend</a> <a href="/tags/net-core-3-1/" class="post-tag no-text-decoration" >NET Core 3.1</a> <a href="/tags/c/" class="post-tag no-text-decoration" >C#</a> <a href="/tags/asp-net-core-mvc/" class="post-tag no-text-decoration" >ASP.NET Core MVC</a> <a href="/tags/visual-studio/" class="post-tag no-text-decoration" >Visual Studio</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analyze Software Architecture with NDepend - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Analyze Software Architecture with NDepend - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Analyze Software Architecture with NDepend - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/automatically-version-docker-container/">Automatically Version Docker Containers in Azure DevOps CI</a><li><a href="/create-nuget-azure-devops/">Create NuGet Packages in Azure DevOps Pipelines</a><li><a href="/manage-resources-kubernetes/">Manage Resources in Kubernetes</a><li><a href="/helm-getting-started/">Helm - Getting Started</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/70-532/">70-532</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/net-core/">NET Core</a> <a class="post-tag" href="/tags/ci/">CI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/cross-site-request-forgery-csrf-in-asp-net-core/"><div class="card-body"> <span class="timeago small" > Jun 15, 2020 <i class="unloaded">2020-06-15T08:42:05+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cross Site Request Forgery (CSRF) in ASP .NET Core</h3><div class="text-muted small"><p> Cross Site Request Forgery, also known as session riding is an exploit where attackers trick users to send requests that they don’t know about and don’t want to do. It was on the OWASP Top 10 every...</p></div></div></a></div><div class="card"> <a href="/cross-site-scripting-in-asp-net-core/"><div class="card-body"> <span class="timeago small" > Jun 17, 2020 <i class="unloaded">2020-06-17T09:42:15+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cross Site Scripting (XSS) in ASP .NET Core</h3><div class="text-muted small"><p> Cross Site Scripting (XSS) is an attack where attackers inject code into a website which is then executed. XSS is on place seven of the OWASP Top 10 list of 2017 but could be easily avoided. In thi...</p></div></div></a></div><div class="card"> <a href="/proxy-pattern-in-net-core/"><div class="card-body"> <span class="timeago small" > Jun 27, 2020 <i class="unloaded">2020-06-27T18:25:18+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Proxy Pattern in .NET Core</h3><div class="text-muted small"><p> The proxy pattern belongs to the group of structural patterns and is often used for cross cutting-concerns. Proxies can be used to control access, logging, and security features. Another advantage ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/improve-azure-devops-pipelines-templates/" class="btn btn-outline-primary"><p>Improve Azure DevOps YAML Pipelines with Templates</p></a> <a href="/manage-resources-kubernetes/" class="btn btn-outline-primary"><p>Manage Resources in Kubernetes</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/analyze-software-architecture-ndepend/'; this.page.identifier = '/analyze-software-architecture-ndepend/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/70-532/">70 532</a> <a class="post-tag" href="/tags/certification/">Certification</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/exam/">Exam</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/net-core/">NET Core</a> <a class="post-tag" href="/tags/ci/">CI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
