<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run the CI Pipeline during a Pull Request | Programming With Wolfgang</title><meta name="generator" content="Jekyll v4.1.0" /><meta property="og:title" content="Run the CI Pipeline during a Pull Request" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="In the modern DevOps culture, the goal is to get features as fast as possible into production. Additionally, we have to guarantee that these new features don’t break anything. To do that, I will show in this post how to protect the master branch with a policy that enforces a pull request (PR) and reviews. To further enhance the quality, I will show how to run the CI pipeline from my last post, which builds the solutions and runs all unit tests. Protect the Master Branch with a Pull Request Policy To create a new policy go to Project settings  –&gt; Repositories –&gt; Policies –&gt; Branch policies and there click the + button. Create a new Branch Policy This opens a fly-out where you can select either of the two options. I select “Protect current and future branches matching a specified pattern” and enter master as the branch name. This means that this policy is only valid for the master branch. Then click Create. Add a Pull Request Policy for the master branch This opens the Branch Policies menu where you can configure your pull request. Configure the Branch Policy First, I require one reviewer, allow the requestor to approve their changes, and reset the vote every time new changes are committed. Usually, I don’t allow the requestor to approve their changes but since I am alone in this demo project I allow it. Microsoft recommends that two reviewers should check the pull request for the highest quality. Configure the minimum number of reviewers Next, I require every pull request to be linked with a work item. There should never be code changes without a PBI or Bug ticket describing the desired changes. Therefore, this is required. Check for linked work items Reviewers provide their feedback with comments, therefore, I require all comments to be resolved before a pull request can be completed. In my projects, always the creator of the comment resolves the comment and not the creator of the PR. Configure comment resolution Companies have different merge strategies. Some use squash merges, some do rebase and some do just basic merges. It is good to have a merge strategy and limit the pull request to your strategy. In my projects, I do squash merges because I don’t care about all the commits during the development. I only care about the finished feature commit, therefore, I only allow squash merges. Limit the merge types Configure automatic Builds Now we come to the most interesting part of the policy. I add a build policy and select the previously created CustomerApi CI pipeline.  You can find the post here. I set /CustomerApi/* as path filter. The automatic trigger starts the build every time changes are committed inside the CustomerApi folder and the build expires after 12 hours. This means if the pull request is not completed within 12 hours, the build has to be triggered again. Add a build policy for the CustomerApi to the Pull Request Add another build policy for the OrderApi and enter /OrderApi/* as path filter. Click on Save and the policy is configured and created. Make changes to the Code I added a new unit test, commit the changes to the master branch, and push the changes. Due to the policy on the master branch, I am not allowed to push changes directly to the master branch, as seen on the following screenshot. Pushing directly to master is not allowed Since the master branch is protected, I have to create a feature branch. I name this branch addunittest and push the changes to Azure DevOps. Pushing a new branch In Azure DevOps under Repos –&gt; Files, you can see that Azure DevOps registered the changes and already suggest to create a new PR. Click on Create a pull request and you will get into a new window. Create a new Pull Request Create a new Pull Request Add a title, and optionally a description, reviewers, and work items. I like to have 1-3 sentences in the description to explain what you did. As the title, I usually use the PBI number and the PBI title (not in this example though). New Pull Request After the pull request is created, the build will kick off immediately, and also all other required policies will be checked. As you can see on the following screenshot, the build failed due to a failing test, no work item is linked and not all comments are resolved. Therefore, I can’t complete the PR. Required checks failed I fixed my unit test, added a link to the PB,I and fixed the suggested changes from the comment. The comment creator resolved the comment and this enabled me to complete the pull request. On the following screenshot, you can see that I also changed the title of the PR to have to PBI number and title in it. All checks passed Complete the Pull Request When you click on Complete, you can select a merge type. Since I restricted the merge strategy to squash commit only, I can’t select any other strategy. Only Squash commit is allowed by the Pull Request policy The definition of done in my projects is that the PBI is set to done when the pull request is finished (because we deploy the feature automatically to prod when thePR is completed). Additionally, I select to delete my branch after merging. Complete the Pull Request The PR creator can also select auto-complete to complete the pull request automatically when all required checks are OK. After the merge to master is completed, the CI pipeline automatically kicks off a build of the master branch. The master branch trigger a CI build Conclusion In this post, I explained how to protect the master branch from changes in Azure DevOps. I showed how to add a branch policy to the master branch in Azure DevOps and also how to run a build process to check if the solution compiles and if all tests run successfully. You can find the code of this demo on GitHub." /><meta property="og:description" content="In the modern DevOps culture, the goal is to get features as fast as possible into production. Additionally, we have to guarantee that these new features don’t break anything. To do that, I will show in this post how to protect the master branch with a policy that enforces a pull request (PR) and reviews. To further enhance the quality, I will show how to run the CI pipeline from my last post, which builds the solutions and runs all unit tests. Protect the Master Branch with a Pull Request Policy To create a new policy go to Project settings  –&gt; Repositories –&gt; Policies –&gt; Branch policies and there click the + button. Create a new Branch Policy This opens a fly-out where you can select either of the two options. I select “Protect current and future branches matching a specified pattern” and enter master as the branch name. This means that this policy is only valid for the master branch. Then click Create. Add a Pull Request Policy for the master branch This opens the Branch Policies menu where you can configure your pull request. Configure the Branch Policy First, I require one reviewer, allow the requestor to approve their changes, and reset the vote every time new changes are committed. Usually, I don’t allow the requestor to approve their changes but since I am alone in this demo project I allow it. Microsoft recommends that two reviewers should check the pull request for the highest quality. Configure the minimum number of reviewers Next, I require every pull request to be linked with a work item. There should never be code changes without a PBI or Bug ticket describing the desired changes. Therefore, this is required. Check for linked work items Reviewers provide their feedback with comments, therefore, I require all comments to be resolved before a pull request can be completed. In my projects, always the creator of the comment resolves the comment and not the creator of the PR. Configure comment resolution Companies have different merge strategies. Some use squash merges, some do rebase and some do just basic merges. It is good to have a merge strategy and limit the pull request to your strategy. In my projects, I do squash merges because I don’t care about all the commits during the development. I only care about the finished feature commit, therefore, I only allow squash merges. Limit the merge types Configure automatic Builds Now we come to the most interesting part of the policy. I add a build policy and select the previously created CustomerApi CI pipeline.  You can find the post here. I set /CustomerApi/* as path filter. The automatic trigger starts the build every time changes are committed inside the CustomerApi folder and the build expires after 12 hours. This means if the pull request is not completed within 12 hours, the build has to be triggered again. Add a build policy for the CustomerApi to the Pull Request Add another build policy for the OrderApi and enter /OrderApi/* as path filter. Click on Save and the policy is configured and created. Make changes to the Code I added a new unit test, commit the changes to the master branch, and push the changes. Due to the policy on the master branch, I am not allowed to push changes directly to the master branch, as seen on the following screenshot. Pushing directly to master is not allowed Since the master branch is protected, I have to create a feature branch. I name this branch addunittest and push the changes to Azure DevOps. Pushing a new branch In Azure DevOps under Repos –&gt; Files, you can see that Azure DevOps registered the changes and already suggest to create a new PR. Click on Create a pull request and you will get into a new window. Create a new Pull Request Create a new Pull Request Add a title, and optionally a description, reviewers, and work items. I like to have 1-3 sentences in the description to explain what you did. As the title, I usually use the PBI number and the PBI title (not in this example though). New Pull Request After the pull request is created, the build will kick off immediately, and also all other required policies will be checked. As you can see on the following screenshot, the build failed due to a failing test, no work item is linked and not all comments are resolved. Therefore, I can’t complete the PR. Required checks failed I fixed my unit test, added a link to the PB,I and fixed the suggested changes from the comment. The comment creator resolved the comment and this enabled me to complete the pull request. On the following screenshot, you can see that I also changed the title of the PR to have to PBI number and title in it. All checks passed Complete the Pull Request When you click on Complete, you can select a merge type. Since I restricted the merge strategy to squash commit only, I can’t select any other strategy. Only Squash commit is allowed by the Pull Request policy The definition of done in my projects is that the PBI is set to done when the pull request is finished (because we deploy the feature automatically to prod when thePR is completed). Additionally, I select to delete my branch after merging. Complete the Pull Request The PR creator can also select auto-complete to complete the pull request automatically when all required checks are OK. After the merge to master is completed, the CI pipeline automatically kicks off a build of the master branch. The master branch trigger a CI build Conclusion In this post, I explained how to protect the master branch from changes in Azure DevOps. I showed how to add a branch policy to the master branch in Azure DevOps and also how to run a build process to check if the solution compiles and if all tests run successfully. You can find the code of this demo on GitHub." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-17T16:34:44+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Run the CI Pipeline during a Pull Request" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"url":"https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/","@type":"BlogPosting","headline":"Run the CI Pipeline during a Pull Request","dateModified":"2020-10-17T16:34:44+02:00","datePublished":"2020-10-17T16:34:44+02:00","author":{"@type":"Person","name":"Wolfgang Ofner"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/"},"description":"In the modern DevOps culture, the goal is to get features as fast as possible into production. Additionally, we have to guarantee that these new features don’t break anything. To do that, I will show in this post how to protect the master branch with a policy that enforces a pull request (PR) and reviews. To further enhance the quality, I will show how to run the CI pipeline from my last post, which builds the solutions and runs all unit tests. Protect the Master Branch with a Pull Request Policy To create a new policy go to Project settings  –&gt; Repositories –&gt; Policies –&gt; Branch policies and there click the + button. Create a new Branch Policy This opens a fly-out where you can select either of the two options. I select “Protect current and future branches matching a specified pattern” and enter master as the branch name. This means that this policy is only valid for the master branch. Then click Create. Add a Pull Request Policy for the master branch This opens the Branch Policies menu where you can configure your pull request. Configure the Branch Policy First, I require one reviewer, allow the requestor to approve their changes, and reset the vote every time new changes are committed. Usually, I don’t allow the requestor to approve their changes but since I am alone in this demo project I allow it. Microsoft recommends that two reviewers should check the pull request for the highest quality. Configure the minimum number of reviewers Next, I require every pull request to be linked with a work item. There should never be code changes without a PBI or Bug ticket describing the desired changes. Therefore, this is required. Check for linked work items Reviewers provide their feedback with comments, therefore, I require all comments to be resolved before a pull request can be completed. In my projects, always the creator of the comment resolves the comment and not the creator of the PR. Configure comment resolution Companies have different merge strategies. Some use squash merges, some do rebase and some do just basic merges. It is good to have a merge strategy and limit the pull request to your strategy. In my projects, I do squash merges because I don’t care about all the commits during the development. I only care about the finished feature commit, therefore, I only allow squash merges. Limit the merge types Configure automatic Builds Now we come to the most interesting part of the policy. I add a build policy and select the previously created CustomerApi CI pipeline.  You can find the post here. I set /CustomerApi/* as path filter. The automatic trigger starts the build every time changes are committed inside the CustomerApi folder and the build expires after 12 hours. This means if the pull request is not completed within 12 hours, the build has to be triggered again. Add a build policy for the CustomerApi to the Pull Request Add another build policy for the OrderApi and enter /OrderApi/* as path filter. Click on Save and the policy is configured and created. Make changes to the Code I added a new unit test, commit the changes to the master branch, and push the changes. Due to the policy on the master branch, I am not allowed to push changes directly to the master branch, as seen on the following screenshot. Pushing directly to master is not allowed Since the master branch is protected, I have to create a feature branch. I name this branch addunittest and push the changes to Azure DevOps. Pushing a new branch In Azure DevOps under Repos –&gt; Files, you can see that Azure DevOps registered the changes and already suggest to create a new PR. Click on Create a pull request and you will get into a new window. Create a new Pull Request Create a new Pull Request Add a title, and optionally a description, reviewers, and work items. I like to have 1-3 sentences in the description to explain what you did. As the title, I usually use the PBI number and the PBI title (not in this example though). New Pull Request After the pull request is created, the build will kick off immediately, and also all other required policies will be checked. As you can see on the following screenshot, the build failed due to a failing test, no work item is linked and not all comments are resolved. Therefore, I can’t complete the PR. Required checks failed I fixed my unit test, added a link to the PB,I and fixed the suggested changes from the comment. The comment creator resolved the comment and this enabled me to complete the pull request. On the following screenshot, you can see that I also changed the title of the PR to have to PBI number and title in it. All checks passed Complete the Pull Request When you click on Complete, you can select a merge type. Since I restricted the merge strategy to squash commit only, I can’t select any other strategy. Only Squash commit is allowed by the Pull Request policy The definition of done in my projects is that the PBI is set to done when the pull request is finished (because we deploy the feature automatically to prod when thePR is completed). Additionally, I select to delete my branch after merging. Complete the Pull Request The PR creator can also select auto-complete to complete the pull request automatically when all required checks are OK. After the merge to master is completed, the CI pipeline automatically kicks off a build of the master branch. The master branch trigger a CI build Conclusion In this post, I explained how to protect the master branch from changes in Azure DevOps. I showed how to add a branch policy to the master branch in Azure DevOps and also how to run a build process to check if the solution compiles and if all tests run successfully. You can find the code of this demo on GitHub.","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); </script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/author/wolfgang-small.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div></div><div class="d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="nav flex-column mt-3"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/wolfgangofner" target="_blank" > <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" target="_blank" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" target="_blank" > <i class="fab fa-linkedin"></i> </a> <a href=" javascript:window.open('mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Run the CI Pipeline during a Pull Request</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Run the CI Pipeline during a Pull Request</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 17, 2020, 4:34 PM +0200" > Oct 17 <i class="unloaded">2020-10-17T16:34:44+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div></div><div class="post-content"><p>In the modern DevOps culture, the goal is to get features as fast as possible into production. Additionally, we have to guarantee that these new features don’t break anything. To do that, I will show in this post how to protect the master branch with a policy that enforces a pull request (PR) and reviews. To further enhance the quality, I will show <a href="/run-the-ci-pipeline-during-pull-request" target="_blank" rel="noopener noreferrer">how to run the CI pipeline from my last post</a>, which builds the solutions and runs all unit tests.</p><h2 id="protect-the-master-branch-with-a-pull-request-policy">Protect the Master Branch with a Pull Request Policy</h2><p>To create a new policy go to Project settings  –&gt; Repositories –&gt; Policies –&gt; Branch policies and there click the + button.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Create-a-new-Branch-Policy.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Create-a-new-Branch-Policy.jpg" alt="Create a new Branch Policy" /></a><p> Create a new Branch Policy</p></div><p>This opens a fly-out where you can select either of the two options. I select “Protect current and future branches matching a specified pattern” and enter master as the branch name. This means that this policy is only valid for the master branch. Then click Create.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Add-a-Pull-Request-Policy-for-the-master-branch.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Add-a-Pull-Request-Policy-for-the-master-branch.jpg" alt="Add a Pull Request Policy for the master branch" /></a><p> Add a Pull Request Policy for the master branch</p></div><p>This opens the Branch Policies menu where you can configure your pull request.</p><h3 id="configure-the-branch-policy">Configure the Branch Policy</h3><p>First, I require one reviewer, allow the requestor to approve their changes, and reset the vote every time new changes are committed. Usually, I don’t allow the requestor to approve their changes but since I am alone in this demo project I allow it. Microsoft recommends that two reviewers should check the pull request for the highest quality.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Configure-the-minimum-number-of-reviewers.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Configure-the-minimum-number-of-reviewers.jpg" alt="Configure the minimum number of reviewers" /></a><p> Configure the minimum number of reviewers</p></div><p>Next, I require every pull request to be linked with a work item. There should never be code changes without a PBI or Bug ticket describing the desired changes. Therefore, this is required.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Check-for-linked-work-items.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Check-for-linked-work-items.jpg" alt="Check for linked work items" /></a><p> Check for linked work items</p></div><p>Reviewers provide their feedback with comments, therefore, I require all comments to be resolved before a pull request can be completed. In my projects, always the creator of the comment resolves the comment and not the creator of the PR.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Configure-comment-resolution.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Configure-comment-resolution.jpg" alt="Configure comment resolution" /></a><p> Configure comment resolution</p></div><p>Companies have different merge strategies. Some use squash merges, some do rebase and some do just basic merges. It is good to have a merge strategy and limit the pull request to your strategy. In my projects, I do squash merges because I don’t care about all the commits during the development. I only care about the finished feature commit, therefore, I only allow squash merges.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Limit-the-merge-types.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Limit-the-merge-types.jpg" alt="Limit the merge types" /></a><p> Limit the merge types</p></div><h3 id="configure-automatic-builds">Configure automatic Builds</h3><p>Now we come to the most interesting part of the policy. I add a build policy and select the previously created CustomerApi CI pipeline.  You can find the post <a href="/build-net-core-in-ci-pipeline-in-azure-devops" target="_blank" rel="noopener noreferrer">here</a>. I set /CustomerApi/* as path filter. The automatic trigger starts the build every time changes are committed inside the CustomerApi folder and the build expires after 12 hours. This means if the pull request is not completed within 12 hours, the build has to be triggered again.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Add-a-build-policy-for-the-CustomerApi-to-the-Pull-Request.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Add-a-build-policy-for-the-CustomerApi-to-the-Pull-Request.jpg" alt="Add a build policy for the CustomerApi to the Pull Request" /></a><p> Add a build policy for the CustomerApi to the Pull Request</p></div><p>Add another build policy for the OrderApi and enter /OrderApi/* as path filter. Click on Save and the policy is configured and created.</p><h2 id="make-changes-to-the-code">Make changes to the Code</h2><p>I added a new unit test, commit the changes to the master branch, and push the changes. Due to the policy on the master branch, I am not allowed to push changes directly to the master branch, as seen on the following screenshot.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Pushing-directly-to-master-is-not-allowed.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Pushing-directly-to-master-is-not-allowed.jpg" alt="Pushing directly to master is not allowed" /></a><p> Pushing directly to master is not allowed</p></div><p>Since the master branch is protected, I have to create a feature branch. I name this branch addunittest and push the changes to Azure DevOps.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Pushing-a-new-branch.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Pushing-a-new-branch.jpg" alt="Pushing a new branch" /></a><p> Pushing a new branch</p></div><p>In Azure DevOps under Repos –&gt; Files, you can see that Azure DevOps registered the changes and already suggest to create a new PR. Click on Create a pull request and you will get into a new window.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Create-a-new-Pull-Request.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Create-a-new-Pull-Request.jpg" alt="Create a new Pull Request" /></a><p> Create a new Pull Request</p></div><h2 id="create-a-new-pull-request">Create a new Pull Request</h2><p>Add a title, and optionally a description, reviewers, and work items. I like to have 1-3 sentences in the description to explain what you did. As the title, I usually use the PBI number and the PBI title (not in this example though).</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/New-Pull-Request.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/New-Pull-Request.jpg" alt="New Pull Request" /></a><p> New Pull Request</p></div><p>After the pull request is created, the build will kick off immediately, and also all other required policies will be checked. As you can see on the following screenshot, the build failed due to a failing test, no work item is linked and not all comments are resolved. Therefore, I can’t complete the PR.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Required-checks-failed.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Required-checks-failed.jpg" alt="Required checks failed" /></a><p> Required checks failed</p></div><p>I fixed my unit test, added a link to the PB,I and fixed the suggested changes from the comment. The comment creator resolved the comment and this enabled me to complete the pull request. On the following screenshot, you can see that I also changed the title of the PR to have to PBI number and title in it.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/All-checks-passed.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/All-checks-passed.jpg" alt="All checks passed" /></a><p> All checks passed</p></div><h3 id="complete-the-pull-request">Complete the Pull Request</h3><p>When you click on Complete, you can select a merge type. Since I restricted the merge strategy to squash commit only, I can’t select any other strategy.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Only-Squash-commit-is-allowed-by-the-Pull-Request-policy.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Only-Squash-commit-is-allowed-by-the-Pull-Request-policy.jpg" alt="Only Squash commit is allowed by the Pull Request policy" /></a><p> Only Squash commit is allowed by the Pull Request policy</p></div><p>The definition of done in my projects is that the PBI is set to done when the pull request is finished (because we deploy the feature automatically to prod when thePR is completed). Additionally, I select to delete my branch after merging.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/Complete-the-Pull-Request.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/Complete-the-Pull-Request.jpg" alt="Complete the Pull Request" /></a><p> Complete the Pull Request</p></div><p>The PR creator can also select auto-complete to complete the pull request automatically when all required checks are OK. After the merge to master is completed, the CI pipeline automatically kicks off a build of the master branch.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/08/The-master-branch-trigger-a-CI-build.jpg"><img loading="lazy" src="/assets/img/posts/2020/08/The-master-branch-trigger-a-CI-build.jpg" alt="The master branch trigger a CI build" /></a><p> The master branch trigger a CI build</p></div><h2 id="conclusion">Conclusion</h2><p>In this post, I explained how to protect the master branch from changes in Azure DevOps. I showed how to add a branch policy to the master branch in Azure DevOps and also how to run a build process to check if the solution compiles and if all tests run successfully.</p><p>You can find the code of this demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration">Azure Devops</a> <a href="/tags/ci/" class="post-tag no-text-decoration">CI</a> <a href="/tags/continuous-integration/" class="post-tag no-text-decoration">continuous integration</a> <a href="/tags/devops-pull-request-policy/" class="post-tag no-text-decoration">DevOps Pull request policy</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Run the CI Pipeline during a Pull Request - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Run the CI Pipeline during a Pull Request - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Run the CI Pipeline during a Pull Request - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/how-i-learned-programming-part-2/">How I learned programming - Part 2</a><li><a href="/document-your-microservice-with-swagger/">Document your Microservice with Swagger</a><li><a href="/how-i-learned-programming-part-3/">How I learned programming - Part 3</a></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/ci/">CI</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/create-net-core-in-ci-pipeline-in-azure-devops/"><div class="card-body"> <span class="timeago small" > Aug 3 <i class="unloaded">2020-08-03T19:24:06+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Create a .NET Core CI Pipeline in Azure DevOps</h3><div class="text-muted small"><p> A crucial feature of DevOps is to give the developer fast feedback if their code changes work. This can be done by automatically building code and running tests every time changes are checked-in. T...</p></div></div></a></div><div class="card"> <a href="/run-tests-inside-docker-during-ci/"><div class="card-body"> <span class="timeago small" > Sep 23 <i class="unloaded">2020-09-23T09:09:22+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Run Tests inside Docker during CI</h3><div class="text-muted small"><p> Running your build inside a Docker container has many advantages like platform independence and better testability for developers. These containers also bring more complexity though. In my last pos...</p></div></div></a></div><div class="card"> <a href="/build-net-core-in-ci-pipeline-in-azure-devops/"><div class="card-body"> <span class="timeago small" > Oct 13 <i class="unloaded">2020-10-13T17:20:53+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build .NET Core in a CI Pipeline in Azure DevOps</h3><div class="text-muted small"><p> A crucial feature of DevOps is to give the developer fast feedback if their code changes work. This can be done by automatically building code and running tests every time changes are checked-in. T...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/build-net-core-in-ci-pipeline-in-azure-devops/" class="btn btn-outline-primary"><p>Build .NET Core in a CI Pipeline in Azure DevOps</p></a> <a href="/we-moved-to-jekyll/" class="btn btn-outline-primary"><p>We moved to Jekyll</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function () { this.page.url = 'https://www.programmingwithwolfgang.com/run-the-ci-pipeline-during-pull-request/'; this.page.identifier = '/run-the-ci-pipeline-during-pull-request/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/ci/">CI</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
