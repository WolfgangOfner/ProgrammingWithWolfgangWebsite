<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Use Azure Container Registry in Kubernetes" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="Azure Container Registry has some advantages over Docker Hub and I will show you how to configure your microservice and Kubernetes cluster to run images from ACR and run them in your cluster." /><meta property="og:description" content="Azure Container Registry has some advantages over Docker Hub and I will show you how to configure your microservice and Kubernetes cluster to run images from ACR and run them in your cluster." /><link rel="canonical" href="/azure-container-registry-kubernetes/" /><meta property="og:url" content="/azure-container-registry-kubernetes/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-05T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Use Azure Container Registry in Kubernetes" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2021-04-05T00:00:00+02:00","datePublished":"2021-04-05T00:00:00+02:00","description":"Azure Container Registry has some advantages over Docker Hub and I will show you how to configure your microservice and Kubernetes cluster to run images from ACR and run them in your cluster.","headline":"Use Azure Container Registry in Kubernetes","mainEntityOfPage":{"@type":"WebPage","@id":"/azure-container-registry-kubernetes/"},"url":"/azure-container-registry-kubernetes/"}</script><title>Use Azure Container Registry in Kubernetes | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "hc0wl2v6mn"); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/youtube/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>YOUTUBE</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Use Azure Container Registry in Kubernetes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Use Azure Container Registry in Kubernetes</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1617573600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 5, 2021 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1398 words"> <em>16 min</em></span> read</div></div><div class="post-content"><p><a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> is like GitHub for Docker containers. You can sign up for free and get unlimited public repos and one private repo. This is great for developers like me who want to make their containers easily accessible for everyone. Enterprises probably don’t want to have their containers on a public share. They can either buy an enterprise plan or they can use a private registry like Azure Container Registry (ACR).</p><p>In this post, I will talk about the advantages of Azure Container Registry and show you how to configure your microservice and Kubernetes cluster to run images from ACR and run them in your cluster.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="what-is-azure-container-registry-acr"><span class="mr-2">What is Azure Container Registry (ACR)</span><a href="#what-is-azure-container-registry-acr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Azure Container Registry is a private container registry that allows you to build and store your images, replicate them around the globe and also scan for vulnerabilities. ACR comes in three pricing tiers: Basic, Standard, and Premium. The main difference between them is the amount of included storage and the number of webhooks you can use. Additionally, the premium tier supports geo-replication. This means that your images are still available when a data center goes down. Furthermore, it allows for faster startup times because the needed image is closer to the destination. This is only the case if you operate globally.</p><p>Microsoft recommends using the premium tier. At first glance, you might think that the price difference is massive (0.141€ for Basic, 0.563€ for Standard, 1.406€ for Premium per day) but in the end, you pay 4.37€ for the Basic tier compared to 43.59€ for the Premium tier.</p><h2 id="create-an-azure-container-registry-in-the-azure-portal"><span class="mr-2">Create an Azure Container Registry in the Azure Portal</span><a href="#create-an-azure-container-registry-in-the-azure-portal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the Azure Portal, search for Container registries and then click on Create container registry.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Create-a-new-Azure-Container-Registry.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Create-a-new-Azure-Container-Registry.jpg" alt="Create a new Azure Container Registry" data-proofer-ignore></a><p> Create a new Azure Container Registry</p></div><p>Select a subscription, resource group, location, and SKU. For the demo, I am using Basic. Provide a unique name for your ACR and then click on Create.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Configure-the-new-ACR.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Configure-the-new-ACR.jpg" alt="Configure the new ACR" data-proofer-ignore></a><p> Configure the new ACR</p></div><h2 id="upload-an-image-to-the-azure-container-registry"><span class="mr-2">Upload an Image to the Azure Container Registry</span><a href="#upload-an-image-to-the-azure-container-registry" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To upload an image to the new ACR, you have two options: importing the image from Docker Hub or uploading it from a CI/CD pipeline (or manually).</p><h3 id="import-an-image-from-docker-hub-into-acr"><span class="mr-2">Import an Image from Docker Hub into ACR</span><a href="#import-an-image-from-docker-hub-into-acr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Importing an image is a good way to get started fast but I would recommend using the CI/CD pipeline approach in the next section. To import the image, use the following Azure CLI command:</p><script src="https://gist.github.com/WolfgangOfner/9f78fbe4917a26a0761d8b9395833cf3.js"></script><p>The first line logs you into your Azure subscription and the second one takes the name of your ACR, the source image from Docker Hub, and the image name which will be created in ACR.</p><h3 id="upload-a-docker-image-using-azure-devops-pipelines"><span class="mr-2">Upload a Docker Image using Azure DevOps Pipelines</span><a href="#upload-a-docker-image-using-azure-devops-pipelines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>The better approach to uploading is an automated Azure DevOps pipeline. In my previous demos, I already created tasks to build and publish the image to Docker Hub. I will update these tasks to a new version (v2 instead of v1) and add more parameters, so you can easily switch between ACR and Docker Hub.</p><h3 id="create-a-service-connection-to-your-acr"><span class="mr-2">Create a Service Connection to your ACR</span><a href="#create-a-service-connection-to-your-acr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before you can upload images to ACR, you have to create a Service Connection. In your Azure DevOps project, click on Project settings and then on Service connections.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Create-a-new-Service-Connection.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Create-a-new-Service-Connection.jpg" alt="Create a new Service Connection" data-proofer-ignore></a><p> Create a new Service Connection</p></div><p>On the Service connections tab, click on New service connection and search for docker registry.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Add-a-Docker-registry-connection.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Add-a-Docker-registry-connection.jpg" alt="Add a Docker registry connection" data-proofer-ignore></a><p> Add a Docker registry connection</p></div><p>On the next tab, select Azure Container Registry, your subscription, and your ACR. Provide a name and remember it because you will need it later in your pipeline.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Configure-the-ACR-Service-Connection.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Configure-the-ACR-Service-Connection.jpg" alt="Configure the ACR Service Connection" data-proofer-ignore></a><p> Configure the ACR Service Connection</p></div><h4 id="update-the-cicd-pipeline-to-use-the-new-service-connection"><span class="mr-2">Update the CI/CD Pipeline to use the new Service Connection</span><a href="#update-the-cicd-pipeline-to-use-the-new-service-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You can find the Docker tasks in the <a href="https://github.com/WolfgangOfner/MicroserviceDemo/blob/master/CustomerApi/pipelines/templates/DockerBuildAndPush.yml" target="_blank" rel="noopener noreferrer">DockerBuildAndPush.yml template</a>. The original Docker build task looks as follow:</p><script src="https://gist.github.com/WolfgangOfner/73a2360e4f33241570abf26ad490ab2a.js"></script><p>I replaced the parameters and the Docker v1 task with the following code:</p><script src="https://gist.github.com/WolfgangOfner/906dea3e64581e886e90d61eb6fe0ad2.js"></script><p>As you can see, I added a couple of new parameters and updated the Docker task to v2. The v2 task takes a containerRegistry instead of dockerRegistryEndpoint and also a repository. Additionally, it supports multiple tags so you can build the same image as before and additionally always update the latest tag.</p><p>The Docker publish looked originally as follows:</p><script src="https://gist.github.com/WolfgangOfner/1f07051e63ef39fa574a9db82014c73c.js"></script><p>I updated this task also to version 2 and added the new parameters.</p><script src="https://gist.github.com/WolfgangOfner/a4a4f1740df64f40b518a87136a5ee18.js"></script><p>Lastly, I have to update my pipeline to pass values for the new parameters:</p><script src="https://gist.github.com/WolfgangOfner/fb513f4c0839006a3b14676f9b958874.js"></script><p>Additionally, I renamed the ImageName variable to Repository. If you want to deploy to Docker Hub instead, use ‘Docker Hub’ for the containerRegistry and wolfgangofner/customerapi for the repository (you have to replace wolfgangofner with your Docker Hub repository name). For more information about pushing images to Docker Hub, see my post <a href="/build-docker-azure-devops-ci-pipeline">Build Docker in an Azure DevOps CI Pipeline</a>.</p><h4 id="update-the-image-source-in-the-helm-package"><span class="mr-2">Update the Image Source in the Helm package</span><a href="#update-the-image-source-in-the-helm-package" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The microservice uses Helm for the configuration. For more information about Helm, see my post <a href="/helm-getting-started">Helm - Getting Started</a>.</p><p>The values.yaml file contains the configuration for the image and tag Kubernetes should use. Currently, this is:</p><script src="https://gist.github.com/WolfgangOfner/11e48d64374ccc942ef64780caf19621.js"></script><p>Since I renamed ImageName to Repository, you also have to rename it here:</p><script src="https://gist.github.com/WolfgangOfner/69adcc3369d649cc5a8310e5ccbb0408.js"></script><p>That’s it. The pipeline is configured to push the image to your new ACR and Kubernetes should then pull the new image from ACR and run. Let’s see if everything works.</p><h2 id="test-the-switch-to-acr"><span class="mr-2">Test the Switch to ACR</span><a href="#test-the-switch-to-acr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Run the pipeline and you should see that the build and push of the Docker image works. Go to your ACR and under Repositories, you will see the customerapi repository. But the pipeline will fail due to a timeout in the Helm upgrade release task.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Helm-upgrade-timed-out.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Helm-upgrade-timed-out.jpg" alt="Helm upgrade timed out" data-proofer-ignore></a><p> Helm upgrade timed out</p></div><p>Connect to the K8s dashboard and check the pod to see the error message. For more information about accessing the dashboard, see my previous post <a href="/azure-kubernetes-service-getting-started/#access-aks-cluster">Azure Kubernetes Service - Getting Started</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/ACR-authentication-required.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/ACR-authentication-required.jpg" alt="ACR authentication required" data-proofer-ignore></a><p> ACR authentication required</p></div><p>As you can see on the screenshot above, the pull failed because Kubernetes is not authorized to pull the image. This is because ACR is a private container registry and you have to give Kubernetes permission to pull images.</p><h2 id="allow-kubernetes-to-pull-acr-images"><span class="mr-2">Allow Kubernetes to pull ACR Images</span><a href="#allow-kubernetes-to-pull-acr-images" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To allow Kubernetes to pull images from ACR, you first have to create a service principal and give it the acrpull role. Use the following bash script to create the service principal and assign it the acrpull role.</p><script src="https://gist.github.com/WolfgangOfner/085612d16ac9ed9c47dd5b6e9d091f80.js"></script><p>Don’t worry if the creation of the role assignment needs a couple of retries.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/Create-a-new-service-principal-with-the-acrpull-role.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/Create-a-new-service-principal-with-the-acrpull-role.jpg" alt="Create a new service principal with the acrpull role" data-proofer-ignore></a><p> Create a new service principal with the acrpull role</p></div><p>Next, create an image pull secret with the following command:</p><script src="https://gist.github.com/WolfgangOfner/7c0b1cc0071aa050dfdfe7a79b4fc543.js"></script><p>Note that you have to use the username and password from the previously created service principal. The namespace is the Kubernetes namespace in which your microservice is running. If you also want to deploy the OrderApi microservice from the demo repository, you have to repeat the command for the orderapi-test namespace.</p><h3 id="use-the-image-pull-secret-in-your-microservice"><span class="mr-2">Use the Image Pull Secret in your Microservice</span><a href="#use-the-image-pull-secret-in-your-microservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After the image pull secret was created, you have to tell your microservice to use it. The image pull secret is part of the deployment but it is empty. In my last posts, I used the values.yaml file for values that I want to set during the deployment. Therefore, I add the name of the secret there:</p><script src="https://gist.github.com/WolfgangOfner/25026b07f81d371a74abf64efb11db8b.js"></script><p>If you used a different name for your secret in the kubectl create secret docker-registry, then you have to use your name instead of acr-secret.</p><h3 id="deploy-the-image-from-acr-to-kubernetes"><span class="mr-2">Deploy the Image from ACR to Kubernetes</span><a href="#deploy-the-image-from-acr-to-kubernetes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Run the pipeline again and this time it will succeed.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/The-deployment-using-ACR-succeeded.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/The-deployment-using-ACR-succeeded.jpg" alt="The deployment using ACR succeeded" data-proofer-ignore></a><p> The deployment using ACR succeeded</p></div><p>Connect to the dashboard and check the events to make sure that the image was pulled from your ACR.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/04/The-image-was-successfully-pulled-from-ACR.jpg"><img loading="lazy" data-src="/assets/img/posts/2021/04/The-image-was-successfully-pulled-from-ACR.jpg" alt="The image was successfully pulled from ACR" data-proofer-ignore></a><p> The image was successfully pulled from ACR</p></div><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Azure Container Registry (ACR) is a private container registry and a great alternative to Docker Hub, especially for companies. ACR allows you to build your images but also to distribute them globally. Due to the private nature of ACR, Kubernetes needs an image pull secret to allow deployments to access ACR and pull images from there.</p><p>Note: By default, my demo code is using Docker Hub because it is more accessible and I want to make it easier for people who want to try the demo. I left the code for ACR as comments in the pipeline.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/devops/'>DevOps</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/ci-cd/" class="post-tag no-text-decoration" >CI-CD</a> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/aks/" class="post-tag no-text-decoration" >AKS</a> <a href="/tags/helm/" class="post-tag no-text-decoration" >Helm</a> <a href="/tags/acr/" class="post-tag no-text-decoration" >ACR</a> <a href="/tags/azure-container-registry/" class="post-tag no-text-decoration" >Azure Container Registry</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Use+Azure+Container+Registry+in+Kubernetes+-+Programming+With+Wolfgang&url=%2Fazure-container-registry-kubernetes%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Use+Azure+Container+Registry+in+Kubernetes+-+Programming+With+Wolfgang&u=%2Fazure-container-registry-kubernetes%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Use+Azure+Container+Registry+in+Kubernetes+-+Programming+With+Wolfgang&url=%2Fazure-container-registry-kubernetes%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fazure-container-registry-kubernetes%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/video/">Video</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/readiness-health-probes-kubernetes/"><div class="card-body"> <em class="small" data-ts="1616968800" data-df="ll" > Mar 29, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Readiness and Liveness Probes in Kubernetes</h3><div class="text-muted small"><p> Kubernetes automatically checks if a pod is healthy and also when it is ready to accept traffic. These checks are done using a readiness probe and liveness probe respectively. This post shows how t...</p></div></div></a></div><div class="card"> <a href="/replace-rabbitmq-azure-service-bus-queue/"><div class="card-body"> <em class="small" data-ts="1618178400" data-df="ll" > Apr 12, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Replace RabbitMQ with Azure Service Bus Queues</h3><div class="text-muted small"><p> RabbitMQ is a great tool to connect microservices asynchronously but it also comes with a couple of downsides. The biggest downside is that you have to take care of running, monitoring, and updatin...</p></div></div></a></div><div class="card"> <a href="/configure-custom-urls-to-access-microservices-running-in-kubernetes/"><div class="card-body"> <em class="small" data-ts="1621202400" data-df="ll" > May 17, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configure custom URLs to access Microservices running in Kubernetes</h3><div class="text-muted small"><p> In my last post, I created an Nginx Ingress controller and added rules to route to my two microservices. This solution worked but it was far from optimal. First, I had to add routing rules for my m...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/readiness-health-probes-kubernetes/" class="btn btn-outline-primary" prompt="Older"><p>Readiness and Liveness Probes in Kubernetes</p></a> <a href="/replace-rabbitmq-azure-service-bus-queue/" class="btn btn-outline-primary" prompt="Newer"><p>Replace RabbitMQ with Azure Service Bus Queues</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/azure-container-registry-kubernetes/'; this.page.identifier = '/azure-container-registry-kubernetes/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/azure-arc/">Azure Arc</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/video/">Video</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
