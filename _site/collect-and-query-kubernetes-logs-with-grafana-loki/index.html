<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Collect and Query your Kubernetes Cluster Logs with Grafana Loki" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="Collecting and querying logs in Kubernetes is crucial for important applications. Grafana Loki offers a great toolset to help you out." /><meta property="og:description" content="Collecting and querying logs in Kubernetes is crucial for important applications. Grafana Loki offers a great toolset to help you out." /><link rel="canonical" href="https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" /><meta property="og:url" content="https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-19T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Collect and Query your Kubernetes Cluster Logs with Grafana Loki" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"datePublished":"2021-07-19T00:00:00+02:00","dateModified":"2021-07-26T09:16:55+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/"},"@type":"BlogPosting","description":"Collecting and querying logs in Kubernetes is crucial for important applications. Grafana Loki offers a great toolset to help you out.","author":{"@type":"Person","name":"Wolfgang Ofner"},"url":"https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/","headline":"Collect and Query your Kubernetes Cluster Logs with Grafana Loki","@context":"https://schema.org"}</script><title>Collect and Query your Kubernetes Cluster Logs with Grafana Loki | Programming With Wolfgang</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="author wolfgang ofner" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/wolfgangofner" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Collect and Query your Kubernetes Cluster Logs with Grafana Loki</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Collect and Query your Kubernetes Cluster Logs with Grafana Loki</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Collect and Query your Kubernetes Cluster Logs with Grafana Loki</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jul 19, 2021, 12:00 AM +0200" > Jul 19 <i class="unloaded">2021-07-19T00:00:00+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jul 26, 2021, 9:16 AM +0200" > Jul 26 <i class="unloaded">2021-07-26T09:16:55+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1195 words">14 min</span></div></div><div class="post-content"><p>So far I have talked about the development, deployment, and configuration of microservices and Kubernetes in this series. Over the next couple of posts, I want to talk about an essential topic when it comes to running your services in production: logging and monitoring.</p><p>In this post, I will show you how to install the Grafana Loki stack and how you can query the logs of everything inside a Kubernetes cluster.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p><h2 id="the-components-of-grafana-loki">The Components of Grafana Loki</h2><p>Grafana Loki installs various components which are used for different tasks. Let’s have a look at them:</p><h3 id="grafana">Grafana</h3><p>Grafana is a tool to query, visualize and alert metrics. These metrics can be stored in a wide variety of data sources and can be brought into Grafana via plugins. Grafana is mostly known for its beautiful graphs to display everything you want to know about your infrastructure and applications.</p><p>You can find more details on the <a href="https://grafana.com" target="_blank" rel="noopener noreferrer">Grafana website</a>. In a future post, I will show you how to create your own dashboards.</p><h3 id="prometheus">Prometheus</h3><p>Prometheus is an open-source project for monitoring and alerting and is also one of the oldest projects of the Cloud Native Computing Foundation (CNCF). Some of the main features of Prometheus are:</p><ul><li>PromQL, its own flexible query language<li>a multi-dimensional data model for time series data<li>collecting logs via a pull model</ul><p>You can find more details on the <a href="https://prometheus.io" target="_blank" rel="noopener noreferrer">Prometheus website</a>. In a future post, I will show you how to use Prometheus to collect and display metrics from your microservices and Kubernetes cluster.</p><h3 id="promtail">Promtail</h3><p>Promtail is an agent for Loki. It discovers services, for example, applications inside a Kubernetes cluster or nodes of the cluster, and sends the logs to Loki. You can find more details in the <a href="https://grafana.com/docs/loki/latest/clients/promtail" target="_blank" rel="noopener noreferrer">Promtail documentation</a>.</p><h3 id="loki">Loki</h3><p>Loki is a highly available logging solution. It gets described by its developers as “Like Prometheus but for Logs”. It indexes the labels of the logs and allows querying of these logs using LogQL. You can find more details in the <a href="https://grafana.com/docs/loki/latest" target="_blank" rel="noopener noreferrer">Promtail documentation</a>.</p><h2 id="installing-grafana-loki-using-helm">Installing Grafana Loki using Helm</h2><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>The Grafana Loki stack can be easily installed with Helm charts. If you are new to Helm, check out my previous posts <a href="/helm-getting-started">Helm - Getting Started</a> and <a href="/deploy-kubernetes-using-helm">Deploy to Kubernetes using Helm Charts</a> for more details.</p><p>Use the following code to add the Grafana Helm charts, update it and then install Loki:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm upgrade <span class="nt">--install</span> loki <span class="nt">--namespace</span><span class="o">=</span>grafana-loki grafana/loki-stack <span class="nt">--set</span> grafana.enabled<span class="o">=</span><span class="nb">true</span>,prometheus.enabled<span class="o">=</span><span class="nb">true</span>,prometheus.alertmanager.persistentVolume.enabled<span class="o">=</span><span class="nb">true</span>,prometheus.server.persistentVolume.enabled<span class="o">=</span><span class="nb">true</span>
</pre></table></code></div></div><h3 id="installing-grafana-loki-using-an-infrastructure-as-code-pipeline">Installing Grafana Loki using an Infrastructure as Code Pipeline</h3><p>In one of my past posts, I have created an Infrastructure as Code (IaC) Pipeline using Azure CLI. If you want to automatically deploy Loki, add the following code after the Kubernetes deployment in your pipeline:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="na">variables</span><span class="pi">:</span>  
  <span class="na">LokiVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0.3'</span>
  <span class="na">LokiNamespace</span><span class="pi">:</span> <span class="s">loki-grafana</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">HelmDeploy@0</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Install</span><span class="nv"> </span><span class="s">Loki</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">(Helm</span><span class="nv"> </span><span class="s">repo</span><span class="nv"> </span><span class="s">add)"</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">connectionType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureConnectionType)'</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureSubscription)'</span>
    <span class="na">azureResourceGroup</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ResourceGroupName)'</span>
    <span class="na">kubernetesCluster</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AksClusterName)'</span>
    <span class="na">useClusterAdmin</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">repo'</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">add</span><span class="nv"> </span><span class="s">loki</span><span class="nv"> </span><span class="s">https://grafana.github.io/loki/charts'</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">HelmDeploy@0</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Install</span><span class="nv"> </span><span class="s">Loki</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">(Helm</span><span class="nv"> </span><span class="s">repo</span><span class="nv"> </span><span class="s">update)"</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">connectionType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureConnectionType)'</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureSubscription)'</span>
    <span class="na">azureResourceGroup</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ResourceGroupName)'</span>
    <span class="na">kubernetesCluster</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AksClusterName)'</span>
    <span class="na">useClusterAdmin</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">repo'</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">update'</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">HelmDeploy@0</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Install</span><span class="nv"> </span><span class="s">Loki</span><span class="nv"> </span><span class="s">Grafana"</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">connectionType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureConnectionType)'</span>
    <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AzureSubscription)'</span>
    <span class="na">azureResourceGroup</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ResourceGroupName)'</span>
    <span class="na">kubernetesCluster</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(AksClusterName)'</span>
    <span class="na">useClusterAdmin</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(LokiNamespace)'</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">upgrade'</span>
    <span class="na">chartType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Name'</span>
    <span class="na">chartName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">loki/loki-stack'</span>
    <span class="na">chartVersion</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(LokiVersion)'</span>
    <span class="na">releaseName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">loki'</span>
    <span class="na">overrideValues</span><span class="pi">:</span> <span class="s1">'</span><span class="s">grafana.enabled=true,prometheus.enabled=true,prometheus.alertmanager.persistentVolume.enabled=true,prometheus.server.persistentVolume.enabled=true,loki.persistence.enabled=true,loki.persistence.size=10Gi'</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="s1">'</span><span class="s">--create-namespace'</span>
</pre></table></code></div></div><p>The above code adds two variables, for the version of Loki and the namespace where it gets deployed and the does basically the same as the Helm deployment in the section above.</p><h2 id="get-the-credentials-for-grafana">Get the Credentials for Grafana</h2><p>After installing Grafana Loki, you have to read the admin password from the secrets. You can do this in PowerShell with the following code:</p><pre><code class="language-PowerShell">$encodedPassword = kubectl get secret -n loki-grafana loki-grafana -o jsonpath="{.data.admin-password}"
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($encodedPassword))
</code></pre><p>Use the following code when you are on Linux:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl get secret <span class="nt">-n</span> loki-grafana loki-grafana <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.admin-password}"</span> | <span class="nb">base64</span> <span class="nt">--decode</span> <span class="p">;</span> <span class="nb">echo</span>
</pre></table></code></div></div><p>These commands get the secret for the admin password, decode it from base 64, and then print it to the console.</p><h2 id="access-grafana">Access Grafana</h2><p>Before you can access Grafana, you have to create a port forwarding to access the Grafana service. You can do this with the following code:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl get pod <span class="nt">-n</span> loki-grafana

kubectl port-forward <span class="nt">-n</span> loki-grafana &lt;loki-grafana pod name&gt; 3000
</pre></table></code></div></div><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/Configure-the-port-forwarding-to-access-Grafana.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/Configure-the-port-forwarding-to-access-Grafana.jpg" alt="Configure the port forwarding to access Grafana" /></a><p> Configure the port forwarding to access Grafana</p></div><p>This configuration enables you to access the Grafana dashboard using http://localhost:3000. Enter the URL into your browser and you will see the Grafana login screen.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/The-Grafana-login-screen.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/The-Grafana-login-screen.jpg" alt="The Grafana login screen" /></a><p> The Grafana login screen</p></div><p>The user name is admin and the password is what you decoded in the previous step.</p><h2 id="create-your-first-query-in-loki">create your first Query in Loki</h2><p>After the successful login, click on the round icon on the left and select Explore to open the query editor.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/Open-the-Loki-query-editor.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/Open-the-Loki-query-editor.jpg" alt="Open the Loki query editor" /></a><p> Open the Loki query editor</p></div><p>On the top of the page, select Loki as your data source and then you can create a simple query by clicking on Log labels. For example, select pod and then select the loki-grafana pod to query all logs from this specific pod. The query looks as follows:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span><span class="nv">pod</span><span class="o">=</span><span class="s2">"loki-grafana-7d4d587544-npc6n"</span><span class="o">}</span> 
</pre></table></code></div></div><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/Create-your-first-Loki-query.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/Create-your-first-Loki-query.jpg" alt="Create your first Loki query" /></a><p> Create your first Loki query</p></div><p>The query will display all logs from the grafana-loki pod. For more details about a log entry, click on it. You can see a successful login on the following screenshot.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/A-successful-login-got-logged.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/A-successful-login-got-logged.jpg" alt="A successful login got logged" /></a><p> A successful login got logged</p></div><h2 id="filter-your-logs">Filter your Logs</h2><p>Displaying all the logs is nice but not really useful. Usually, you want to filter your logs and only display problematic entries like errors. You can use the following query to display only log entries with the error level:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span><span class="nv">pod</span><span class="o">=</span><span class="s2">"loki-grafana-7d4d587544-npc6n"</span><span class="o">}</span> |<span class="o">=</span> <span class="s2">"error"</span>
</pre></table></code></div></div><p>This query is more useful than displaying all logs but often you also want to search for a specific log message. You can do this easily by extending the query:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span><span class="nv">pod</span><span class="o">=</span><span class="s2">"loki-grafana-7d4d587544-npc6n"</span><span class="o">}</span> |<span class="o">=</span> <span class="s2">"error"</span> <span class="o">!=</span> <span class="s2">"Invalid Username or Password"</span>
</pre></table></code></div></div><p>This query displays all error logs with Invalid Username or Password in the log message.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2021/07/Query-only-error-logs.jpg"><img loading="lazy" src="/assets/img/posts/2021/07/Query-only-xcerror-logs.jpg" alt="Query only error logs" /></a><p> Query only error logs</p></div><h2 id="logql-query-language">LogQL Query Language</h2><p>All the queries above use LogQL. The examples above are just scratching the surface of what you can do with LogQL but it should be enough to get you started. For more details about LogQL, check out <a href="https://grafana.com/docs/loki/latest/logql" target="_blank" rel="noopener noreferrer">the documentation</a>.</p><h2 id="conclusion">Conclusion</h2><p>Analyzing logs is essential for every project running in a production environment. Grafana Loki offers a lot of functionality out of the box like automatically collecting logs from each object in Kubernetes and sending it to Loki where you can query and filter these logs. The examples in this post are very simple but should be enough to get you started.</p><p><a href="/monitor-net-microservices-with-prometheus">In my next post</a>, I will show you how to use Prometheus, which was also installed by Loki, to scrap metrics from the microservices.</p><p>You can find the code of the demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post is part of <a href="/microservice-series-from-zero-to-hero">“Microservice Series - From Zero to Hero”</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure DevOps</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/nginx/" class="post-tag no-text-decoration" >Nginx</a> <a href="/tags/yaml/" class="post-tag no-text-decoration" >YAML</a> <a href="/tags/ci-cd/" class="post-tag no-text-decoration" >CI-CD</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/helm/" class="post-tag no-text-decoration" >Helm</a> <a href="/tags/aks/" class="post-tag no-text-decoration" >AKS</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/logging/" class="post-tag no-text-decoration" >Logging</a> <a href="/tags/monitoring/" class="post-tag no-text-decoration" >Monitoring</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Collect and Query your Kubernetes Cluster Logs with Grafana Loki - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Collect and Query your Kubernetes Cluster Logs with Grafana Loki - Programming With Wolfgang&u=https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Collect and Query your Kubernetes Cluster Logs with Grafana Loki - Programming With Wolfgang&url=https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/microservice-series-from-zero-to-hero/">Microservice Series - From Zero to Hero</a><li><a href="/use-istio-to-manage-your-microservices/">Use Istio to manage your Microservices</a><li><a href="/istio-getting-started/">Istio in Kubernetes - Getting Started</a><li><a href="/it-books-you-should-read/">IT Books you should read</a><li><a href="/service-mesh-kubernetes-getting-started/">Service Mesh in Kubernetes - Getting Started</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/certification/">Certification</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/istio-getting-started/"><div class="card-body"> <span class="timeago small" > Aug 16 <i class="unloaded">2021-08-16T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Istio in Kubernetes - Getting Started</h3><div class="text-muted small"><p> My last post introduced the concept of a service mesh and how it can help to manage your Kubernetes cluster, especially with hundreds or thousands of pods running. The post was only theoretical and...</p></div></div></a></div><div class="card"> <a href="/use-istio-to-manage-your-microservices/"><div class="card-body"> <span class="timeago small" > Aug 23 <i class="unloaded">2021-08-23T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use Istio to manage your Microservices</h3><div class="text-muted small"><p> In my last post, I talked about Istio and how it can be installed. I also mentioned some of the features of the service mesh but only in theory. This post will show you some features of Istio, how...</p></div></div></a></div><div class="card"> <a href="/add-Istio-to-existing-microservice-in-kubernetes/"><div class="card-body"> <span class="timeago small" > Aug 30 <i class="unloaded">2021-08-30T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Add Istio to an existing Microservice in Kubernetes</h3><div class="text-muted small"><p> My last post highlighted some of Istio’s features and showed how to apply them to your microservices. In this short post, I will show you how to add Istio to an existing application. This post is...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/debug-microservices-bridge-kubernetes/" class="btn btn-outline-primary"><p>Debug Microservices running inside a Kubernetes Cluster with Bridge to Kubernetes</p></a> <a href="/monitor-net-microservices-with-prometheus/" class="btn btn-outline-primary"><p>Monitor .NET Microservices in Kubernetes with Prometheus</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://www.programmingwithwolfgang.com/collect-and-query-kubernetes-logs-with-grafana-loki/'; this.page.identifier = '/collect-and-query-kubernetes-logs-with-grafana-loki/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/certification/">Certification</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.programmingwithwolfgang.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
