<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Create a VPC Connection between Azure and Timescale" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="Learn how to establish secure and private connectivity between Azure and TimescaleDB with VNet peering." /><meta property="og:description" content="Learn how to establish secure and private connectivity between Azure and TimescaleDB with VNet peering." /><link rel="canonical" href="/create-vpc-connection-between-azure-and-timescale/" /><meta property="og:url" content="/create-vpc-connection-between-azure-and-timescale/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-15T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Create a VPC Connection between Azure and Timescale" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2022-08-15T00:00:00+02:00","datePublished":"2022-08-15T00:00:00+02:00","description":"Learn how to establish secure and private connectivity between Azure and TimescaleDB with VNet peering.","headline":"Create a VPC Connection between Azure and Timescale","mainEntityOfPage":{"@type":"WebPage","@id":"/create-vpc-connection-between-azure-and-timescale/"},"url":"/create-vpc-connection-between-azure-and-timescale/"}</script><title>Create a VPC Connection between Azure and Timescale | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "hc0wl2v6mn"); </script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/videos/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>VIDEOS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Create a VPC Connection between Azure and Timescale</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Create a VPC Connection between Azure and Timescale</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1660514400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 15, 2022 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2333 words"> <em>27 min</em></span> read</div></div><div class="post-content"><p>During the course of this week, I had the opportunity to assist one of my clients in the complex process of migrating their on-premises database to the highly sophisticated cloud-hosted <a href="https://www.timescale.com" target="_blank" rel="noopener noreferrer">TimescaleDB</a>, a cutting-edge solution renowned for its exceptional performance and scalability. Given the client’s preference for the Azure platform, they expressed their desire to deploy the new TimescaleDB on Azure infrastructure.</p><p>One remarkable feature offered by Timescale is the provision to host the database on Azure while also enabling a secure and private connection through Virtual Private Cloud (VPC) peering. This ingenious approach allows customers to establish a direct peering connection between their own Virtual Network (VNet) and the Timescale’s VNet, thus confining inbound traffic exclusively to this designated VNet. Consequently, it effectively restricts any access to the database from the vast expanse of the internet.</p><p>Regrettably, I encountered a few challenges while attempting to establish the VPC peering, necessitating a detailed description of the troubleshooting and eventual success I achieved in this endeavor.</p><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Upon conducting extensive research and reaching out to the responsive Timescale support team, I fortuitously stumbled upon an article, <a href="https://kb-managed.timescale.com/en/articles/5489252-setting-up-a-vpc-on-azure" target="_blank" rel="noopener noreferrer">“Setting up a VPC on Azure”</a>, within the Timescale knowledge base. This article delves into the intricacies of setting up a Virtual Private Cloud (VPC) on Azure, offering invaluable insights for individuals embarking on a similar journey.</p><p>As I diligently followed the guide, I encountered a few stumbling blocks. Firstly, I encountered issues with certain commands in the Azure Command-Line Interface (CLI), where they failed to execute as expected. Secondly, I observed that the guide employed a rather convoluted approach, needlessly complicating the process. Specifically, in instances where a query yielded a value, the guide instructed users to manually extract and assign the value to a variable, rather than automating this assignment process.</p><p>Follow this guide closely, as it will reveal the shortcomings and discrepancies present within the official documentation. By doing so, you will not only identify the specific areas that require attention and revision, but you will also obviate the need for manual variable assignment. The guide ensures that output values are automatically assigned, alleviating the burden of manual intervention.</p><h2 id="lets-get-started"><span class="mr-2">Let’s get started</span><a href="#lets-get-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before we delve into the technical aspects of the VPC peering, it is important to note that this article assumes you have already set up a TimescaleDB with VPC in Azure. If this is not the case, log into your Timescale account and proceed to create a new VPC within your desired Azure region. Please wait until the VPC reaches an active state before proceeding to create a new database, ensuring that the previously created VPC is designated as its location. Note that accessing this database will not be possible until the VPC peering process is completed.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-connection-to-the-TimescaleDb-was-refused.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-connection-to-the-TimescaleDb-was-refused.jpg" alt="The connection to the TimescaleDb was refused" data-proofer-ignore></a><p> The connection to the TimescaleDb was refused</p></div><p>To aid in our exploration, we shall primarily rely on the command line interface, utilizing <a href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-linux?view=powershell-7.2" target="_blank" rel="noopener noreferrer">PowerShell Core</a>, the <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Azure CLI</a> and <a href="https://github.com/aiven/aiven-client" target="_blank" rel="noopener noreferrer">Aiven CLI</a> on an Ubuntu environment. While it is theoretically feasible to create a VPC peering through the Timescale portal, this approach fails to encompass all the essential steps, rendering it ineffective for our purposes.</p><p>Let us now embark on this command line journey, as we unveil the intricate steps required to establish a successful VPC peering for your TimescaleDB.</p><h2 id="create-an-application-in-your-aad"><span class="mr-2">Create an Application in your AAD</span><a href="#create-an-application-in-your-aad" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To proceed with the VPC peering setup, we will first create an application in your Azure Active Directory (AAD). Please follow the steps outlined below:</p><p>First, log into your Azure account using the Azure CLI and ensure that you have set the desired subscription (if applicable). Use the following command:</p><script src="https://gist.github.com/WolfgangOfner/2fa99fa9667cf94db0bf68e56a825820.js"></script><p>Once you are logged in and have set the appropriate subscription, execute the following command to create an application in your AAD. You can choose any display name you prefer:</p><script src="https://gist.github.com/WolfgangOfner/77214098bb4b6776be1ab4468dc91926.js"></script><p>Please note that in the above command, we have included the –sign-in-audience AzureADandPersonalMicrosoftAccount flag, which allows multiple tenants to log into this application. However, it is important to clarify that only your specific tenant possesses the necessary credentials for authentication.</p><p>At this juncture, it is crucial to highlight a notable discrepancy in the official guide. The guide suggests using the –available-to-other-tenants flag, which, to the best of my knowledge, does not exist and consequently will not function as intended. Instead, please ensure that you utilize the –sign-in-audience flag as specified above.</p><h2 id="create-a-service-principal"><span class="mr-2">Create a Service Principal</span><a href="#create-a-service-principal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the next step, we will create a service principal for the AAD application that we previously established. This service principal will play a crucial role in the subsequent process of peering your Virtual Network (VNet) with Timescale’s VNet. Please follow the instructions below:</p><p>Execute the following command to create the service principal:</p><script src="https://gist.github.com/WolfgangOfner/4f5e7da7559fc1edfcefd0766a66da4b.js"></script><p>By creating this service principal, you are effectively generating the necessary credentials that will facilitate the VPC peering between your VNet and Timescale’s VNet. This step is vital to ensure the successful establishment of the desired connection.</p><h2 id="set-a-password-for-the-application"><span class="mr-2">Set a Password for the Application</span><a href="#set-a-password-for-the-application" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To ensure smooth authentication and secure access to Azure using the AAD application we created earlier, we need to set a password for the application. This password will serve as the necessary credential for logging into Azure. Please follow the steps outlined below:</p><p>Execute the following command to reset the password for the AAD application:</p><script src="https://gist.github.com/WolfgangOfner/c0a19601e3e3c46acbe7a4cb806b927c.js"></script><p>Upon executing this command, a warning will appear, cautioning you to exercise care as the output will contain sensitive credentials. However, in this case, we can safely ignore the warning, as obtaining the password for the Azure login is the exact purpose of this action.</p><p>By setting the password for the application, we are ensuring a secure and authenticated access point to Azure. With this vital step complete, we are now prepared to proceed with the subsequent stages of the VPC peering process.</p><h2 id="gather-information-about-your-vnet-resource-group-and-subscription"><span class="mr-2">Gather Information about your VNet, Resource Group, and Subscription</span><a href="#gather-information-about-your-vnet-resource-group-and-subscription" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In order to proceed with the VPC peering configuration, we need to gather some essential information about your Virtual Network (VNet), the associated resource group, your subscription ID, and your tenant ID. Please follow the instructions below and replace the placeholders for “YOUR_VNET_NAME” and “YOUR_PEERING_NAME” with your specific values:</p><script src="https://gist.github.com/WolfgangOfner/306e3aa8b00abce2137c0883222b116c.js"></script><h2 id="assign-the-network-contributor-role-to-the-service-principal"><span class="mr-2">Assign the Network Contributor Role to the Service Principal</span><a href="#assign-the-network-contributor-role-to-the-service-principal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To enable the service principal, which we created earlier, to create the peering from your VNet to the Timescale VNet, we need to assign the Network Contributor role to the service principal. This role will provide the necessary permissions for network-related operations.</p><p>Execute the following commands to query the ID of the Network Contributor role and assign it to the service principal:</p><script src="https://gist.github.com/WolfgangOfner/6a8a8f809f23393956c495fff534daf9.js"></script><p>The –scope flag ensures that the role assignment is limited to the VNet resource, providing the necessary level of access for the service principal to establish the VPC peering connection.</p><h2 id="create-a-service-principal-for-the-timescaledb-application"><span class="mr-2">Create a Service Principal for the TimescaleDB application</span><a href="#create-a-service-principal-for-the-timescaledb-application" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To establish a peering connection between your Timescale VPC project and your VNet, the Timescale Active Directory (AD) application requires a service principal in your Azure subscription. Execute the following code to create the service principal for the TimescaleDB application:</p><script src="https://gist.github.com/WolfgangOfner/a2919558718462ea97f89592e4e7a3db.js"></script><p>Please note that you need to have the “Application Administrator” permission to execute the code provided. If you encounter an error message stating “Insufficient permissions to create the service principal,” it means you do not have the necessary permissions.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Insufficient-permissions-to-create-the-service-principal.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Insufficient-permissions-to-create-the-service-principal.jpg" alt="Insufficient permissions to create the service principal" data-proofer-ignore></a><p> Insufficient permissions to create the service principal</p></div><h2 id="create-a-custom-role-for-the-network-peering"><span class="mr-2">Create a Custom Role for the Network Peering</span><a href="#create-a-custom-role-for-the-network-peering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To provide the Timescale application with the necessary permissions to create the network peering, it is recommended to create a custom role that includes only the “Microsoft.Network/virtualNetworks/peer/action” permission. This ensures that you grant the least amount of permissions required for the task.</p><p>First, save the following code as a JSON file, e.g., customRole.json. Replace &lt;YOUR_SUBSCRIPTION_ID&gt; with your actual subscription ID, and if desired, modify the name of the role:</p><script src="https://gist.github.com/WolfgangOfner/6f70ecdab6f6420b288e1b7d88092fee.js"></script><p>Next, execute the following command to create the custom role using the JSON file:</p><script src="https://gist.github.com/WolfgangOfner/d58c5052916e9ddbeec9a77bd6e19d16.js"></script><p>Lastly, assign the custom role to the previously created Timescale service principal using the following command:</p><script src="https://gist.github.com/WolfgangOfner/6405396499646e9df4a81f6416f590d1.js"></script><h2 id="create-an-access-token-for-the-aiven-cli"><span class="mr-2">Create an Access Token for the Aiven CLI</span><a href="#create-an-access-token-for-the-aiven-cli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To create an access token for the Aiven CLI in the Timescale portal, follow the steps below:</p><ol><li>Log into your account in the Timescale portal.<li>Click on your account icon located on the top right corner of the page.<li>Switch to the “Authentication” tab.<li>Click on the “Generate token” button.</ol><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Generate-a-new-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Generate-a-new-access-token.jpg" alt="Generate a new access token" data-proofer-ignore></a><p> Generate a new access token</p></div><p>This will open a new window where you can enter a name for your access token and configure its expiration time.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Configure-the-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Configure-the-access-token.jpg" alt="Configure the access token" data-proofer-ignore></a><p> Configure the access token</p></div><p>After setting the token name and expiration time, click on the “Generate token” button. The access token will be generated, and you should see it in the generated token list.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Copy-the-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Copy-the-access-token.jpg" alt="Copy the access token" data-proofer-ignore></a><p> Copy the access token</p></div><p>Make sure to copy the access token at this point, as it will not be visible again. Safely store the access token as it will be required for authentication when using the Aiven CLI.</p><p>Additionally, it is highly recommended to enable two-factor authentication (2FA) in your account settings for enhanced security. Enabling 2FA adds an extra layer of protection to your account by requiring an additional verification step during the login process.</p><h3 id="install-the-aiven-cli"><span class="mr-2">Install the Aiven CLI</span><a href="#install-the-aiven-cli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To install the Aiven CLI and log into your Timescale account, follow these steps:</p><p>First, you need to install Python and pip if they are not already installed on your system. Use the following commands to install them:</p><script src="https://gist.github.com/WolfgangOfner/6bb003fa6b638cc7f14bc0faf5746153.js"></script><p>Once Python and pip are installed, you can proceed to install the Aiven CLI. Use the following command to install it:</p><script src="https://gist.github.com/WolfgangOfner/fb0cb0e6b65bbfaba9d11bc7a5f44ced.js"></script><p>After the Aiven CLI is installed, you can log into your Timescale account using the CLI. Replace &lt;YOUR_USER&gt; in the following command with your Timescale username:</p><script src="https://gist.github.com/WolfgangOfner/c39add583c21c4fc9203751ac34a697d.js"></script><p>This command will prompt you to enter your access token. Paste the access token that you previously generated in the Timescale portal and press Enter.</p><p>Once you have successfully logged in, you are ready to use the Aiven CLI for further configuration steps.</p><h3 id="retrieve-the-vpc-project-id"><span class="mr-2">Retrieve the VPC Project ID</span><a href="#retrieve-the-vpc-project-id" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To retrieve the VPC Project ID, you can use the following command:</p><p>The following code works because there is only 1 VPC per region. Replace timescale-azure-switzerland-north with your location if you are not using Switzerland North. The project ID is always 36 characters long, as far as I know.</p><script src="https://gist.github.com/WolfgangOfner/d3efc30bc211516b1786feb2b3a0a43d.js"></script><h3 id="create-peering-connection"><span class="mr-2">Create Peering Connection</span><a href="#create-peering-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The VPC project id and some of the previously created variables are now needed to create a peering connection from the Timescale VNet into your VNet. Use the following code to create the connection:</p><script src="https://gist.github.com/WolfgangOfner/01290722a1d36ab342c56b37a4c0063f.js"></script><p>Note that the input variables starting with user_ must be lowercase since the Aiven API can only handle lower-case inputs.</p><h3 id="check-the-peering-status-and-assign-variables"><span class="mr-2">Check the Peering Status and Assign Variables</span><a href="#check-the-peering-status-and-assign-variables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Creating the peering connection might take some time but usually, it is only a couple of seconds. Before you proceed, make sure with the following command that the state of the connection is ACTIVE.</p><script src="https://gist.github.com/WolfgangOfner/58dbb968bf15286c3d8d6cd8b209e4c8.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Check-the-peering-state.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Check-the-peering-state.jpg" alt="Check the peering state" data-proofer-ignore></a><p> Check the peering state</p></div><p>If the state is not ACTIVE, wait a bit and retry the command from above. If the state is INVALID_SPECIFICATION or REJECTED_BY_PEER, check that VNet you passed as a parameter exists and that the Timescale application was given the proper permissions. After you checked that, repeat the command from above and the peering connection should be created.</p><p>The output of this command is horrendous but you have to copy the value of to-tenant-id and to-network-id to the variables aiven_vnet_id and aiven_tenant_id. Make sure to replace the placeholder with your actual values.</p><script src="https://gist.github.com/WolfgangOfner/142c28ef0b178724c38bc6c8b9dcf2bc.js"></script><p>The tenant Id is a GuId and the VNet id should look something like “/subscriptions/&lt;SUBSCRIPTION_ID}&gt;/resourceGroups/…</p><h3 id="create-the-vnet-peering-from-your-vnet-to-your-vpc"><span class="mr-2">Create the VNet peering from your VNet to your VPC</span><a href="#create-the-vnet-peering-from-your-vnet-to-your-vpc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Log out of the Azure CLI and then log in with your service principal into your tenant and also into the Timescale tenant.</p><script src="https://gist.github.com/WolfgangOfner/93553931e2fc885d48c51db8524701ef.js"></script><p>After you successfully logged into both tenants, create the VNet peering between your VNet and the Timescale VNet</p><script src="https://gist.github.com/WolfgangOfner/c9266da9c0da3cb38e5097866b4a9846.js"></script><p>You can check the state of your peering connection with the following command:</p><script src="https://gist.github.com/WolfgangOfner/6107313f6bf2a9852c2acb58dd7b736c.js"></script><p>After creating the peering connection, the initial state will be APPROVED, and after a few seconds, it should transition to PENDING_PEER.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-peering-was-approved-and-is-pending.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-peering-was-approved-and-is-pending.jpg" alt="The peering was approved and is pending" data-proofer-ignore></a><p> The peering was approved and is pending</p></div><p>Wait for a while, and the peering state should switch to ACTIVE.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-peering-is-active.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-peering-is-active.jpg" alt="The peering is active" data-proofer-ignore></a><p> The peering is active</p></div><p>If you follow the official documentation, note that the command to check the state is cut off and won’t work.</p><h2 id="test-the-connection"><span class="mr-2">Test the Connection</span><a href="#test-the-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the peering connection in place, test if you can log into your Timescale database. Make sure that you are connecting from within your peered VNet, otherwise, the connection won’t work.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-TimescaleDb-login-worked.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-TimescaleDb-login-worked.jpg" alt="The TimescaleDb login worked" data-proofer-ignore></a><p> The TimescaleDb login worked</p></div><p>Note that I used pgAdmin to test the connection despite using Azure Data Studio at the beginning of this tutorial. The PostgreSQL extension of Azure Data Studio was constantly crashing and I could not get it working again.</p><h2 id="clean-up-your-resources"><span class="mr-2">Clean up your Resources</span><a href="#clean-up-your-resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you do not need your resources anymore, make sure to clean up everything you have created.</p><h3 id="delete-the-vnet-peering"><span class="mr-2">Delete the VNet Peering</span><a href="#delete-the-vnet-peering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, delete the VNet peering with the following command.</p><script src="https://gist.github.com/WolfgangOfner/983b1726eb27042a59ad768c2361d608.js"></script><h3 id="delete-both-role-bindings"><span class="mr-2">Delete both Role Bindings</span><a href="#delete-both-role-bindings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, retrieve the Ids of the role bindings and then delete both.</p><script src="https://gist.github.com/WolfgangOfner/e70699383e11e7a65f7a1ed229b4f283.js"></script><h3 id="delete-the-custom-role"><span class="mr-2">Delete the Custom Role</span><a href="#delete-the-custom-role" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After you deleted the role binding, delete the previously created custom role.</p><script src="https://gist.github.com/WolfgangOfner/d952ecd581fe79affb4878336a6183f9.js"></script><p>If you used a different name for the custom role, make sure to replace “VnetPeerCreator” with your name.</p><h3 id="delete-the-applications-from-your-aad"><span class="mr-2">Delete the Applications from your AAD</span><a href="#delete-the-applications-from-your-aad" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Lastly, delete both applications from your AAD.</p><script src="https://gist.github.com/WolfgangOfner/2fc3cb09031a926805f932fa342aaa6f.js"></script><p>Note that deleting an application from AAD is an irreversible action, and it permanently removes the application and its associated resources. Make sure to double-check the application IDs before executing the delete commands to avoid deleting the wrong applications. Also, ensure that you have the necessary permissions (“Application Administrator”) to delete the applications.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In conclusion, this guide demonstrated how to create a private peering connection between your Azure subscription and a Timescale database. By establishing a direct and secure network connection, you can access your database from within your Azure resources while avoiding exposure to the public internet.</p><p>This approach enhances security, reduces latency, and simplifies network architecture. By following the provided steps, you successfully set up the peering connection and tested its functionality.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/postgresql/" class="post-tag no-text-decoration" >PostgreSQL</a> <a href="/tags/timescale/" class="post-tag no-text-decoration" >Timescale</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/vnet-peering/" class="post-tag no-text-decoration" >VNet peering</a> <a href="/tags/vnet/" class="post-tag no-text-decoration" >VNet</a> <a href="/tags/azure-cli/" class="post-tag no-text-decoration" >Azure CLI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&u=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <em class="small" data-ts="1610838000" data-df="ll" > Jan 17, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software architect on different projects that focus on microservices, DevOps, and Kubernetes. Many of my consulting jobs consist of explaining microservices, why th...</p></div></div></a></div><div class="card"> <a href="/how-to-pass-az-303-and-az-304-certification-exams/"><div class="card-body"> <em class="small" data-ts="1621807200" data-df="ll" > May 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to pass the AZ-303 and AZ-304 Certification Exams</h3><div class="text-muted small"><p> Two weeks ago, I passed the AZ-304 exam and today I passed the AZ-303 exam giving me the Azure Solutions Architect Expert certification. This post will give you an overview of the exams what metho...</p></div></div></a></div><div class="card"> <a href="/implement-aad-authentication-to-access-azure-sql-databases/"><div class="card-body"> <em class="small" data-ts="1635721200" data-df="ll" > Nov 1, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Implement AAD Authentication to access Azure SQL Databases</h3><div class="text-muted small"><p> Microsoft promotes going passwordless for a while now. Azure offers authentication against the Azure Active Directory where applications can acquire access tokens using their identity. Another use ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/introducing-gitops/" class="btn btn-outline-primary" prompt="Older"><p>Introducing GitOps</p></a> <a href="/manage-kubernetes-resources-with-kustomize/" class="btn btn-outline-primary" prompt="Newer"><p>Manage your Kubernetes Resources with Kustomize</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/create-vpc-connection-between-azure-and-timescale/'; this.page.identifier = '/create-vpc-connection-between-azure-and-timescale/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
