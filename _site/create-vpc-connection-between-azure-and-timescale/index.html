<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Create a VPC Connection between Azure and Timescale" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en" /><meta name="description" content="This tutorial explains how to create a VNet peering connection between your Azure tenant and Timescale." /><meta property="og:description" content="This tutorial explains how to create a VNet peering connection between your Azure tenant and Timescale." /><link rel="canonical" href="/create-vpc-connection-between-azure-and-timescale/" /><meta property="og:url" content="/create-vpc-connection-between-azure-and-timescale/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-15T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Create a VPC Connection between Azure and Timescale" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wolfgang Ofner"},"dateModified":"2022-08-15T00:00:00+02:00","datePublished":"2022-08-15T00:00:00+02:00","description":"This tutorial explains how to create a VNet peering connection between your Azure tenant and Timescale.","headline":"Create a VPC Connection between Azure and Timescale","mainEntityOfPage":{"@type":"WebPage","@id":"/create-vpc-connection-between-azure-and-timescale/"},"url":"/create-vpc-connection-between-azure-and-timescale/"}</script><title>Create a VPC Connection between Azure and Timescale | Programming With Wolfgang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Programming With Wolfgang"><meta name="application-name" content="Programming With Wolfgang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/author/author-wolfgang-ofner.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div><div class="w-100 d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="w-100" style="margin-top: 1em;"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/videos/" class="nav-link"> <i class="fa-fw fas fa-video ml-xl-3 mr-xl-3 unloaded"></i> <span>VIDEOS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="w-100" style="margin-top: 1em; text-align: center;"> <img src="/assets/img/author/azure-solutions-architect-expert.png" alt="Azure Solutions Architect Expert" width="200px" height="200px"></div><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <a href="https://github.com/wolfgangofner" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/channel/UCmiFK5vpvsi6j6gD7W_rsVQ" aria-label="Youtube" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Create a VPC Connection between Azure and Timescale</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Create a VPC Connection between Azure and Timescale</h1><div class="post-meta text-muted d-flex flex-column"><div> <span> Posted <em class="" data-ts="1660514400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 15, 2022 </em> </span> by <span class="author"> By <em> Wolfgang Ofner </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1691 words"> <em>19 min</em></span> read</div></div><div class="post-content"><p>This week, I was helping a customer of mine to migrate from an on-prem database to a cloud-hosted <a href="https://www.timescale.com" target="_blank" rel="noopener noreferrer">TimescaleDB</a>. Since the customer is using Azure, they wanted to host their new TimescaleDB in Azure. Timescale offers to host the database on Azure and also allows a private connection via VPC (virtual private cloud) peering. This allows customers to peer a VNet with the VNet of Timescale and therefore only allow traffic coming from this VNet. As a result, it is not possible to connect to the database over the internet.</p><p>Unfortunately, I had some problems creating the VPC peering, and therefore want to describe how I achieved it.</p><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There is an article about <a href="https://kb-managed.timescale.com/en/articles/5489252-setting-up-a-vpc-on-azure" target="_blank" rel="noopener noreferrer">Setting up a VPC on Azure</a> in the Timescale knowledge base. I only found this article after I emailed the support (which replied very fast). After trying to follow this guide, I realized that some commands were not working in the Azure CLI and also that the commands were more complicated than needed. With that, I mean that if a query returned a value, instead of writing this value into a variable, the guide stated to find the variable from the output and assign it to a variable by hand.</p><p>If you follow this guide, you will see what is not working on the official documentation and you also won’t need to assign any output values by hand. They will be assigned automatically.</p><h2 id="lets-get-started"><span class="mr-2">Let’s get started</span><a href="#lets-get-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This article assumes that you already have a TimescaleDB with VPC running in Azure. If not, log into your Timescale account and create a new VPC in the desired Azure region. Wait until the state of the VPC is active and then create a new database with the previously created VPC as its location. Note that you won’t be able to access this database until you finish the VPC peering.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-connection-to-the-TimescaleDb-was-refused.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-connection-to-the-TimescaleDb-was-refused.jpg" alt="The connection to the TimescaleDb was refused" data-proofer-ignore></a><p> The connection to the TimescaleDb was refused</p></div><p>All of the following guide will be done in the command line using <a href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-linux?view=powershell-7.2" target="_blank" rel="noopener noreferrer">PowerShell</a>, the <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Azure CLI</a> and <a href="https://github.com/aiven/aiven-client" target="_blank" rel="noopener noreferrer">Aiven CLI</a> on Ubuntu. It is possible to create a VPC peering in the Timescale portal, but this won’t work.</p><h2 id="create-an-application-in-your-aad"><span class="mr-2">Create an Application in your AAD</span><a href="#create-an-application-in-your-aad" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Log into your Azure account using the Azure CLI and set the subscription you want to use (this is only necessary if your account has multiple subscriptions).</p><script src="https://gist.github.com/WolfgangOfner/2fa99fa9667cf94db0bf68e56a825820.js"></script><p>Create an application in your AAD with the following command. You can use whatever display name you prefer.</p><script src="https://gist.github.com/WolfgangOfner/77214098bb4b6776be1ab4468dc91926.js"></script><p>This app uses the –sign-in-audience AzureADandPersonalMicrosoftAccount flag which will enable multiple tenants to log into this application. However, only your tenant has the credentials for the authentication.</p><p>Here I found the biggest problem with the official guide. This uses the –available-to-other-tenants flag, which to my knowledge does not exist and therefore won’t work. Make sure to use the –sign-in-audience flag instead.</p><h2 id="create-a-service-principal"><span class="mr-2">Create a Service Principal</span><a href="#create-a-service-principal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next, create a service principal for the previously created AAD application.</p><script src="https://gist.github.com/WolfgangOfner/4f5e7da7559fc1edfcefd0766a66da4b.js"></script><p>This service principal will be used later to peer your VNet with the VNet of Timescale.</p><h2 id="set-a-password-for-the-application"><span class="mr-2">Set a Password for the Application</span><a href="#set-a-password-for-the-application" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You will use the previously created AAD application to log into Azure. Therefore, you will need its password. You can retrieve the password by simply resetting the current one.</p><script src="https://gist.github.com/WolfgangOfner/c0a19601e3e3c46acbe7a4cb806b927c.js"></script><p>This command will give you a warning to be careful because the output contains credentials. You can ignore this warning since that’s exactly what we wanted to do.</p><h2 id="gather-information-about-your-vnet-resource-group-and-subscription"><span class="mr-2">Gather Information about your VNet, Resource Group, and Subscription</span><a href="#gather-information-about-your-vnet-resource-group-and-subscription" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This step assigns the id of your VNet, the resource group it is located in, your subscription id, and your tenant id into variables. Make sure to replace &lt;YOUR_PEERING_NAME&gt; with a name of your choosing and enter your VNet name in the first line of the following code:</p><script src="https://gist.github.com/WolfgangOfner/306e3aa8b00abce2137c0883222b116c.js"></script><h2 id="assign-the-network-contributor-role-to-the-service-principal"><span class="mr-2">Assign the Network Contributor Role to the Service Principal</span><a href="#assign-the-network-contributor-role-to-the-service-principal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The previously created service principal will be used to create the peering from your VNet to the Timescale VNet. Therefore, the service principal will need the Network Contributor Role. The following commands will query the id of this role and then assign it to the service principal.</p><script src="https://gist.github.com/WolfgangOfner/6a8a8f809f23393956c495fff534daf9.js"></script><p>The –scope flag limits the role assignment to the VNet resource.</p><h2 id="create-a-service-principal-for-the-timescaledb-application"><span class="mr-2">Create a Service Principal for the TimescaleDB application</span><a href="#create-a-service-principal-for-the-timescaledb-application" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The Timescale Tenant on Azure contains an application that can be used to create a peering from your Timescale VPC project to your VNet. To be able to do that, the Timescale AD application needs a service principal in your subscription. You can create this service principal with the following code.</p><script src="https://gist.github.com/WolfgangOfner/a2919558718462ea97f89592e4e7a3db.js"></script><p>Note that you need the “Application Administrator” permission to be able to execute the code above. If you do not have this permission, you will get the following error message:</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Insufficient-permissions-to-create-the-service-principal.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Insufficient-permissions-to-create-the-service-principal.jpg" alt="Insufficient permissions to create the service principal" data-proofer-ignore></a><p> Insufficient permissions to create the service principal</p></div><h2 id="create-a-custom-role-for-the-network-peering"><span class="mr-2">Create a Custom Role for the Network Peering</span><a href="#create-a-custom-role-for-the-network-peering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The Timescale application needs the “Microsoft.Network/virtualNetworks/peer/action” permission to create the network peering. Since you always want to give the least amount of permissions, it is recommended to create a custom role that contains only this permission. To make the creation of the role in the command line easier, save the following code into a JSON file. Replace &lt;YOUR_SUBSCRIPTION_ID&gt; with your actual subscription id and optionally, change the name of the role.</p><script src="https://gist.github.com/WolfgangOfner/6f70ecdab6f6420b288e1b7d88092fee.js"></script><p>Next, execute a role definition create and pass the JSON file as a parameter:</p><script src="https://gist.github.com/WolfgangOfner/d58c5052916e9ddbeec9a77bd6e19d16.js"></script><p>Lastly, assign this new custom role to the previously created Timescale service principal:</p><h2 id="create-an-access-token-for-the-aiven-cli"><span class="mr-2">Create an Access Token for the Aiven CLI</span><a href="#create-an-access-token-for-the-aiven-cli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Log into your account in the Timescale portal and select your account icon on the top right, switch to the Authentication tab, and then click on “Generate token”</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Generate-a-new-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Generate-a-new-access-token.jpg" alt="Generate a new access token" data-proofer-ignore></a><p> Generate a new access token</p></div><p>This opens a new window where you can enter a name for your access token and configure its expiration time.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Configure-the-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Configure-the-access-token.jpg" alt="Configure the access token" data-proofer-ignore></a><p> Configure the access token</p></div><p>After you clicked on generate token, the token is generated.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Copy-the-access-token.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Copy-the-access-token.jpg" alt="Copy the access token" data-proofer-ignore></a><p> Copy the access token</p></div><p>Make sure to copy the access token since this is the only time that you have access to the token.</p><p>Additionally, I would recommend you enable two-factor authentication in your account settings.</p><h3 id="install-the-aiven-cli"><span class="mr-2">Install the Aiven CLI</span><a href="#install-the-aiven-cli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The Aiven CLI installation needs Python (pip) to be installed on your system. To install it, use the following code:</p><script src="https://gist.github.com/WolfgangOfner/6bb003fa6b638cc7f14bc0faf5746153.js"></script><p>Next, install the Aiven CLI.</p><script src="https://gist.github.com/WolfgangOfner/fb0cb0e6b65bbfaba9d11bc7a5f44ced.js"></script><p>Use the Aiven CLI to log into your Timescale account. Make sure to change &lt;YOUR_USER&gt; with your Timescale user.</p><script src="https://gist.github.com/WolfgangOfner/c39add583c21c4fc9203751ac34a697d.js"></script><p>After you execute the login, pass your previously created access token.</p><h3 id="retrieve-the-vpc-project-id"><span class="mr-2">Retrieve the VPC Project ID</span><a href="#retrieve-the-vpc-project-id" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>works because only 1 VPC per region –&gt; replace timescale-azure-switzerland-north with your location if you are not using Switzerland North. The project ID is always 36 characters long, as far as I know</p><script src="https://gist.github.com/WolfgangOfner/d3efc30bc211516b1786feb2b3a0a43d.js"></script><h3 id="create-peering-connection"><span class="mr-2">Create Peering Connection</span><a href="#create-peering-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The VPC project id and some of the previously created variables are now needed to create a peering connection from the Timescale VNet into your VNet. Use the following code to create the connection:</p><script src="https://gist.github.com/WolfgangOfner/01290722a1d36ab342c56b37a4c0063f.js"></script><p>Note that the input variables starting with user_ must be lowercase since the Aiven API can only handle lower-case inputs.</p><h3 id="check-the-peering-status-and-assign-variables"><span class="mr-2">Check the Peering Status and Assign Variables</span><a href="#check-the-peering-status-and-assign-variables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Creating the peering connection might take some time but usually, it is only a couple of seconds. Before you proceed, make sure with the following command that the state of the connection is ACTIVE.</p><script src="https://gist.github.com/WolfgangOfner/58dbb968bf15286c3d8d6cd8b209e4c8.js"></script><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/Check-the-peering-state.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/Check-the-peering-state.jpg" alt="Check the peering state" data-proofer-ignore></a><p> Check the peering state</p></div><p>If the state is not ACTIVE, wait a bit and retry the command from above. If the state is INVALID_SPECIFICATION or REJECTED_BY_PEER, check that VNet you passed as a parameter exists and that the Timescale application was given the proper permissions. After you checked that, repeat the command from above and the peering connection should be created.</p><p>The output of this command is horrendous but you have to copy the value of to-tenant-id and to-network-id to the variables aiven_vnet_id and aiven_tenant_id. Make sure to replace the placeholder with your actual values.</p><script src="https://gist.github.com/WolfgangOfner/142c28ef0b178724c38bc6c8b9dcf2bc.js"></script><p>The tenant Id is a GuId and the VNet id should look something like “/subscriptions/&lt;SUBSCRIPTION_GUID}&gt;/resourceGroups/…</p><h3 id="create-the-vnet-peering-from-your-vnet-to-your-vpc"><span class="mr-2">Create the VNet peering from your VNet to your VPC</span><a href="#create-the-vnet-peering-from-your-vnet-to-your-vpc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Log out of the Azure CLI and then log in with your service principal into your tenant and also into the Timescale tenant.</p><script src="https://gist.github.com/WolfgangOfner/93553931e2fc885d48c51db8524701ef.js"></script><p>After you successfully logged into both tenants, create the VNet peering between your VNet and the Timescale VNet</p><script src="https://gist.github.com/WolfgangOfner/c9266da9c0da3cb38e5097866b4a9846.js"></script><p>You can check the state of your peering connection with the following command:</p><script src="https://gist.github.com/WolfgangOfner/6107313f6bf2a9852c2acb58dd7b736c.js"></script><p>Right after you created the peering connection, the state will be APPROVED and after a couple of seconds, it should switch to PENDING_PEER.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-peering-was-approved-and-is-pending.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-peering-was-approved-and-is-pending.jpg" alt="The peering was approved and is pending" data-proofer-ignore></a><p> The peering was approved and is pending</p></div><p>Wait a bit and the peering state should switch to ACTIVE</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-peering-is-active.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-peering-is-active.jpg" alt="The peering is active" data-proofer-ignore></a><p> The peering is active</p></div><p>If you follow the official documentation, note that the command to check the state is cut off and won’t work.</p><h2 id="test-the-connection"><span class="mr-2">Test the Connection</span><a href="#test-the-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the peering connection in place, test if you can log into your Timescale database. Make sure that you are connecting from within your peered VNet, otherwise, the connection won’t work.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2022/08/The-TimescaleDb-login-worked.jpg"><img loading="lazy" data-src="/assets/img/posts/2022/08/The-TimescaleDb-login-worked.jpg" alt="The TimescaleDb login worked" data-proofer-ignore></a><p> The TimescaleDb login worked</p></div><p>Note that I used pgAdmin to test the connection despite using Azure Data Studio at the beginning of this tutorial. The PostgreSQL extension of Azure Data Studio was constantly crashing and I could not get it working again.</p><h2 id="clean-up-your-resources"><span class="mr-2">Clean up your Resources</span><a href="#clean-up-your-resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you do not need your resources anymore, make sure to clean up everything you have created.</p><h3 id="delete-the-vnet-peering"><span class="mr-2">Delete the VNet Peering</span><a href="#delete-the-vnet-peering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, delete the VNet peering with the following command.</p><script src="https://gist.github.com/WolfgangOfner/983b1726eb27042a59ad768c2361d608.js"></script><h3 id="delete-both-role-bindings"><span class="mr-2">Delete both Role Bindings</span><a href="#delete-both-role-bindings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, retrieve the Ids of the role bindings and then delete both.</p><script src="https://gist.github.com/WolfgangOfner/e70699383e11e7a65f7a1ed229b4f283.js"></script><h3 id="delete-the-custom-role"><span class="mr-2">Delete the Custom Role</span><a href="#delete-the-custom-role" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After you deleted the role binding, delete the previously created custom role.</p><script src="https://gist.github.com/WolfgangOfner/d952ecd581fe79affb4878336a6183f9.js"></script><p>If you used a different name for the custom role, make sure to replace “VnetPeerCreator” with your name.</p><h3 id="delete-the-applications-from-your-aad"><span class="mr-2">Delete the Applications from your AAD</span><a href="#delete-the-applications-from-your-aad" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Lastly, delete both applications from your AAD.</p><script src="https://gist.github.com/WolfgangOfner/2fc3cb09031a926805f932fa342aaa6f.js"></script><p>Make sure that you have the “Application Administrator” permission to delete the app with the Aiven service principal.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This post showed how you can create a database on Timescale and how to create a private peering connection between your Azure subscription and the Timescale network. Setting up the VNet peering allows only connections from within your VNet to access the database. This approach enables you to let Timescale manage your database while it is not accessible over the internet and therefore should be quite secure.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloud/'>Cloud</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/postgresql/" class="post-tag no-text-decoration" >PostgreSQL</a> <a href="/tags/timescale/" class="post-tag no-text-decoration" >Timescale</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >Azure</a> <a href="/tags/vnet-peering/" class="post-tag no-text-decoration" >VNet peering</a> <a href="/tags/vnet/" class="post-tag no-text-decoration" >VNet</a> <a href="/tags/azure-cli/" class="post-tag no-text-decoration" >Azure CLI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&u=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Create+a+VPC+Connection+between+Azure+and+Timescale+-+Programming+With+Wolfgang&url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fcreate-vpc-connection-between-azure-and-timescale%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/microservice-series-from-zero-to-hero/"><div class="card-body"> <em class="small" data-ts="1610838000" data-df="ll" > Jan 17, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Microservice Series - From Zero to Hero</h3><div class="text-muted small"><p> I am working as a consultant and software architect on different projects that focus on microservices, DevOps, and Kubernetes. Many of my consulting jobs consist of explaining microservices, why th...</p></div></div></a></div><div class="card"> <a href="/how-to-pass-az-303-and-az-304-certification-exams/"><div class="card-body"> <em class="small" data-ts="1621807200" data-df="ll" > May 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to pass the AZ-303 and AZ-304 Certification Exams</h3><div class="text-muted small"><p> Two weeks ago, I passed the AZ-304 exam and today I passed the AZ-303 exam giving me the Azure Solutions Architect Expert certification. This post will give you an overview of the exams what metho...</p></div></div></a></div><div class="card"> <a href="/implement-aad-authentication-to-access-azure-sql-databases/"><div class="card-body"> <em class="small" data-ts="1635721200" data-df="ll" > Nov 1, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Implement AAD Authentication to access Azure SQL Databases</h3><div class="text-muted small"><p> Microsoft promotes going passwordless for a while now. Azure offers authentication against the Azure Active Directory where applications can acquire access tokens using their identity. Another use ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/introducing-gitops/" class="btn btn-outline-primary" prompt="Older"><p>Introducing GitOps</p></a> <a href="/manage-kubernetes-resources-with-kustomize/" class="btn btn-outline-primary" prompt="Newer"><p>Manage your Kubernetes Resources with Kustomize</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = '/create-vpc-connection-between-azure-and-timescale/'; this.page.identifier = '/create-vpc-connection-between-azure-and-timescale/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://programmingwithwolfgang.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/aks/">AKS</a> <a class="post-tag" href="/tags/helm/">Helm</a> <a class="post-tag" href="/tags/learning/">Learning</a> <a class="post-tag" href="/tags/yaml/">YAML</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); }); </script>
